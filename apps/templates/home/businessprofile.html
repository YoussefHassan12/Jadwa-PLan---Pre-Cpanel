{% extends "layouts/base.html" %}

{% block title %}
  {% if session.get('lang', 'en') == 'ar' %}الملف التعريفي للأعمال{% else %}Business Profile{% endif %}
{% endblock %}

{% block stylesheets %}
<style>
:root {
  --primary-gradient: linear-gradient(135deg, #4F7DF3 0%, #1A73E8 100%);
  --primary-color: #4F7DF3;
  --primary-dark: #1A73E8;
  --success-color: #10B981;
  --warning-color: #F59E0B;
  --danger-color: #EF4444;
  --info-color: #17c1e8;
  --surface-color: #F8FAFC;
  --border-color: #E2E8F0;
  --text-primary: #1E293B;
  --text-secondary: #64748B;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --radius-xl: 24px;
}
.profile-page-container { padding: 1.5rem; background: linear-gradient(180deg, #F0F4FF 0%, #FFFFFF 100%); min-height: 100vh; }
.progress-section { background: white; border-radius: var(--radius-lg); padding: 1.25rem 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow-md); }
.progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
.progress-label { font-size: 0.875rem; font-weight: 600; color: var(--text-primary); }
.progress-percentage { font-size: 1.25rem; font-weight: 700; color: var(--primary-color); }
.progress-bar-container { height: 10px; background: #E2E8F0; border-radius: 5px; overflow: hidden; }
.progress-bar-fill { height: 100%; border-radius: 5px; transition: width 0.5s ease; }
.progress-bar-fill.success { background: var(--success-color); }
.progress-bar-fill.info { background: var(--info-color); }
.progress-bar-fill.danger { background: var(--danger-color); }
.profile-card { background: white; border-radius: var(--radius-xl); box-shadow: var(--shadow-md); margin-bottom: 1.5rem; overflow: hidden; }
.profile-card:hover { box-shadow: var(--shadow-lg); }
.profile-card-header { background: var(--primary-gradient); padding: 1.25rem 1.5rem; position: relative; }
.profile-card-header::before { content: ''; position: absolute; top: -50%; right: -20%; width: 200px; height: 200px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; }
.profile-card-header h5 { color: white; font-size: 1.25rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 0.75rem; }
.profile-card-body { padding: 1.5rem; }
.section-title { font-size: 1rem; font-weight: 600; color: var(--primary-color); margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 2px solid rgba(79, 125, 243, 0.1); display: flex; align-items: center; gap: 0.5rem; }
.form-group-modern { margin-bottom: 1.25rem; }
.form-label-modern { display: block; font-size: 0.8125rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.025em; }
.form-control-modern { width: 100%; padding: 0.75rem 1rem; font-size: 0.9375rem; border: 1.5px solid var(--border-color); border-radius: var(--radius-md); background: white; color: var(--text-primary); transition: all 0.2s ease; box-sizing: border-box; }
.form-control-modern:hover { border-color: #CBD5E1; }
.form-control-modern:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 125, 243, 0.15); }
select.form-control-modern { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364748B' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 1rem center; padding-right: 2.5rem; cursor: pointer; }
html[dir="rtl"] select.form-control-modern { background-position: left 1rem center; padding-right: 1rem; padding-left: 2.5rem; }
.add-item-card { background: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 1.25rem; margin-bottom: 1rem; }
.add-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.add-item-title { font-size: 0.875rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; }
.add-item-title i { color: var(--primary-color); }
.btn-add-item { padding: 0.5rem 1rem; font-size: 0.8125rem; font-weight: 600; background: var(--primary-gradient); color: white; border: none; border-radius: var(--radius-md); cursor: pointer; display: flex; align-items: center; gap: 0.375rem; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(79, 125, 243, 0.3); }
.btn-add-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(79, 125, 243, 0.4); }
.add-item-fields { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
.data-table-container { background: white; border-radius: var(--radius-lg); border: 1px solid var(--border-color); overflow: hidden; }
.data-table-header { background: var(--surface-color); padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
.data-table-title { font-size: 0.9375rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; }
.data-table-title i { color: var(--primary-color); }
.data-table-count { background: var(--primary-color); color: white; font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0.625rem; border-radius: 20px; }
.data-table { width: 100%; margin: 0; border-collapse: collapse; }
.data-table thead { background: #F1F5F9; }
.data-table th { padding: 0.875rem 1rem; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); border: none; text-align: left; }
.data-table td { padding: 1rem; font-size: 0.875rem; color: var(--text-primary); border-bottom: 1px solid var(--border-color); vertical-align: middle; }
.data-table tbody tr { transition: all 0.2s ease; }
.data-table tbody tr:hover { background: rgba(79, 125, 243, 0.04); }
.data-table tbody tr:last-child td { border-bottom: none; }
html[dir="rtl"] .data-table th, html[dir="rtl"] .data-table td { text-align: right; }
.btn-delete-row { width: 32px; height: 32px; border-radius: var(--radius-sm); border: 1px solid #FECACA; background: #FEF2F2; color: var(--danger-color); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
.btn-delete-row:hover { background: var(--danger-color); border-color: var(--danger-color); color: white; transform: scale(1.1); }
.empty-table-state { padding: 3rem 1.5rem; text-align: center; }
.empty-table-icon { font-size: 48px; color: #CBD5E1; margin-bottom: 1rem; }
.empty-table-text { font-size: 0.9375rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
.empty-table-hint { font-size: 0.8125rem; color: #94A3B8; }
.toggle-section { display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: var(--surface-color); border-radius: var(--radius-lg); margin-bottom: 1rem; }
.toggle-switch-wrapper { flex-shrink: 0; padding-top: 0.25rem; }
.toggle-content { flex: 1; }
.toggle-label { font-size: 0.9375rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem; }
.toggle-hint { font-size: 0.8125rem; color: var(--text-secondary); }
.toggle-fields { margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--border-color); display: none; }
.toggle-fields.show { display: block; }
.custom-toggle { position: relative; width: 52px; height: 28px; }
.custom-toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #CBD5E1; transition: 0.3s; border-radius: 28px; }
.toggle-slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%; }
.custom-toggle input:checked + .toggle-slider { background: var(--primary-gradient); }
.custom-toggle input:checked + .toggle-slider:before { transform: translateX(24px); }
.badge-modern { padding: 0.375rem 0.75rem; font-size: 0.75rem; font-weight: 600; border-radius: 20px; display: inline-block; }
.badge-success { background: #D1FAE5; color: #065F46; }
.badge-info { background: #DBEAFE; color: #1E40AF; }
.badge-warning { background: #FEF3C7; color: #92400E; }
.badge-primary { background: rgba(79, 125, 243, 0.15); color: var(--primary-color); }
.form-actions { display: flex; justify-content: flex-end; gap: 1rem; padding: 1.5rem; background: var(--surface-color); border-top: 1px solid var(--border-color); border-radius: 0 0 var(--radius-xl) var(--radius-xl); align-items: center; }
.btn-modern { padding: 0.875rem 1.75rem; font-size: 0.9375rem; font-weight: 600; border-radius: var(--radius-md); cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s ease; border: none; }
.btn-primary-modern { background: var(--primary-gradient); color: white; box-shadow: 0 4px 14px rgba(79, 125, 243, 0.35); }
.btn-primary-modern:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(79, 125, 243, 0.45); }
.auto-save-status { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8125rem; color: var(--text-secondary); margin-right: auto; }
.auto-save-status.saving { color: var(--warning-color); }
.auto-save-status.saved { color: var(--success-color); }
.grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
.grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
.grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
@media (max-width: 992px) { .grid-4 { grid-template-columns: repeat(2, 1fr); } .grid-3 { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } .profile-page-container { padding: 1rem; } }
.toast-notification { position: fixed; bottom: 20px; right: 20px; z-index: 1060; background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); padding: 1rem 1.25rem; display: flex; align-items: center; gap: 0.75rem; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; }
.toast-notification.show { transform: translateY(0); opacity: 1; }
.toast-notification.success { border-left: 4px solid var(--success-color); }
.toast-notification.error { border-left: 4px solid var(--danger-color); }
.toast-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
.toast-icon.success { background: #D1FAE5; color: var(--success-color); }
.toast-icon.error { background: #FEE2E2; color: var(--danger-color); }
html[dir="rtl"] .toast-notification { right: auto; left: 20px; }
html[dir="rtl"] .toast-notification.success { border-left: none; border-right: 4px solid var(--success-color); }
html[dir="rtl"] .toast-notification.error { border-left: none; border-right: 4px solid var(--danger-color); }
.leave-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(4px); }
.leave-modal-overlay.show { display: flex; }
.leave-modal { background: white; border-radius: var(--radius-xl); padding: 2rem; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
.leave-modal-icon { width: 64px; height: 64px; background: #FEF3C7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.25rem; }
.leave-modal-icon i { font-size: 32px; color: var(--warning-color); }
.leave-modal-title { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin: 0 0 0.75rem; }
.leave-modal-message { font-size: 0.9375rem; color: var(--text-secondary); margin: 0 0 1.5rem; }
.leave-modal-actions { display: flex; gap: 0.75rem; justify-content: center; }
.btn-stay { padding: 0.75rem 1.5rem; background: var(--primary-gradient); color: white; border: none; border-radius: var(--radius-md); cursor: pointer; font-weight: 600; }
.btn-leave { padding: 0.75rem 1.5rem; background: white; color: var(--text-secondary); border: 1.5px solid var(--border-color); border-radius: var(--radius-md); cursor: pointer; font-weight: 600; }
.btn-leave:hover { border-color: var(--danger-color); color: var(--danger-color); }
.address-input-wrapper { position: relative; }
.address-input-wrapper .form-control-modern { padding-left: 2.5rem; }
html[dir="rtl"] .address-input-wrapper .form-control-modern { padding-left: 1rem; padding-right: 2.5rem; }
.address-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 20px; }
html[dir="rtl"] .address-icon { left: auto; right: 0.75rem; }
.other-input-container { display: none; margin-top: 0.5rem; }
.other-input-container.show { display: block; }
.multi-select-container { display: flex; flex-wrap: wrap; gap: 0.5rem; }
.multi-select-pill { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1.25rem; background: var(--surface-color); border: 1.5px solid var(--border-color); border-radius: 25px; font-size: 0.875rem; cursor: pointer; transition: all 0.2s ease; }
.multi-select-pill:hover { border-color: var(--primary-color); }
.multi-select-pill.active { background: var(--primary-gradient); border-color: transparent; color: white; }
.chart-container { background: var(--surface-color); border-radius: var(--radius-lg); padding: 1.5rem; margin-top: 1.5rem; }
.chart-title { font-size: 0.9375rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
.chart-title i { color: var(--primary-color); }
#financialChart { max-height: 300px; }
.editable-input { width: 100%; padding: 0.5rem; border: 1.5px solid transparent; border-radius: var(--radius-sm); background: transparent; font-size: 0.875rem; text-align: center; transition: all 0.2s ease; box-sizing: border-box; }
.editable-input:hover { background: var(--surface-color); border-color: var(--border-color); }
.editable-input:focus { outline: none; background: white; border-color: var(--primary-color); }
.editable-select { width: 100%; padding: 0.5rem; border: 1.5px solid transparent; border-radius: var(--radius-sm); background: transparent; font-size: 0.75rem; cursor: pointer; }
.editable-select:hover { background: var(--surface-color); border-color: var(--border-color); }
.contribution-progress { margin-top: 1rem; padding: 1rem; background: var(--surface-color); border-radius: var(--radius-md); }
.contribution-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
.contribution-label { font-size: 0.8125rem; font-weight: 600; color: var(--text-primary); }
.contribution-value { font-size: 1rem; font-weight: 700; }
.contribution-value.valid { color: var(--success-color); }
.contribution-value.invalid { color: var(--danger-color); }
.contribution-bar { height: 8px; background: #E2E8F0; border-radius: 4px; overflow: hidden; }
.contribution-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
.contribution-bar-fill.valid { background: var(--success-color); }
.contribution-bar-fill.invalid { background: var(--danger-color); }
.contribution-bar-fill.warning { background: var(--warning-color); }
.year-badge { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.75rem; background: var(--primary-gradient); color: white; border-radius: 20px; font-size: 0.8125rem; font-weight: 600; }
.growth-indicator { display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); }
.growth-indicator.positive { background: #D1FAE5; color: #065F46; }
.growth-indicator.negative { background: #FEE2E2; color: #991B1B; }
.growth-indicator.neutral { background: #F1F5F9; color: #64748B; }
.table-footer-totals { padding: 1rem 1.25rem; background: #F0FDF4; border-top: 1px solid var(--border-color); }
.total-row { display: flex; justify-content: space-between; align-items: center; }
.total-label { font-weight: 600; color: var(--text-primary); }
.total-value { font-size: 1.125rem; font-weight: 700; color: var(--success-color); }
.staff-count-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 24px; height: 24px; background: rgba(79, 125, 243, 0.15); color: var(--primary-color); border-radius: 12px; font-size: 0.75rem; font-weight: 600; padding: 0 0.5rem; }
html[dir="rtl"] .section-title, html[dir="rtl"] .add-item-title, html[dir="rtl"] .data-table-title, html[dir="rtl"] .toggle-section, html[dir="rtl"] .btn-modern, html[dir="rtl"] .chart-title { flex-direction: row-reverse; }
html[dir="rtl"] .form-actions { flex-direction: row-reverse; }
html[dir="rtl"] .auto-save-status { margin-right: 0; margin-left: auto; }



/* Form Actions */
.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
  padding: 1.5rem;
  background: var(--surface-color);
  border-top: 1px solid var(--border-color);
  border-radius: 0 0 var(--radius-xl) var(--radius-xl);
  align-items: center;
}

.btn-modern {
  padding: 0.875rem 1.75rem;
  font-size: 0.9375rem;
  font-weight: 600;
  border-radius: var(--radius-md);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s ease;
  border: none;
}

.btn-primary-modern {
  background: var(--primary-gradient);
  color: white;
  box-shadow: 0 4px 14px rgba(79, 125, 243, 0.35);
}

.btn-primary-modern:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(79, 125, 243, 0.45);
}

.btn-primary-modern:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.auto-save-status {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.8125rem;
  color: var(--text-secondary);
  margin-right: auto;
}

.auto-save-status i {
  font-size: 18px;
}

.auto-save-status.saving {
  color: var(--warning-color);
}

.auto-save-status.saving i {
  animation: spin 1s linear infinite;
}

.auto-save-status.saved {
  color: var(--success-color);
}

.auto-save-status.error {
  color: var(--danger-color);
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* RTL Support */
html[dir="rtl"] .form-actions {
  flex-direction: row-reverse;
}

html[dir="rtl"] .auto-save-status {
  margin-right: 0;
  margin-left: auto;
}

html[dir="rtl"] .btn-modern {
  flex-direction: row-reverse;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock stylesheets %}

{% block content %}
<div class="profile-page-container">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-xl-10 col-lg-11">

        <!-- Toast Notification -->
        <div class="toast-notification" id="toast-notification">
          <div class="toast-icon" id="toast-icon"><i class="material-icons" id="toast-icon-symbol">check</i></div>
          <span class="toast-message" id="toast-message"></span>
        </div>

        <!-- Leave Warning Modal -->
        <div class="leave-modal-overlay" id="leave-modal-overlay">
          <div class="leave-modal">
            <div class="leave-modal-icon"><i class="material-icons">warning</i></div>
            <h4 class="leave-modal-title">{% if session.get('lang', 'en') == 'ar' %}مغادرة الملف التعريفي؟{% else %}Leaving Business Profile?{% endif %}</h4>
            <p class="leave-modal-message">{% if session.get('lang', 'en') == 'ar' %}التغييرات قد لا يتم حفظها.{% else %}Changes may not be saved.{% endif %}</p>
            <div class="leave-modal-actions">
              <button type="button" class="btn-stay" id="btn-stay">{% if session.get('lang', 'en') == 'ar' %}البقاء{% else %}Stay{% endif %}</button>
              <button type="button" class="btn-leave" id="btn-leave">{% if session.get('lang', 'en') == 'ar' %}مغادرة{% else %}Leave{% endif %}</button>
            </div>
          </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-section">
          <div class="progress-header">
            <span class="progress-label">{% if session.get('lang', 'en') == 'ar' %}تقدم الملف{% else %}Profile Completion{% endif %}</span>
            <span class="progress-percentage">{{ data_comp[0].completion }}%</span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill {% if data_comp[0].completion == 100 %}success{% elif data_comp[0].completion >= 50 %}info{% else %}danger{% endif %}" style="width: {{ data_comp[0].completion }}%;"></div>
          </div>
        </div>

        <!-- Main Form -->
        <form id="business-profile-form" method="POST" action="/business_profile/{{ bplan_id }}">
          <input type="hidden" name="action" value="">

          <!-- BUSINESS INFORMATION CARD -->
          <div class="profile-card">
            <div class="profile-card-header">
              <h5><i class="material-icons">business</i>{% if session.get('lang', 'en') == 'ar' %}الملف التعريفي للأعمال{% else %}Business Profile{% endif %}</h5>
            </div>
            <div class="profile-card-body">
              <h6 class="section-title"><i class="material-icons">info</i>{% if session.get('lang', 'en') == 'ar' %}معلومات العمل{% else %}Business Information{% endif %}</h6>
              <div class="grid-3">
                <div class="form-group-modern">
                  <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}العنوان{% else %}Address{% endif %}</label>
                  <div class="address-input-wrapper">
                    <i class="material-icons address-icon">location_on</i>
                    <input class="form-control-modern" type="text" name="buz_address" id="buz_address" value="{{ data_bi[0].buz_address if data_bi[0].buz_address else '' }}" placeholder="{% if session.get('lang', 'en') == 'ar' %}أدخل العنوان{% else %}Enter address{% endif %}" onchange="markUnsaved()" autocomplete="off"/>
                  </div>
                </div>
                <div class="form-group-modern">
                  <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}تاريخ التأسيس{% else %}Establishment Date{% endif %}</label>
                  <input class="form-control-modern" type="date" name="buz_est_date" id="buz_est_date" value="{{ data_bi[0].buz_est_date.strftime('%Y-%m-%d') if data_bi[0].buz_est_date else '' }}" onchange="markUnsaved(); generateFinancialYears();"/>
                </div>
                <div class="form-group-modern">
                  <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}الوضع القانوني{% else %}Legal Status{% endif %}</label>
                  <select class="form-control-modern" name="choice_legal_status" onchange="markUnsaved()">
                    <option value="1" {% if data_bi[0].buz_legal_status == 1 %}selected{% endif %}>{% if session.get('lang', 'en') == 'ar' %}ملكية فردية{% else %}Sole Proprietorship{% endif %}</option>
                    <option value="2" {% if data_bi[0].buz_legal_status == 2 %}selected{% endif %}>{% if session.get('lang', 'en') == 'ar' %}شركة ذات مسؤولية محدودة{% else %}LLC{% endif %}</option>
                    <option value="3" {% if data_bi[0].buz_legal_status == 3 %}selected{% endif %}>{% if session.get('lang', 'en') == 'ar' %}شركة مساهمة{% else %}Joint Stock{% endif %}</option>
                    <option value="4" {% if data_bi[0].buz_legal_status == 4 %}selected{% endif %}>{% if session.get('lang', 'en') == 'ar' %}خارجية{% else %}Offshore{% endif %}</option>
                    <option value="5" {% if data_bi[0].buz_legal_status == 5 %}selected{% endif %}>{% if session.get('lang', 'en') == 'ar' %}مؤسسة اجتماعية{% else %}Social Enterprise{% endif %}</option>
                    <option value="6" {% if data_bi[0].buz_legal_status == 6 %}selected{% endif %}>{% if session.get('lang', 'en') == 'ar' %}غير ربحي{% else %}Non-Profit{% endif %}</option>
                    <option value="7" {% if data_bi[0].buz_legal_status == 7 %}selected{% endif %}>{% if session.get('lang', 'en') == 'ar' %}غير مسجل{% else %}Non-Registered{% endif %}</option>
                  </select>
                </div>
              </div>
              <div class="form-group-modern" style="margin-top: 0.5rem;">
                <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}نموذج العمل{% else %}Business Model{% endif %}</label>
                <div class="multi-select-container">
                  <label class="multi-select-pill {% if data_bi[0].buz_model and '1' in data_bi[0].buz_model %}active{% endif %}">
                    <input type="checkbox" name="choice_business_model" value="1" {% if data_bi[0].buz_model and '1' in data_bi[0].buz_model %}checked{% endif %} style="display:none;" onchange="markUnsaved()">
                    <i class="material-icons">person</i>B2C
                  </label>
                  <label class="multi-select-pill {% if data_bi[0].buz_model and '2' in data_bi[0].buz_model %}active{% endif %}">
                    <input type="checkbox" name="choice_business_model" value="2" {% if data_bi[0].buz_model and '2' in data_bi[0].buz_model %}checked{% endif %} style="display:none;" onchange="markUnsaved()">
                    <i class="material-icons">business</i>B2B
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- PRODUCTS & SERVICES CARD -->
          <div class="profile-card">
            <div class="profile-card-body">
              <h6 class="section-title"><i class="material-icons">inventory_2</i>{% if session.get('lang', 'en') == 'ar' %}المنتجات والخدمات{% else %}Products & Services{% endif %}</h6>
              <div class="add-item-card">
                <div class="add-item-header">
                  <span class="add-item-title"><i class="material-icons">add_circle</i>{% if session.get('lang', 'en') == 'ar' %}إضافة منتج/خدمة{% else %}Add Product/Service{% endif %}</span>
                  <button type="button" class="btn-add-item" id="btn-add-product-service"><i class="material-icons">add</i>{% if session.get('lang', 'en') == 'ar' %}إضافة{% else %}Add{% endif %}</button>
                </div>
                <div class="add-item-fields">
                  <div class="form-group-modern" style="margin-bottom: 0;">
                    <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}الاسم{% else %}Name{% endif %}</label>
                    <input class="form-control-modern" type="text" name="product_service_name" id="product_service_name" placeholder="{% if session.get('lang', 'en') == 'ar' %}أدخل الاسم{% else %}Enter name{% endif %}" autocomplete="off"/>
                  </div>
                  <div class="form-group-modern" style="margin-bottom: 0;">
                    <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}المميز{% else %}Differentiator{% endif %}</label>
                    <select class="form-control-modern" name="product_service_differentiator" id="product_service_differentiator" onchange="toggleOtherDifferentiator()">
                      <option value="">{% if session.get('lang', 'en') == 'ar' %}-- اختر --{% else %}-- Select --{% endif %}</option>
                      <option value="Price">{% if session.get('lang', 'en') == 'ar' %}السعر{% else %}Price{% endif %}</option>
                      <option value="Quality">{% if session.get('lang', 'en') == 'ar' %}الجودة{% else %}Quality{% endif %}</option>
                      <option value="Innovation">{% if session.get('lang', 'en') == 'ar' %}الابتكار{% else %}Innovation{% endif %}</option>
                      <option value="Customer Service">{% if session.get('lang', 'en') == 'ar' %}خدمة العملاء{% else %}Customer Service{% endif %}</option>
                      <option value="Speed">{% if session.get('lang', 'en') == 'ar' %}السرعة{% else %}Speed{% endif %}</option>
                      <option value="Customization">{% if session.get('lang', 'en') == 'ar' %}التخصيص{% else %}Customization{% endif %}</option>
                      <option value="Brand">{% if session.get('lang', 'en') == 'ar' %}العلامة التجارية{% else %}Brand{% endif %}</option>
                      <option value="Location">{% if session.get('lang', 'en') == 'ar' %}الموقع{% else %}Location{% endif %}</option>
                      <option value="Other">{% if session.get('lang', 'en') == 'ar' %}أخرى{% else %}Other{% endif %}</option>
                    </select>
                    <div class="other-input-container" id="other-differentiator-container">
                      <input class="form-control-modern" type="text" name="product_service_differentiator_other" id="product_service_differentiator_other" placeholder="{% if session.get('lang', 'en') == 'ar' %}حدد{% else %}Specify{% endif %}" autocomplete="off"/>
                    </div>
                  </div>
                </div>
              </div>
              <div class="data-table-container" id="products-services-table-container">
                <div class="data-table-header">
                  <span class="data-table-title"><i class="material-icons">list</i>{% if session.get('lang', 'en') == 'ar' %}القائمة{% else %}List{% endif %}</span>
                  <span class="data-table-count">{{ data_bps|length }}</span>
                </div>
                {% if data_bps and data_bps|length > 0 %}
                <table class="data-table">
                  <thead><tr><th>{% if session.get('lang', 'en') == 'ar' %}المنتج/الخدمة{% else %}Product/Service{% endif %}</th><th>{% if session.get('lang', 'en') == 'ar' %}المميز{% else %}Differentiator{% endif %}</th><th style="width:80px;text-align:center;">{% if session.get('lang', 'en') == 'ar' %}حذف{% else %}Delete{% endif %}</th></tr></thead>
                  <tbody id="products-services-tbody">
                    {% for row in data_bps %}
                    <tr><td><strong>{{ row.product_service_name }}</strong></td><td><span class="badge-modern badge-info">{{ row.product_service_description or 'N/A' }}</span></td><td style="text-align:center;"><button type="button" class="btn-delete-row delete-product-service-btn" data-item-id="{{ row.product_service_id }}"><i class="material-icons">delete</i></button></td></tr>
                    {% endfor %}
                  </tbody>
                </table>
                {% else %}
                <div class="empty-table-state"><i class="material-icons empty-table-icon">inventory_2</i><p class="empty-table-text">{% if session.get('lang', 'en') == 'ar' %}لا توجد منتجات{% else %}No products added{% endif %}</p></div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- STAFF CARD -->
          <div class="profile-card">
            <div class="profile-card-body">
              <h6 class="section-title"><i class="material-icons">groups</i>{% if session.get('lang', 'en') == 'ar' %}الموظفون{% else %}Staff{% endif %}</h6>
              <div class="add-item-card">
                <div class="add-item-header">
                  <span class="add-item-title"><i class="material-icons">person_add</i>{% if session.get('lang', 'en') == 'ar' %}إضافة موظف{% else %}Add Staff{% endif %}</span>
                  <button type="button" class="btn-add-item" id="btn-add-staff"><i class="material-icons">add</i>{% if session.get('lang', 'en') == 'ar' %}إضافة{% else %}Add{% endif %}</button>
                </div>
                <div class="add-item-fields">
                  <div class="form-group-modern" style="margin-bottom:0;"><label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}المنصب{% else %}Position{% endif %}</label><input class="form-control-modern" type="text" name="staff_position" id="staff_position" placeholder="{% if session.get('lang', 'en') == 'ar' %}مثال: مدير{% else %}e.g. Manager{% endif %}" autocomplete="off"/></div>
                  <div class="form-group-modern" style="margin-bottom:0;"><label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}عدد الموظفين{% else %}Number of Staff{% endif %}</label><input class="form-control-modern" type="number" name="number_of_staff" id="number_of_staff" value="1" min="1"/></div>
                  <div class="form-group-modern" style="margin-bottom:0;"><label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}نوع العمل{% else %}Work Time{% endif %}</label><select class="form-control-modern" name="choice_work_time" id="choice_work_time"><option value="Full time">{% if session.get('lang', 'en') == 'ar' %}دوام كامل{% else %}Full time{% endif %}</option><option value="Part time">{% if session.get('lang', 'en') == 'ar' %}دوام جزئي{% else %}Part time{% endif %}</option></select></div>
                  <div class="form-group-modern" style="margin-bottom:0;"><label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}الراتب الشهري (الإجمالي){% else %}Monthly Salary (Total){% endif %}</label><input class="form-control-modern" type="number" name="staff_salary" id="staff_salary" placeholder="{% if session.get('lang', 'en') == 'ar' %}الإجمالي{% else %}Total{% endif %}"/></div>
                </div>
              </div>
              <div class="data-table-container" id="staff-table-container">
                <div class="data-table-header"><span class="data-table-title"><i class="material-icons">badge</i>{% if session.get('lang', 'en') == 'ar' %}القائمة{% else %}Staff List{% endif %}</span><span class="data-table-count">{{ data_bs|length }}</span></div>
                {% if data_bs and data_bs|length > 0 %}
                <table class="data-table">
                  <thead><tr><th>{% if session.get('lang', 'en') == 'ar' %}المنصب{% else %}Position{% endif %}</th><th style="text-align:center;">{% if session.get('lang', 'en') == 'ar' %}العدد{% else %}Count{% endif %}</th><th>{% if session.get('lang', 'en') == 'ar' %}نوع العمل{% else %}Work Time{% endif %}</th><th style="text-align:right;">{% if session.get('lang', 'en') == 'ar' %}الراتب الشهري{% else %}Monthly{% endif %}</th><th style="text-align:right;">{% if session.get('lang', 'en') == 'ar' %}السنوي{% else %}Yearly{% endif %}</th><th style="width:80px;text-align:center;">{% if session.get('lang', 'en') == 'ar' %}حذف{% else %}Delete{% endif %}</th></tr></thead>
                  <tbody id="staff-tbody">
                    {% for row in data_bs %}
                    <tr><td><strong>{{ row.staff_position }}</strong></td><td style="text-align:center;"><span class="staff-count-badge">{{ row.number_of_staff or 1 }}</span></td><td><span class="badge-modern badge-{% if row.work_time == 'Full time' %}success{% else %}warning{% endif %}">{{ row.work_time }}</span></td><td style="text-align:right;">${{ "{:,.0f}".format(row.staff_salary or 0) }}</td><td style="text-align:right;"><strong>${{ "{:,.0f}".format(row.total_salary or 0) }}</strong></td><td style="text-align:center;"><button type="button" class="btn-delete-row delete-staff-btn" data-item-id="{{ row.staff_id }}"><i class="material-icons">delete</i></button></td></tr>
                    {% endfor %}
                  </tbody>
                </table>
                <div class="table-footer-totals"><div class="total-row"><span class="total-label">{% if session.get('lang', 'en') == 'ar' %}الإجمالي السنوي{% else %}Total Annual{% endif %}</span><span class="total-value">${{ "{:,.0f}".format(data_bs_total or 0) }}</span></div></div>
                {% else %}
                <div class="empty-table-state"><i class="material-icons empty-table-icon">groups</i><p class="empty-table-text">{% if session.get('lang', 'en') == 'ar' %}لا يوجد موظفون{% else %}No staff added{% endif %}</p></div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- RESOURCES CARD -->
          <div class="profile-card">
            <div class="profile-card-body">
              <h6 class="section-title"><i class="material-icons">account_balance</i>{% if session.get('lang', 'en') == 'ar' %}الموارد{% else %}Resources{% endif %}</h6>
              <div class="add-item-card">
                <div class="add-item-header">
                  <span class="add-item-title"><i class="material-icons">add_business</i>{% if session.get('lang', 'en') == 'ar' %}إضافة مورد{% else %}Add Resource{% endif %}</span>
                  <button type="button" class="btn-add-item" id="btn-add-resource"><i class="material-icons">add</i>{% if session.get('lang', 'en') == 'ar' %}إضافة{% else %}Add{% endif %}</button>
                </div>
                <div class="add-item-fields">
                  <div class="form-group-modern" style="margin-bottom:0;"><label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}النوع{% else %}Type{% endif %}</label><select class="form-control-modern" name="choice_type" id="choice_type" onchange="populateSubtype()"><option value="">{% if session.get('lang', 'en') == 'ar' %}-- اختر --{% else %}-- Select --{% endif %}</option><option value="Assets">{% if session.get('lang', 'en') == 'ar' %}الأصول{% else %}Assets{% endif %}</option><option value="Financial Resources">{% if session.get('lang', 'en') == 'ar' %}الموارد المالية{% else %}Financial Resources{% endif %}</option><option value="Intellectual Property">{% if session.get('lang', 'en') == 'ar' %}الملكية الفكرية{% else %}Intellectual Property{% endif %}</option><option value="Information Technology">{% if session.get('lang', 'en') == 'ar' %}تكنولوجيا المعلومات{% else %}Information Technology{% endif %}</option></select></div>
                  <div class="form-group-modern" style="margin-bottom:0;"><label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}النوع الفرعي{% else %}Subtype{% endif %}</label><select class="form-control-modern" name="choice_subtype" id="choice_subtype"><option value="">{% if session.get('lang', 'en') == 'ar' %}-- اختر النوع أولاً --{% else %}-- Select Type First --{% endif %}</option></select></div>
                  <div class="form-group-modern" style="margin-bottom:0;"><label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}القيمة{% else %}Value{% endif %}</label><input class="form-control-modern" type="number" name="resource_value" id="resource_value" placeholder="{% if session.get('lang', 'en') == 'ar' %}القيمة{% else %}Value{% endif %}"/></div>
                </div>
              </div>
              <div class="data-table-container" id="resources-table-container">
                <div class="data-table-header"><span class="data-table-title"><i class="material-icons">list_alt</i>{% if session.get('lang', 'en') == 'ar' %}القائمة{% else %}Resources List{% endif %}</span><span class="data-table-count">{{ data_br|length }}</span></div>
                {% if data_br and data_br|length > 0 %}
                <table class="data-table">
                  <thead><tr><th>{% if session.get('lang', 'en') == 'ar' %}النوع{% else %}Type{% endif %}</th><th>{% if session.get('lang', 'en') == 'ar' %}النوع الفرعي{% else %}Subtype{% endif %}</th><th style="text-align:right;">{% if session.get('lang', 'en') == 'ar' %}القيمة{% else %}Value{% endif %}</th><th style="width:80px;text-align:center;">{% if session.get('lang', 'en') == 'ar' %}حذف{% else %}Delete{% endif %}</th></tr></thead>
                  <tbody id="resources-tbody">
                    {% for row in data_br %}
                    <tr><td><span class="badge-modern badge-primary">{{ row.resource_type }}</span></td><td><strong>{{ row.resource_subtype }}</strong></td><td style="text-align:right;">${{ "{:,.0f}".format(row.resource_value or 0) }}</td><td style="text-align:center;"><button type="button" class="btn-delete-row delete-resource-btn" data-item-id="{{ row.resource_id }}"><i class="material-icons">delete</i></button></td></tr>
                    {% endfor %}
                  </tbody>
                </table>
                <div class="table-footer-totals"><div class="total-row"><span class="total-label">{% if session.get('lang', 'en') == 'ar' %}الإجمالي{% else %}Total{% endif %}</span><span class="total-value">${{ "{:,.0f}".format(data_br_total or 0) }}</span></div></div>
                {% else %}
                <div class="empty-table-state"><i class="material-icons empty-table-icon">account_balance</i><p class="empty-table-text">{% if session.get('lang', 'en') == 'ar' %}لا توجد موارد{% else %}No resources added{% endif %}</p></div>
                {% endif %}
              </div>
            </div>
          </div>

        <!-- FINANCIAL HISTORY CARD -->
        <div class="profile-card">
          <div class="profile-card-body">
            <h6 class="section-title"><i class="material-icons">trending_up</i>{% if session.get('lang', 'en') == 'ar' %}التاريخ المالي{% else %}Financial History{% endif %}</h6>

            <!-- Toggle -->
            <div class="toggle-section">
              <div class="toggle-switch-wrapper">
                <label class="custom-toggle">
                  <input type="checkbox" id="toggle_financial" onchange="toggleSection('financial')" {% if data_fin and data_fin|length > 0 %}checked{% endif %}>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="toggle-content">
                <div class="toggle-label">{% if session.get('lang', 'en') == 'ar' %}هل لديك تاريخ مالي؟{% else %}Do you have financial history?{% endif %}</div>
                <div class="toggle-hint">{% if session.get('lang', 'en') == 'ar' %}السنوات تُنشأ تلقائياً من تاريخ التأسيس{% else %}Years are auto-generated from establishment date{% endif %}</div>
              </div>
            </div>

            <!-- Financial History Fields -->
            <div class="toggle-fields {% if data_fin and data_fin|length > 0 %}show{% endif %}" id="financial-fields">

              <!-- Financial History Table -->
              <div class="data-table-container" id="financial-history-table-container">
                <div class="data-table-header">
                  <span class="data-table-title"><i class="material-icons">assessment</i>{% if session.get('lang', 'en') == 'ar' %}سجل التاريخ المالي{% else %}Financial History Records{% endif %}</span>
                  <span class="data-table-count">{{ data_fin|length }}</span>
                </div>
                {% if data_fin and data_fin|length > 0 %}
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>{% if session.get('lang', 'en') == 'ar' %}السنة{% else %}Year{% endif %}</th>
                      <th style="text-align:center;">{% if session.get('lang', 'en') == 'ar' %}المبيعات{% else %}Sales{% endif %}</th>
                      <th style="text-align:center;">{% if session.get('lang', 'en') == 'ar' %}الربح{% else %}Profit{% endif %}</th>
                      <th style="text-align:center;">{% if session.get('lang', 'en') == 'ar' %}النمو{% else %}Growth{% endif %}</th>
                      <th>{% if session.get('lang', 'en') == 'ar' %}السبب{% else %}Reason{% endif %}</th>
                    </tr>
                  </thead>
                  <tbody id="financial-history-tbody">
                    {% for row in data_fin %}
                    <tr data-financial-id="{{ row.financial_id }}" data-year="{{ row.financial_year }}" data-index="{{ loop.index0 }}">
                      <td><span class="year-badge"><i class="material-icons">calendar_today</i>{{ row.financial_year }}</span></td>
                      <td style="text-align:center;">
                        <input type="number" class="editable-input financial-sales"
                               data-financial-id="{{ row.financial_id }}"
                               value="{{ row.financial_sales or 0 }}"/>
                      </td>
                      <td style="text-align:center;">
                        <input type="number" class="editable-input financial-profit"
                               data-financial-id="{{ row.financial_id }}"
                               value="{{ row.financial_profit or 0 }}"/>
                      </td>
                      <td class="growth-cell" style="text-align:center;">
                        <span class="growth-indicator neutral">--</span>
                      </td>
                      <td>
                        <select class="editable-select growth-reason"
                                data-financial-id="{{ row.financial_id }}"
                                data-current-value="{{ row.growth_reason or '' }}">
                          <option value="">{% if session.get('lang', 'en') == 'ar' %}-- اختر --{% else %}-- Select --{% endif %}</option>
                        </select>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
                {% else %}
                <div class="empty-table-state">
                  <i class="material-icons empty-table-icon">trending_up</i>
                  <p class="empty-table-text">{% if session.get('lang', 'en') == 'ar' %}لا يوجد تاريخ مالي{% else %}No financial history{% endif %}</p>
                  <p class="empty-table-hint">{% if session.get('lang', 'en') == 'ar' %}حدد تاريخ التأسيس لإنشاء السنوات تلقائياً{% else %}Set establishment date to auto-generate years{% endif %}</p>
                </div>
                {% endif %}
              </div>

              <!-- Financial Chart -->
              <div class="chart-container" id="chart-container" style="{% if not data_fin or data_fin|length == 0 %}display:none;{% endif %}">
                <div class="chart-title"><i class="material-icons">bar_chart</i>{% if session.get('lang', 'en') == 'ar' %}الرسم البياني للأداء المالي{% else %}Financial Performance Chart{% endif %}</div>
                <canvas id="financialChart"></canvas>
              </div>

            </div>
          </div>
        </div>

        <!-- FUNDING SOURCES CARD -->
        <div class="profile-card">
          <div class="profile-card-body">
            <h6 class="section-title"><i class="material-icons">attach_money</i>{% if session.get('lang', 'en') == 'ar' %}مصادر التمويل{% else %}Funding Sources{% endif %}</h6>

            <!-- Toggle -->
            <div class="toggle-section">
              <div class="toggle-switch-wrapper">
                <label class="custom-toggle">
                  <input type="checkbox" id="toggle_funds" onchange="toggleSection('funds')" {% if data_bor and data_bor|length > 0 %}checked{% endif %}>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="toggle-content">
                <div class="toggle-label">{% if session.get('lang', 'en') == 'ar' %}هل لديك مصادر تمويل؟{% else %}Do you have funding sources?{% endif %}</div>
                <div class="toggle-hint">{% if session.get('lang', 'en') == 'ar' %}يجب أن يكون مجموع نسب المساهمة 100%{% else %}Total contribution must equal 100%{% endif %}</div>
              </div>
            </div>

            <!-- Funding Sources Fields -->
            <div class="toggle-fields {% if data_bor and data_bor|length > 0 %}show{% endif %}" id="funds-fields">

              <!-- Add Funding Source Form -->
              <div class="add-item-card">
                <div class="add-item-header">
                  <span class="add-item-title"><i class="material-icons">add_card</i>{% if session.get('lang', 'en') == 'ar' %}إضافة مصدر تمويل{% else %}Add Funding Source{% endif %}</span>
                  <button type="button" class="btn-add-item" id="btn-add-fund"><i class="material-icons">add</i>{% if session.get('lang', 'en') == 'ar' %}إضافة{% else %}Add{% endif %}</button>
                </div>
                <div class="add-item-fields">
                  <div class="form-group-modern" style="margin-bottom:0;">
                    <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}مصدر التمويل{% else %}Funding Source{% endif %}</label>
                    <select class="form-control-modern" name="choice_fund" id="choice_fund">
                      <option value="">{% if session.get('lang', 'en') == 'ar' %}-- اختر --{% else %}-- Select --{% endif %}</option>
                      <optgroup label="{% if session.get('lang', 'en') == 'ar' %}مصادر شخصية{% else %}Personal Sources{% endif %}">
                        <option value="Personal Savings">{% if session.get('lang', 'en') == 'ar' %}مدخرات شخصية{% else %}Personal Savings{% endif %}</option>
                        <option value="Family & Friends">{% if session.get('lang', 'en') == 'ar' %}العائلة والأصدقاء{% else %}Family & Friends{% endif %}</option>
                      </optgroup>
                      <optgroup label="{% if session.get('lang', 'en') == 'ar' %}استثمارات خارجية{% else %}External Investments{% endif %}">
                        <option value="Angel Investor">{% if session.get('lang', 'en') == 'ar' %}مستثمر ملاك{% else %}Angel Investor{% endif %}</option>
                        <option value="Venture Capital">{% if session.get('lang', 'en') == 'ar' %}رأس مال مخاطر{% else %}Venture Capital{% endif %}</option>
                        <option value="Private Equity">{% if session.get('lang', 'en') == 'ar' %}ملكية خاصة{% else %}Private Equity{% endif %}</option>
                        <option value="Crowdfunding">{% if session.get('lang', 'en') == 'ar' %}تمويل جماعي{% else %}Crowdfunding{% endif %}</option>
                      </optgroup>
                      <optgroup label="{% if session.get('lang', 'en') == 'ar' %}قروض{% else %}Loans{% endif %}">
                        <option value="Bank Loan">{% if session.get('lang', 'en') == 'ar' %}قرض بنكي{% else %}Bank Loan{% endif %}</option>
                        <option value="Microfinance">{% if session.get('lang', 'en') == 'ar' %}تمويل صغير{% else %}Microfinance{% endif %}</option>
                      </optgroup>
                      <optgroup label="{% if session.get('lang', 'en') == 'ar' %}منح ودعم{% else %}Grants & Support{% endif %}">
                        <option value="Government Grant">{% if session.get('lang', 'en') == 'ar' %}منحة حكومية{% else %}Government Grant{% endif %}</option>
                        <option value="NGO Grant">{% if session.get('lang', 'en') == 'ar' %}منحة منظمة غير ربحية{% else %}NGO Grant{% endif %}</option>
                        <option value="Incubator/Accelerator">{% if session.get('lang', 'en') == 'ar' %}حاضنة/مسرعة أعمال{% else %}Incubator/Accelerator{% endif %}</option>
                      </optgroup>
                    </select>
                  </div>
                  <div class="form-group-modern" style="margin-bottom:0;">
                    <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}نسبة المساهمة (%){% else %}Contribution (%){% endif %}</label>
                    <input class="form-control-modern" type="number" name="fund_contribution" id="fund_contribution" min="0" max="100" step="0.1" placeholder="{% if session.get('lang', 'en') == 'ar' %}مثال: 25{% else %}e.g. 25{% endif %}"/>
                  </div>
                </div>

                <!-- Contribution Progress Bar -->
                <div class="contribution-progress">
                  <div class="contribution-header">
                    <span class="contribution-label">{% if session.get('lang', 'en') == 'ar' %}إجمالي المساهمة{% else %}Total Contribution{% endif %}</span>
                    <span class="contribution-value" id="contribution-value">0%</span>
                  </div>
                  <div class="contribution-bar">
                    <div class="contribution-bar-fill" id="contribution-bar-fill" style="width: 0%;"></div>
                  </div>
                  <div class="contribution-message" id="contribution-message" style="margin-top: 0.5rem; font-size: 0.8125rem;"></div>
                </div>
              </div>

              <!-- Funding Sources Table -->
              <div class="data-table-container" id="funding-sources-table-container">
                <div class="data-table-header">
                  <span class="data-table-title"><i class="material-icons">account_balance_wallet</i>{% if session.get('lang', 'en') == 'ar' %}قائمة مصادر التمويل{% else %}Funding Sources List{% endif %}</span>
                  <span class="data-table-count">{{ data_bor|length }}</span>
                </div>
                {% if data_bor and data_bor|length > 0 %}
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>{% if session.get('lang', 'en') == 'ar' %}مصدر التمويل{% else %}Funding Source{% endif %}</th>
                      <th style="text-align:right;">{% if session.get('lang', 'en') == 'ar' %}نسبة المساهمة{% else %}Contribution{% endif %}</th>
                      <th style="width:80px;text-align:center;">{% if session.get('lang', 'en') == 'ar' %}حذف{% else %}Delete{% endif %}</th>
                    </tr>
                  </thead>
                  <tbody id="funding-sources-tbody">
                    {% for row in data_bor %}
                    <tr data-contribution="{{ row.contribution or 0 }}">
                      <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                          <i class="material-icons" style="color: var(--primary-color); font-size: 20px;">
                            {% if row.funds in ['Personal Savings', 'Family & Friends'] %}person{% elif row.funds in ['Bank Loan', 'Microfinance'] %}account_balance{% elif row.funds in ['Government Grant', 'NGO Grant', 'Incubator/Accelerator'] %}card_giftcard{% else %}trending_up{% endif %}
                          </i>
                          <strong>{{ row.funds }}</strong>
                        </div>
                      </td>
                      <td style="text-align:right;">
                        <span class="badge-modern badge-success">{{ row.contribution or 0 }}%</span>
                      </td>
                      <td style="text-align:center;">
                        <button type="button" class="btn-delete-row delete-fund-btn" data-item-id="{{ row.other_resource_id }}">
                          <i class="material-icons">delete</i>
                        </button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>

                <!-- Total Footer -->
                <div class="table-footer-totals" id="funding-total-footer">
                  <div class="total-row">
                    <span class="total-label">{% if session.get('lang', 'en') == 'ar' %}إجمالي المساهمة{% else %}Total Contribution{% endif %}</span>
                    <span class="total-value" id="total-contribution-display">0%</span>
                  </div>
                </div>
                {% else %}
                <div class="empty-table-state">
                  <i class="material-icons empty-table-icon">attach_money</i>
                  <p class="empty-table-text">{% if session.get('lang', 'en') == 'ar' %}لا توجد مصادر تمويل{% else %}No funding sources added{% endif %}</p>
                  <p class="empty-table-hint">{% if session.get('lang', 'en') == 'ar' %}أضف مصدر تمويلك الأول{% else %}Add your first funding source above{% endif %}</p>
                </div>
                {% endif %}
              </div>

            </div>
          </div>
        </div>

        <!-- FORM ACTIONS - Place this just before </form> -->
        <div class="profile-card">
          <div class="form-actions">
            <div class="auto-save-status" id="auto-save-status">
              <i class="material-icons">cloud_done</i>
              <span>{% if session.get('lang', 'en') == 'ar' %}تم الحفظ{% else %}Saved{% endif %}</span>
            </div>
            <button type="button" class="btn-modern btn-primary-modern" id="btn-save-continue">
              <i class="material-icons">check</i>
              {% if session.get('lang', 'en') == 'ar' %}حفظ ومتابعة{% else %}Save & Continue{% endif %}
            </button>
          </div>
        </div>

        </form>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block javascripts %}
<script>
// ============================================================================
// CONFIGURATION
// ============================================================================
const CONFIG = {
  bplanId: '{{ bplan_id }}',
  lang: '{{ session.get("lang", "en") }}',
  isArabic: '{{ session.get("lang", "en") }}' === 'ar'
};

let hasUnsavedChanges = false;
let isSaving = false;
let financialChart = null;

// Growth/Decline reason options
const GROWTH_REASONS = {
  growth: [
    { value: 'market_expansion', en: 'Market Expansion', ar: 'توسع السوق' },
    { value: 'new_products', en: 'New Products', ar: 'منتجات جديدة' },
    { value: 'price_increase', en: 'Price Increase', ar: 'زيادة الأسعار' },
    { value: 'marketing', en: 'Improved Marketing', ar: 'تحسين التسويق' },
    { value: 'efficiency', en: 'Operational Efficiency', ar: 'كفاءة تشغيلية' }
  ],
  decline: [
    { value: 'competition', en: 'Increased Competition', ar: 'زيادة المنافسة' },
    { value: 'economic', en: 'Economic Conditions', ar: 'ظروف اقتصادية' },
    { value: 'cost_increase', en: 'Cost Increase', ar: 'زيادة التكاليف' },
    { value: 'market_saturation', en: 'Market Saturation', ar: 'تشبع السوق' },
    { value: 'supply_issues', en: 'Supply Chain Issues', ar: 'مشاكل التوريد' }
  ]
};

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================
function markUnsaved() {
  hasUnsavedChanges = true;
  updateAutoSaveStatus('unsaved');
}

function markSaved() {
  hasUnsavedChanges = false;
  updateAutoSaveStatus('saved');
}

function updateAutoSaveStatus(status) {
  const el = document.getElementById('auto-save-status');
  if (!el) return;
  const icon = el.querySelector('i');
  const text = el.querySelector('span');
  el.classList.remove('saving', 'saved');

  if (status === 'saving') {
    el.classList.add('saving');
    icon.textContent = 'sync';
    text.textContent = CONFIG.isArabic ? 'جاري الحفظ...' : 'Saving...';
  } else if (status === 'saved') {
    el.classList.add('saved');
    icon.textContent = 'cloud_done';
    text.textContent = CONFIG.isArabic ? 'تم الحفظ' : 'Saved';
  } else {
    icon.textContent = 'cloud_off';
    text.textContent = CONFIG.isArabic ? 'غير محفوظ' : 'Unsaved';
  }
}

window.onbeforeunload = function(e) {
  if (hasUnsavedChanges) {
    e.preventDefault();
    e.returnValue = '';
  }
};

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast-notification');
  const icon = document.getElementById('toast-icon');
  const iconSymbol = document.getElementById('toast-icon-symbol');
  const messageEl = document.getElementById('toast-message');

  if (!toast) return;

  toast.classList.remove('success', 'error');
  icon.classList.remove('success', 'error');
  toast.classList.add(type);
  icon.classList.add(type);
  iconSymbol.textContent = type === 'success' ? 'check' : 'error';
  messageEl.textContent = message;
  toast.classList.add('show');

  setTimeout(() => { toast.classList.remove('show'); }, 3000);
}

function toggleSection(section) {
  const fields = document.getElementById(section + '-fields');
  const toggle = document.getElementById('toggle_' + section);
  if (toggle && fields) {
    if (toggle.checked) {
      fields.classList.add('show');
    } else {
      fields.classList.remove('show');
    }
  }
}

function toggleOtherDifferentiator() {
  const select = document.getElementById('product_service_differentiator');
  const container = document.getElementById('other-differentiator-container');
  if (select && container) {
    if (select.value === 'Other') {
      container.classList.add('show');
    } else {
      container.classList.remove('show');
    }
  }
}

// ============================================================================
// RESOURCE SUBTYPE POPULATION
// ============================================================================
function populateSubtype() {
  const typeSelect = document.getElementById('choice_type');
  const subtypeSelect = document.getElementById('choice_subtype');
  if (!typeSelect || !subtypeSelect) return;

  subtypeSelect.innerHTML = '';
  const type = typeSelect.value;

  if (!type) {
    subtypeSelect.innerHTML = '<option value="">' + (CONFIG.isArabic ? '-- اختر النوع أولاً --' : '-- Select Type First --') + '</option>';
    return;
  }

  let options = [];
  if (type === 'Assets') {
    options = [
      {value:'', label: CONFIG.isArabic ? '-- اختر --' : '-- Select --'},
      {value:'Land', label: CONFIG.isArabic ? 'أرض' : 'Land'},
      {value:'Building', label: CONFIG.isArabic ? 'مبنى' : 'Building'},
      {value:'Machinery', label: CONFIG.isArabic ? 'آلات' : 'Machinery'},
      {value:'Equipment', label: CONFIG.isArabic ? 'معدات' : 'Equipment'},
      {value:'Vehicles', label: CONFIG.isArabic ? 'مركبات' : 'Vehicles'},
      {value:'Inventory', label: CONFIG.isArabic ? 'مخزون' : 'Inventory'},
      {value:'Furniture', label: CONFIG.isArabic ? 'أثاث' : 'Furniture'}
    ];
  } else if (type === 'Financial Resources') {
    options = [
      {value:'', label: CONFIG.isArabic ? '-- اختر --' : '-- Select --'},
      {value:'Cash', label: CONFIG.isArabic ? 'نقد' : 'Cash'},
      {value:'Bank Account', label: CONFIG.isArabic ? 'حساب بنكي' : 'Bank Account'},
      {value:'Investment', label: CONFIG.isArabic ? 'استثمار' : 'Investment'}
    ];
  } else if (type === 'Intellectual Property') {
    options = [
      {value:'', label: CONFIG.isArabic ? '-- اختر --' : '-- Select --'},
      {value:'Patent', label: CONFIG.isArabic ? 'براءة اختراع' : 'Patent'},
      {value:'Trademark', label: CONFIG.isArabic ? 'علامة تجارية' : 'Trademark'},
      {value:'Copyright', label: CONFIG.isArabic ? 'حقوق نشر' : 'Copyright'},
      {value:'Trade Secret', label: CONFIG.isArabic ? 'سر تجاري' : 'Trade Secret'},
      {value:'License', label: CONFIG.isArabic ? 'ترخيص' : 'License'}
    ];
  } else if (type === 'Information Technology') {
    options = [
      {value:'', label: CONFIG.isArabic ? '-- اختر --' : '-- Select --'},
      {value:'Software', label: CONFIG.isArabic ? 'برمجيات' : 'Software'},
      {value:'Computers', label: CONFIG.isArabic ? 'حواسيب' : 'Computers'},
      {value:'Technology Infrastructure', label: CONFIG.isArabic ? 'بنية تحتية' : 'Tech Infrastructure'},
      {value:'Servers', label: CONFIG.isArabic ? 'خوادم' : 'Servers'}
    ];
  }

  options.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt.value;
    option.textContent = opt.label;
    subtypeSelect.appendChild(option);
  });
}

// ============================================================================
// FINANCIAL HISTORY - AUTO GENERATE YEARS FROM ESTABLISHMENT DATE
// ============================================================================
function generateFinancialYears() {
  const estDateInput = document.getElementById('buz_est_date');
  if (!estDateInput || !estDateInput.value) return;

  const estDate = new Date(estDateInput.value);
  const startYear = estDate.getFullYear();
  const currentYear = new Date().getFullYear();

  // Only generate if establishment date is in the past
  if (startYear >= currentYear) {
    showToast(CONFIG.isArabic ? 'تاريخ التأسيس يجب أن يكون في الماضي' : 'Establishment date must be in the past', 'error');
    return;
  }

  const formData = new FormData();
  formData.append('generate_financial_years', CONFIG.bplanId);
  formData.append('start_year', startYear);
  formData.append('end_year', currentYear - 1); // Up to last year (not current year)

  fetch(window.location.href, {
    method: 'POST',
    body: formData,
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(response => {
    if (response.ok) {
      showToast(CONFIG.isArabic ? 'تم إنشاء السنوات المالية' : 'Financial years generated');
      // Reload page to show new years
      window.location.reload();
    }
  })
  .catch(error => {
    console.error('Error generating years:', error);
  });
}

// ============================================================================
// FINANCIAL HISTORY - GROWTH CALCULATION & REASON DROPDOWN
// ============================================================================
function calculateGrowthAndUpdateReasons() {
  const rows = document.querySelectorAll('#financial-history-tbody tr[data-financial-id]');
  if (!rows || rows.length === 0) return;

  let previousSales = null;

  rows.forEach((row, index) => {
    const salesInput = row.querySelector('.financial-sales');
    const growthCell = row.querySelector('.growth-cell');
    const reasonSelect = row.querySelector('.growth-reason');

    if (!salesInput || !growthCell || !reasonSelect) return;

    const currentSales = parseFloat(salesInput.value) || 0;
    const currentValue = reasonSelect.dataset.currentValue || '';

    let growthType = 'neutral';
    let growthPercent = 0;

    if (index === 0 || previousSales === null || previousSales === 0) {
      growthCell.innerHTML = '<span class="growth-indicator neutral">--</span>';
      growthType = 'neutral';
    } else {
      growthPercent = ((currentSales - previousSales) / Math.abs(previousSales)) * 100;

      if (growthPercent > 0) {
        growthCell.innerHTML = '<span class="growth-indicator positive"><i class="material-icons" style="font-size:14px;">trending_up</i> +' + growthPercent.toFixed(1) + '%</span>';
        growthType = 'growth';
      } else if (growthPercent < 0) {
        growthCell.innerHTML = '<span class="growth-indicator negative"><i class="material-icons" style="font-size:14px;">trending_down</i> ' + growthPercent.toFixed(1) + '%</span>';
        growthType = 'decline';
      } else {
        growthCell.innerHTML = '<span class="growth-indicator neutral">0%</span>';
        growthType = 'neutral';
      }
    }

    // Update dropdown options based on growth type
    updateReasonDropdown(reasonSelect, growthType, currentValue);

    previousSales = currentSales;
  });
}

function updateReasonDropdown(selectElement, growthType, currentValue) {
  if (!selectElement) return;

  // Clear existing options
  selectElement.innerHTML = '<option value="">' + (CONFIG.isArabic ? '-- اختر --' : '-- Select --') + '</option>';

  let reasons = [];

  if (growthType === 'growth') {
    reasons = GROWTH_REASONS.growth;
  } else if (growthType === 'decline') {
    reasons = GROWTH_REASONS.decline;
  } else {
    // For neutral (first year or 0% change), show all options
    reasons = [...GROWTH_REASONS.growth, ...GROWTH_REASONS.decline];
  }

  reasons.forEach(reason => {
    const option = document.createElement('option');
    option.value = reason.value;
    option.textContent = CONFIG.isArabic ? reason.ar : reason.en;
    if (reason.value === currentValue) option.selected = true;
    selectElement.appendChild(option);
  });
}

// ============================================================================
// FINANCIAL CHART - LINE CHART
// ============================================================================
function initFinancialChart() {
  const ctx = document.getElementById('financialChart');
  const chartContainer = document.getElementById('chart-container');

  if (!ctx) return;

  const rows = document.querySelectorAll('#financial-history-tbody tr[data-financial-id]');

  if (!rows || rows.length === 0) {
    if (chartContainer) chartContainer.style.display = 'none';
    return;
  }

  if (chartContainer) chartContainer.style.display = 'block';

  const years = [];
  const sales = [];
  const profits = [];

  rows.forEach(row => {
    years.push(row.dataset.year);
    const salesInput = row.querySelector('.financial-sales');
    const profitInput = row.querySelector('.financial-profit');
    sales.push(parseFloat(salesInput?.value) || 0);
    profits.push(parseFloat(profitInput?.value) || 0);
  });

  // Destroy existing chart
  if (financialChart) {
    financialChart.destroy();
    financialChart = null;
  }

  financialChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: years,
      datasets: [
        {
          label: CONFIG.isArabic ? 'المبيعات' : 'Sales',
          data: sales,
          borderColor: 'rgba(79, 125, 243, 1)',
          backgroundColor: 'rgba(79, 125, 243, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: 'rgba(79, 125, 243, 1)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 6,
          pointHoverRadius: 8
        },
        {
          label: CONFIG.isArabic ? 'الربح' : 'Profit',
          data: profits,
          borderColor: 'rgba(16, 185, 129, 1)',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: 'rgba(16, 185, 129, 1)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 6,
          pointHoverRadius: 8
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      plugins: {
        legend: {
          position: 'top',
          labels: {
            usePointStyle: true,
            padding: 20
          }
        },
        tooltip: {
          backgroundColor: 'rgba(255, 255, 255, 0.95)',
          titleColor: '#1E293B',
          bodyColor: '#64748B',
          borderColor: '#E2E8F0',
          borderWidth: 1,
          padding: 12,
          boxPadding: 6,
          usePointStyle: true,
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          },
          ticks: {
            callback: function(value) {
              return '$' + value.toLocaleString();
            }
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      }
    }
  });
}

// ============================================================================
// SAVE FINANCIAL RECORD
// ============================================================================
function saveFinancialRecord(financialId, sales, profit, reason) {
  const formData = new FormData();
  formData.append('financial_update', financialId);
  formData.append('financial_sales', sales || 0);
  formData.append('financial_profit', profit || 0);
  formData.append('growth_reason', reason || '');

  fetch(window.location.href, {
    method: 'POST',
    body: formData,
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(response => {
    if (response.ok) {
      console.log('✅ Financial record saved:', financialId);
      showToast(CONFIG.isArabic ? 'تم الحفظ' : 'Saved');
    } else {
      console.error('❌ Failed to save financial record');
      showToast(CONFIG.isArabic ? 'فشل الحفظ' : 'Save failed', 'error');
    }
  })
  .catch(error => {
    console.error('❌ Error saving financial record:', error);
    showToast(CONFIG.isArabic ? 'خطأ' : 'Error', 'error');
  });
}

// ============================================================================
// ATTACH FINANCIAL LISTENERS
// ============================================================================
function attachFinancialListeners() {
  // Sales inputs
  document.querySelectorAll('.financial-sales').forEach(input => {
    input.addEventListener('change', function() {
      const row = this.closest('tr');
      const financialId = this.dataset.financialId;
      const profitInput = row.querySelector('.financial-profit');
      const reasonSelect = row.querySelector('.growth-reason');

      // Recalculate growth for all rows
      calculateGrowthAndUpdateReasons();

      // Update chart
      initFinancialChart();

      // Save to database
      saveFinancialRecord(financialId, this.value, profitInput.value, reasonSelect.value);
    });
  });

  // Profit inputs
  document.querySelectorAll('.financial-profit').forEach(input => {
    input.addEventListener('change', function() {
      const row = this.closest('tr');
      const financialId = this.dataset.financialId;
      const salesInput = row.querySelector('.financial-sales');
      const reasonSelect = row.querySelector('.growth-reason');

      // Update chart
      initFinancialChart();

      // Save to database
      saveFinancialRecord(financialId, salesInput.value, this.value, reasonSelect.value);
    });
  });

  // Reason selects
  document.querySelectorAll('.growth-reason').forEach(select => {
    select.addEventListener('change', function() {
      const row = this.closest('tr');
      const financialId = this.dataset.financialId;
      const salesInput = row.querySelector('.financial-sales');
      const profitInput = row.querySelector('.financial-profit');

      // Update current value for tracking
      this.dataset.currentValue = this.value;

      // Save to database
      saveFinancialRecord(financialId, salesInput.value, profitInput.value, this.value);
    });
  });
}

// ============================================================================
// CONTRIBUTION TRACKING (FUNDING SOURCES) - 100% VALIDATION
// ============================================================================
function updateContributionProgress() {
  const rows = document.querySelectorAll('#funding-sources-tbody tr[data-contribution]');
  let total = 0;

  rows.forEach(row => {
    total += parseFloat(row.dataset.contribution) || 0;
  });

  const valueEl = document.getElementById('contribution-value');
  const barFill = document.getElementById('contribution-bar-fill');
  const messageEl = document.getElementById('contribution-message');
  const totalDisplay = document.getElementById('total-contribution-display');

  // Update progress bar
  if (valueEl) valueEl.textContent = total.toFixed(1) + '%';
  if (totalDisplay) totalDisplay.textContent = total.toFixed(1) + '%';
  if (barFill) barFill.style.width = Math.min(total, 100) + '%';

  // Remove all classes
  if (valueEl) valueEl.classList.remove('valid', 'invalid');
  if (totalDisplay) totalDisplay.classList.remove('valid', 'invalid', 'warning');
  if (barFill) barFill.classList.remove('valid', 'invalid', 'warning');

  // Update styling and message based on total
  if (total === 100) {
    // Perfect - exactly 100%
    if (valueEl) valueEl.classList.add('valid');
    if (totalDisplay) {
      totalDisplay.classList.add('valid');
      totalDisplay.style.color = 'var(--success-color)';
    }
    if (barFill) barFill.classList.add('valid');
    if (messageEl) {
      messageEl.innerHTML = '<span style="color: var(--success-color);"><i class="material-icons" style="font-size:16px;vertical-align:middle;">check_circle</i> ' + (CONFIG.isArabic ? 'مثالي! المجموع 100%' : 'Perfect! Total is 100%') + '</span>';
    }
  } else if (total > 100) {
    // Over 100% - error
    if (valueEl) valueEl.classList.add('invalid');
    if (totalDisplay) {
      totalDisplay.classList.add('invalid');
      totalDisplay.style.color = 'var(--danger-color)';
    }
    if (barFill) barFill.classList.add('invalid');
    if (messageEl) {
      const excess = (total - 100).toFixed(1);
      messageEl.innerHTML = '<span style="color: var(--danger-color);"><i class="material-icons" style="font-size:16px;vertical-align:middle;">error</i> ' + (CONFIG.isArabic ? 'تجاوز بـ ' + excess + '% - يرجى التعديل' : 'Exceeds by ' + excess + '% - please adjust') + '</span>';
    }
  } else {
    // Under 100% - warning
    if (valueEl) valueEl.classList.add('invalid');
    if (totalDisplay) {
      totalDisplay.classList.add('warning');
      totalDisplay.style.color = 'var(--warning-color)';
    }
    if (barFill) barFill.classList.add('warning');
    if (messageEl) {
      const remaining = (100 - total).toFixed(1);
      messageEl.innerHTML = '<span style="color: var(--warning-color);"><i class="material-icons" style="font-size:16px;vertical-align:middle;">info</i> ' + (CONFIG.isArabic ? 'المتبقي: ' + remaining + '%' : 'Remaining: ' + remaining + '%') + '</span>';
    }
  }

  return total;
}

function validateContribution(newContribution) {
  const currentTotal = updateContributionProgress();
  const newTotal = currentTotal + parseFloat(newContribution || 0);

  if (newTotal > 100) {
    const remaining = (100 - currentTotal).toFixed(1);
    showToast(
      CONFIG.isArabic
        ? 'لا يمكن أن يتجاوز المجموع 100%. المتبقي: ' + remaining + '%'
        : 'Total cannot exceed 100%. Remaining: ' + remaining + '%',
      'error'
    );
    return false;
  }
  return true;
}

async function addFund() {
  const fund = document.getElementById('choice_fund')?.value;
  const contribution = document.getElementById('fund_contribution')?.value;

  if (!fund) {
    showToast(CONFIG.isArabic ? 'يرجى اختيار مصدر التمويل' : 'Please select funding source', 'error');
    return;
  }

  if (!contribution || parseFloat(contribution) <= 0) {
    showToast(CONFIG.isArabic ? 'يرجى إدخال نسبة مساهمة صحيحة' : 'Please enter valid contribution percentage', 'error');
    return;
  }

  if (parseFloat(contribution) > 100) {
    showToast(CONFIG.isArabic ? 'النسبة لا يمكن أن تتجاوز 100%' : 'Percentage cannot exceed 100%', 'error');
    return;
  }

  // Validate that adding this won't exceed 100%
  if (!validateContribution(contribution)) {
    return;
  }

  if (hasUnsavedChanges) {
    await saveBusinessInfoSilently();
  }

  const formData = new FormData();
  formData.append('fund_add', CONFIG.bplanId);
  formData.append('choice_fund', fund);
  formData.append('fund_contribution', contribution);

  try {
    const response = await fetch(window.location.href, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });

    if (response.ok) {
      showToast(CONFIG.isArabic ? 'تمت الإضافة' : 'Added successfully');
      document.getElementById('choice_fund').value = '';
      document.getElementById('fund_contribution').value = '';
      markSaved();
      await refreshTable('funding-sources-table-container');
    }
  } catch (error) {
    console.error('Error:', error);
    window.location.reload();
  }
}

// ============================================================================
// AJAX TABLE REFRESH
// ============================================================================
async function refreshTable(tableId) {
  try {
    const response = await fetch(window.location.href, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Cache-Control': 'no-cache'
      }
    });

    if (!response.ok) {
      window.location.reload();
      return;
    }

    const html = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const newContainer = doc.querySelector('#' + tableId);

    if (newContainer) {
      document.querySelector('#' + tableId).innerHTML = newContainer.innerHTML;
      attachDeleteListeners();

      if (tableId === 'financial-history-table-container') {
        attachFinancialListeners();
        calculateGrowthAndUpdateReasons();
        initFinancialChart();
      }

      if (tableId === 'funding-sources-table-container') {
        updateContributionProgress();
      }
    }
  } catch (error) {
    console.error('Error refreshing table:', error);
    window.location.reload();
  }
}

// ============================================================================
// SAVE BUSINESS INFO SILENTLY
// ============================================================================
async function saveBusinessInfoSilently() {
  const form = document.getElementById('business-profile-form');
  if (!form) return false;

  const formData = new FormData(form);

  // Remove table-specific fields
  const fieldsToRemove = [
    'product_service_name', 'product_service_differentiator', 'product_service_differentiator_other',
    'staff_position', 'number_of_staff', 'choice_work_time', 'staff_salary',
    'choice_type', 'choice_subtype', 'resource_value',
    'choice_fund', 'fund_contribution'
  ];
  fieldsToRemove.forEach(field => formData.delete(field));

  formData.append('silent_save', 'true');

  try {
    const response = await fetch(window.location.href, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });

    if (response.ok) {
      console.log('✅ Business info saved silently');
      return true;
    }
  } catch (error) {
    console.error('❌ Error saving business info:', error);
  }
  return false;
}

// ============================================================================
// ADD OPERATIONS
// ============================================================================
async function addProductService() {
  const nameInput = document.getElementById('product_service_name');
  const diffSelect = document.getElementById('product_service_differentiator');
  const diffOther = document.getElementById('product_service_differentiator_other');

  const name = nameInput?.value;
  let differentiator = diffSelect?.value;

  if (differentiator === 'Other') {
    differentiator = diffOther?.value;
  }

  if (!name) {
    showToast(CONFIG.isArabic ? 'يرجى إدخال اسم المنتج/الخدمة' : 'Please enter product/service name', 'error');
    return;
  }

  if (hasUnsavedChanges) {
    await saveBusinessInfoSilently();
  }

  const formData = new FormData();
  formData.append('product_service_add', CONFIG.bplanId);
  formData.append('product_service_name', name);
  formData.append('product_service_description', differentiator || '');

  try {
    const response = await fetch(window.location.href, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });

    if (response.ok) {
      showToast(CONFIG.isArabic ? 'تمت الإضافة' : 'Added successfully');
      nameInput.value = '';
      diffSelect.value = '';
      if (diffOther) diffOther.value = '';
      document.getElementById('other-differentiator-container')?.classList.remove('show');
      markSaved();
      await refreshTable('products-services-table-container');
    }
  } catch (error) {
    console.error('Error:', error);
    window.location.reload();
  }
}

async function addStaff() {
  const position = document.getElementById('staff_position')?.value;
  const numberOfStaff = document.getElementById('number_of_staff')?.value;
  const workTime = document.getElementById('choice_work_time')?.value;
  const salary = document.getElementById('staff_salary')?.value;

  if (!position) {
    showToast(CONFIG.isArabic ? 'يرجى إدخال المنصب' : 'Please enter position', 'error');
    return;
  }

  if (hasUnsavedChanges) {
    await saveBusinessInfoSilently();
  }

  const formData = new FormData();
  formData.append('staff_add', CONFIG.bplanId);
  formData.append('staff_position', position);
  formData.append('number_of_staff', numberOfStaff || 1);
  formData.append('choice_work_time', workTime || 'Full time');
  formData.append('staff_salary', salary || 0);

  try {
    const response = await fetch(window.location.href, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });

    if (response.ok) {
      showToast(CONFIG.isArabic ? 'تمت الإضافة' : 'Added successfully');
      document.getElementById('staff_position').value = '';
      document.getElementById('number_of_staff').value = '1';
      document.getElementById('staff_salary').value = '';
      markSaved();
      await refreshTable('staff-table-container');
    }
  } catch (error) {
    console.error('Error:', error);
    window.location.reload();
  }
}

async function addResource() {
  const type = document.getElementById('choice_type')?.value;
  const subtype = document.getElementById('choice_subtype')?.value;
  const value = document.getElementById('resource_value')?.value;

  if (!type) {
    showToast(CONFIG.isArabic ? 'يرجى اختيار النوع' : 'Please select type', 'error');
    return;
  }

  if (!subtype) {
    showToast(CONFIG.isArabic ? 'يرجى اختيار النوع الفرعي' : 'Please select subtype', 'error');
    return;
  }

  if (hasUnsavedChanges) {
    await saveBusinessInfoSilently();
  }

  const formData = new FormData();
  formData.append('resource_add', CONFIG.bplanId);
  formData.append('choice_type', type);
  formData.append('choice_subtype', subtype);
  formData.append('resource_value', value || 0);

  try {
    const response = await fetch(window.location.href, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });

    if (response.ok) {
      showToast(CONFIG.isArabic ? 'تمت الإضافة' : 'Added successfully');
      document.getElementById('choice_type').value = '';
      document.getElementById('choice_subtype').innerHTML = '<option value="">' + (CONFIG.isArabic ? '-- اختر النوع أولاً --' : '-- Select Type First --') + '</option>';
      document.getElementById('resource_value').value = '';
      markSaved();
      await refreshTable('resources-table-container');
    }
  } catch (error) {
    console.error('Error:', error);
    window.location.reload();
  }
}

async function addFund() {
  const fund = document.getElementById('choice_fund')?.value;
  const contribution = document.getElementById('fund_contribution')?.value;

  if (!fund) {
    showToast(CONFIG.isArabic ? 'يرجى اختيار مصدر التمويل' : 'Please select funding source', 'error');
    return;
  }

  if (!contribution || contribution <= 0) {
    showToast(CONFIG.isArabic ? 'يرجى إدخال نسبة مساهمة صحيحة' : 'Please enter valid contribution percentage', 'error');
    return;
  }

  if (!validateContribution(contribution)) {
    return;
  }

  if (hasUnsavedChanges) {
    await saveBusinessInfoSilently();
  }

  const formData = new FormData();
  formData.append('fund_add', CONFIG.bplanId);
  formData.append('choice_fund', fund);
  formData.append('fund_contribution', contribution);

  try {
    const response = await fetch(window.location.href, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });

    if (response.ok) {
      showToast(CONFIG.isArabic ? 'تمت الإضافة' : 'Added successfully');
      document.getElementById('choice_fund').value = '';
      document.getElementById('fund_contribution').value = '';
      markSaved();
      await refreshTable('funding-sources-table-container');
    }
  } catch (error) {
    console.error('Error:', error);
    window.location.reload();
  }
}

// ============================================================================
// DELETE OPERATIONS
// ============================================================================
async function deleteItem(type, itemId) {
  const confirmMsg = CONFIG.isArabic ? 'هل أنت متأكد من الحذف؟' : 'Are you sure you want to delete?';
  if (!confirm(confirmMsg)) return;

  const formData = new FormData();
  formData.append(type + '_delete', itemId);

  try {
    const response = await fetch(window.location.href, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });

    if (response.ok) {
      showToast(CONFIG.isArabic ? 'تم الحذف' : 'Deleted successfully');

      const tableMap = {
        'product_service': 'products-services-table-container',
        'staff': 'staff-table-container',
        'resource': 'resources-table-container',
        'financial': 'financial-history-table-container',
        'fund': 'funding-sources-table-container'
      };

      await refreshTable(tableMap[type]);
    }
  } catch (error) {
    console.error('Error:', error);
    window.location.reload();
  }
}

function attachDeleteListeners() {
  document.querySelectorAll('.delete-product-service-btn').forEach(btn => {
    btn.onclick = () => deleteItem('product_service', btn.dataset.itemId);
  });

  document.querySelectorAll('.delete-staff-btn').forEach(btn => {
    btn.onclick = () => deleteItem('staff', btn.dataset.itemId);
  });

  document.querySelectorAll('.delete-resource-btn').forEach(btn => {
    btn.onclick = () => deleteItem('resource', btn.dataset.itemId);
  });

  document.querySelectorAll('.delete-financial-btn').forEach(btn => {
    btn.onclick = () => deleteItem('financial', btn.dataset.itemId);
  });

  document.querySelectorAll('.delete-fund-btn').forEach(btn => {
    btn.onclick = () => deleteItem('fund', btn.dataset.itemId);
  });
}

// ============================================================================
// SAVE & CONTINUE
// ============================================================================
async function saveAndContinue() {
  if (isSaving) return;
  isSaving = true;

  window.onbeforeunload = null;
  updateAutoSaveStatus('saving');

  const form = document.getElementById('business-profile-form');
  const formData = new FormData(form);
  formData.set('action', 'save');

  try {
    const response = await fetch(window.location.href, {
      method: 'POST',
      body: formData
    });

    if (response.redirected) {
      window.location.href = response.url;
    } else if (response.ok) {
      markSaved();
      showToast(CONFIG.isArabic ? 'تم الحفظ بنجاح' : 'Saved successfully');
      window.location.href = '/business_premises/' + CONFIG.bplanId;
    }
  } catch (error) {
    console.error('Error:', error);
    showToast(CONFIG.isArabic ? 'حدث خطأ' : 'Error occurred', 'error');
    window.onbeforeunload = function(e) {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
      }
    };
  } finally {
    isSaving = false;
  }
}

// ============================================================================
// LEAVE WARNING MODAL
// ============================================================================
let pendingNavigationUrl = null;

function showLeaveModal(url) {
  pendingNavigationUrl = url;
  document.getElementById('leave-modal-overlay')?.classList.add('show');
}

function hideLeaveModal() {
  document.getElementById('leave-modal-overlay')?.classList.remove('show');
  pendingNavigationUrl = null;
}

// ============================================================================
// INITIALIZATION
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
  // Multi-select pills
  document.querySelectorAll('.multi-select-pill').forEach(pill => {
    pill.addEventListener('click', function() {
      const checkbox = this.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      this.classList.toggle('active', checkbox.checked);
      markUnsaved();
    });
  });

  // Add button listeners
  document.getElementById('btn-add-product-service')?.addEventListener('click', addProductService);
  document.getElementById('btn-add-staff')?.addEventListener('click', addStaff);
  document.getElementById('btn-add-resource')?.addEventListener('click', addResource);
  document.getElementById('btn-add-fund')?.addEventListener('click', addFund);
  document.getElementById('btn-save-continue')?.addEventListener('click', saveAndContinue);

  // Delete listeners
  attachDeleteListeners();

  // Financial listeners
  attachFinancialListeners();

  // Initialize toggle states
  if (document.getElementById('toggle_financial')?.checked) {
    document.getElementById('financial-fields')?.classList.add('show');
  }
  if (document.getElementById('toggle_funds')?.checked) {
    document.getElementById('funds-fields')?.classList.add('show');
  }

  // Initialize financial section
  calculateGrowthAndUpdateReasons();
  initFinancialChart();

  // Initialize contribution progress
  updateContributionProgress();

  // Leave modal handlers
  document.getElementById('btn-stay')?.addEventListener('click', hideLeaveModal);
  document.getElementById('btn-leave')?.addEventListener('click', function() {
    hasUnsavedChanges = false;
    window.onbeforeunload = null;
    if (pendingNavigationUrl) {
      window.location.href = pendingNavigationUrl;
    }
  });

  document.getElementById('leave-modal-overlay')?.addEventListener('click', function(e) {
    if (e.target === this) hideLeaveModal();
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') hideLeaveModal();
  });

  // Intercept internal links
  document.addEventListener('click', function(e) {
    const link = e.target.closest('a');
    if (link && link.href && !link.href.startsWith('javascript:') && !link.target) {
      if (link.href.startsWith(window.location.origin) || link.href.startsWith('/')) {
        if (hasUnsavedChanges) {
          e.preventDefault();
          showLeaveModal(link.href);
        }
      }
    }
  });

  // RTL support
  if (CONFIG.isArabic) {
    document.documentElement.setAttribute('dir', 'rtl');
    document.documentElement.setAttribute('lang', 'ar');
  }

  console.log('✅ Business Profile page initialized');
});


// ============================================================================
// SAVE & CONTINUE
// ============================================================================
async function saveAndContinue() {
  if (isSaving) return;

  // Check if funding sources total is 100% (if funding section is enabled)
  const fundingToggle = document.getElementById('toggle_funds');
  if (fundingToggle && fundingToggle.checked) {
    const total = updateContributionProgress();
    if (total !== 100) {
      showToast(
        CONFIG.isArabic
          ? 'يجب أن يكون مجموع مصادر التمويل 100%'
          : 'Funding sources must total 100%',
        'error'
      );
      return;
    }
  }

  isSaving = true;

  // Disable button while saving
  const saveBtn = document.getElementById('btn-save-continue');
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="material-icons">sync</i> ' + (CONFIG.isArabic ? 'جاري الحفظ...' : 'Saving...');
  }

  // Remove beforeunload warning during save
  window.onbeforeunload = null;
  updateAutoSaveStatus('saving');

  const form = document.getElementById('business-profile-form');
  const formData = new FormData(form);
  formData.set('action', 'save');

  try {
    const response = await fetch(window.location.href, {
      method: 'POST',
      body: formData
    });

    if (response.redirected) {
      window.location.href = response.url;
    } else if (response.ok) {
      markSaved();
      showToast(CONFIG.isArabic ? 'تم الحفظ بنجاح' : 'Saved successfully');

      // Redirect to next page
      setTimeout(() => {
        window.location.href = '/business_premises/' + CONFIG.bplanId;
      }, 500);
    } else {
      throw new Error('Save failed');
    }
  } catch (error) {
    console.error('Error:', error);
    showToast(CONFIG.isArabic ? 'حدث خطأ أثناء الحفظ' : 'Error while saving', 'error');
    updateAutoSaveStatus('error');

    // Re-enable beforeunload warning
    window.onbeforeunload = function(e) {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
      }
    };

    // Re-enable button
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.innerHTML = '<i class="material-icons">check</i> ' + (CONFIG.isArabic ? 'حفظ ومتابعة' : 'Save & Continue');
    }
  } finally {
    isSaving = false;
  }
}

// ============================================================================
// AUTO-SAVE STATUS UPDATE
// ============================================================================
function updateAutoSaveStatus(status) {
  const el = document.getElementById('auto-save-status');
  if (!el) return;

  const icon = el.querySelector('i');
  const text = el.querySelector('span');

  el.classList.remove('saving', 'saved', 'error');

  if (status === 'saving') {
    el.classList.add('saving');
    icon.textContent = 'sync';
    text.textContent = CONFIG.isArabic ? 'جاري الحفظ...' : 'Saving...';
  } else if (status === 'saved') {
    el.classList.add('saved');
    icon.textContent = 'cloud_done';
    text.textContent = CONFIG.isArabic ? 'تم الحفظ' : 'Saved';
  } else if (status === 'error') {
    el.classList.add('error');
    icon.textContent = 'cloud_off';
    text.textContent = CONFIG.isArabic ? 'فشل الحفظ' : 'Save failed';
  } else {
    icon.textContent = 'cloud_off';
    text.textContent = CONFIG.isArabic ? 'غير محفوظ' : 'Unsaved';
  }
}
</script>
{% endblock javascripts %}