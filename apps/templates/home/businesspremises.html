{% extends "layouts/base.html" %}

{% block title %}
  {% if session.get('lang', 'en') == 'ar' %}مقر العمل{% else %}Business Premises{% endif %}
{% endblock %}

{% block stylesheets %}
<style>
:root {
  --primary-gradient: linear-gradient(135deg, #4F7DF3 0%, #1A73E8 100%);
  --primary-color: #4F7DF3;
  --primary-dark: #1A73E8;
  --success-color: #10B981;
  --warning-color: #F59E0B;
  --danger-color: #EF4444;
  --info-color: #17c1e8;
  --surface-color: #F8FAFC;
  --border-color: #E2E8F0;
  --text-primary: #1E293B;
  --text-secondary: #64748B;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --radius-xl: 24px;
}

.premises-page-container {
  padding: 1.5rem;
  background: linear-gradient(180deg, #F0F4FF 0%, #FFFFFF 100%);
  min-height: 100vh;
}

.progress-section {
  background: white;
  border-radius: var(--radius-lg);
  padding: 1.25rem 1.5rem;
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-md);
}

.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

.progress-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--text-primary);
}

.progress-percentage {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--primary-color);
}

.progress-bar-container {
  height: 10px;
  background: #E2E8F0;
  border-radius: 5px;
  overflow: hidden;
}

.progress-bar-fill {
  height: 100%;
  border-radius: 5px;
  transition: width 0.5s ease;
}

.progress-bar-fill.success { background: var(--success-color); }
.progress-bar-fill.info { background: var(--info-color); }
.progress-bar-fill.danger { background: var(--danger-color); }

.profile-card {
  background: white;
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-md);
  margin-bottom: 1.5rem;
  overflow: hidden;
  transition: box-shadow 0.3s ease;
}

.profile-card:hover {
  box-shadow: var(--shadow-lg);
}

.profile-card-header {
  background: var(--primary-gradient);
  padding: 1.25rem 1.5rem;
  position: relative;
  overflow: hidden;
}

.profile-card-header::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -20%;
  width: 200px;
  height: 200px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 50%;
}

.profile-card-header h5 {
  color: white;
  font-size: 1.25rem;
  font-weight: 600;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  position: relative;
  z-index: 1;
}

.profile-card-body {
  padding: 1.5rem;
}

.section-title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--primary-color);
  margin-bottom: 1.25rem;
  padding-bottom: 0.75rem;
  border-bottom: 2px solid rgba(79, 125, 243, 0.1);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.form-group-modern {
  margin-bottom: 1.25rem;
}

.form-label-modern {
  display: block;
  font-size: 0.8125rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.025em;
}

.form-control-modern {
  width: 100%;
  padding: 0.75rem 1rem;
  font-size: 0.9375rem;
  border: 1.5px solid var(--border-color);
  border-radius: var(--radius-md);
  background: white;
  color: var(--text-primary);
  transition: all 0.2s ease;
  box-sizing: border-box;
}

.form-control-modern:hover {
  border-color: #CBD5E1;
}

.form-control-modern:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(79, 125, 243, 0.15);
}

select.form-control-modern {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364748B' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  padding-right: 2.5rem;
  cursor: pointer;
}

html[dir="rtl"] select.form-control-modern {
  background-position: left 1rem center;
  padding-right: 1rem;
  padding-left: 2.5rem;
}

.add-item-card {
  background: var(--surface-color);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.add-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.25rem;
}

.add-item-title {
  font-size: 0.9375rem;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.add-item-title i {
  color: var(--primary-color);
}

.btn-add-item {
  padding: 0.625rem 1.25rem;
  font-size: 0.875rem;
  font-weight: 600;
  background: var(--primary-gradient);
  color: white;
  border: none;
  border-radius: var(--radius-md);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(79, 125, 243, 0.3);
}

.btn-add-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(79, 125, 243, 0.4);
}

.btn-add-item:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
.grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
.grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }

@media (max-width: 992px) {
  .grid-4 { grid-template-columns: repeat(2, 1fr); }
  .grid-3 { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 768px) {
  .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
  .premises-page-container { padding: 1rem; }
}

.data-table-container {
  background: white;
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-color);
  overflow: hidden;
}

.data-table-header {
  background: var(--surface-color);
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.data-table-title {
  font-size: 0.9375rem;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.data-table-title i {
  color: var(--primary-color);
}

.data-table-count {
  background: var(--primary-color);
  color: white;
  font-size: 0.75rem;
  font-weight: 600;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
}

.data-table {
  width: 100%;
  margin: 0;
  border-collapse: collapse;
}

.data-table thead {
  background: #F1F5F9;
}

.data-table th {
  padding: 0.875rem 1rem;
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-secondary);
  border: none;
  text-align: left;
}

.data-table td {
  padding: 1rem;
  font-size: 0.875rem;
  color: var(--text-primary);
  border-bottom: 1px solid var(--border-color);
  vertical-align: middle;
}

.data-table tbody tr {
  transition: all 0.2s ease;
}

.data-table tbody tr:hover {
  background: rgba(79, 125, 243, 0.04);
}

.data-table tbody tr:last-child td {
  border-bottom: none;
}

html[dir="rtl"] .data-table th,
html[dir="rtl"] .data-table td {
  text-align: right;
}

.btn-delete-row {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-sm);
  border: 1px solid #FECACA;
  background: #FEF2F2;
  color: var(--danger-color);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.btn-delete-row:hover {
  background: var(--danger-color);
  border-color: var(--danger-color);
  color: white;
  transform: scale(1.05);
}

.empty-table-state {
  padding: 3rem 1.5rem;
  text-align: center;
}

.empty-table-icon {
  font-size: 48px;
  color: #CBD5E1;
  margin-bottom: 1rem;
}

.empty-table-text {
  font-size: 0.9375rem;
  color: var(--text-secondary);
  margin-bottom: 0.25rem;
}

.empty-table-hint {
  font-size: 0.8125rem;
  color: #94A3B8;
}

.badge-modern {
  padding: 0.375rem 0.75rem;
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: 20px;
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
}

.badge-success { background: #D1FAE5; color: #065F46; }
.badge-info { background: #DBEAFE; color: #1E40AF; }
.badge-warning { background: #FEF3C7; color: #92400E; }
.badge-danger { background: #FEE2E2; color: #991B1B; }
.badge-primary { background: rgba(79, 125, 243, 0.15); color: var(--primary-color); }
.badge-secondary { background: #F1F5F9; color: var(--text-secondary); }

.conditional-fields {
  display: none;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px dashed var(--border-color);
}

.conditional-fields.show {
  display: block;
}

.multi-select-wrapper {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  padding: 0.75rem;
  background: white;
  border: 1.5px solid var(--border-color);
  border-radius: var(--radius-md);
  min-height: 50px;
}

.multi-select-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.5rem 1rem;
  background: var(--surface-color);
  border: 1.5px solid var(--border-color);
  border-radius: 25px;
  font-size: 0.8125rem;
  cursor: pointer;
  transition: all 0.2s ease;
  user-select: none;
}

.multi-select-pill:hover {
  border-color: var(--primary-color);
}

.multi-select-pill.active {
  background: var(--primary-gradient);
  border-color: transparent;
  color: white;
}

.multi-select-pill input {
  display: none;
}

.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
  padding: 1.5rem;
  background: var(--surface-color);
  border-top: 1px solid var(--border-color);
  border-radius: 0 0 var(--radius-xl) var(--radius-xl);
  align-items: center;
}

.btn-modern {
  padding: 0.875rem 1.75rem;
  font-size: 0.9375rem;
  font-weight: 600;
  border-radius: var(--radius-md);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s ease;
  border: none;
}

.btn-primary-modern {
  background: var(--primary-gradient);
  color: white;
  box-shadow: 0 4px 14px rgba(79, 125, 243, 0.35);
}

.btn-primary-modern:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(79, 125, 243, 0.45);
}

.auto-save-status {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.8125rem;
  color: var(--text-secondary);
  margin-right: auto;
}

.auto-save-status i { font-size: 18px; }
.auto-save-status.saving { color: var(--warning-color); }
.auto-save-status.saved { color: var(--success-color); }

.toast-notification {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1060;
  background: white;
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  padding: 1rem 1.25rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.3s ease;
}

.toast-notification.show {
  transform: translateY(0);
  opacity: 1;
}

.toast-notification.success { border-left: 4px solid var(--success-color); }
.toast-notification.error { border-left: 4px solid var(--danger-color); }

.toast-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.toast-icon.success { background: #D1FAE5; color: var(--success-color); }
.toast-icon.error { background: #FEE2E2; color: var(--danger-color); }

/* Upload Zone - FIXED */
.upload-zone-container {
  position: relative;
  border: 2px dashed var(--border-color);
  border-radius: var(--radius-lg);
  padding: 2rem;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
  background: var(--surface-color);
}

.upload-zone-container:hover {
  border-color: var(--primary-color);
  background: rgba(79, 125, 243, 0.05);
}

.upload-zone-container.success {
  border-color: var(--success-color);
  background: rgba(16, 185, 129, 0.05);
}

.upload-zone-icon {
  font-size: 48px;
  color: var(--primary-color);
  margin-bottom: 1rem;
}

.upload-zone-title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
}

.upload-zone-hint {
  font-size: 0.8125rem;
  color: var(--text-secondary);
}

.upload-formats {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
  margin-top: 1rem;
  flex-wrap: wrap;
}

.format-badge {
  padding: 0.25rem 0.75rem;
  background: white;
  border: 1px solid var(--border-color);
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-secondary);
}

/* Dropzone styling - FIXED to not cover other elements */
.dropzone {
  border: none !important;
  background: transparent !important;
  min-height: auto !important;
  padding: 0 !important;
}

.dropzone .dz-message {
  display: none !important;
}

.dropzone .dz-preview {
  display: none !important;
}

.photo-gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.photo-card {
  position: relative;
  border-radius: var(--radius-md);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s ease;
  aspect-ratio: 1;
}

.photo-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.photo-card img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.photo-card-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 50%);
  opacity: 0;
  transition: opacity 0.3s ease;
  display: flex;
  align-items: flex-end;
  padding: 0.75rem;
}

.photo-card:hover .photo-card-overlay {
  opacity: 1;
}

.photo-checkbox {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: var(--danger-color);
}

.document-card {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  padding: 1rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  transition: all 0.3s ease;
}

.document-card:hover {
  border-color: var(--primary-color);
  box-shadow: var(--shadow-md);
}

.document-icon {
  width: 48px;
  height: 48px;
  background: var(--primary-gradient);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  flex-shrink: 0;
}

.document-info {
  flex: 1;
  min-width: 0;
}

.document-name {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.25rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.document-desc {
  font-size: 0.8125rem;
  color: var(--text-secondary);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.document-actions {
  display: flex;
  gap: 0.5rem;
  flex-shrink: 0;
}

.btn-icon {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-color);
  background: white;
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  text-decoration: none;
}

.btn-icon:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
}

.btn-icon.danger:hover {
  border-color: var(--danger-color);
  background: #FEF2F2;
  color: var(--danger-color);
}

.premise-info {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.premise-icon {
  width: 40px;
  height: 40px;
  background: var(--primary-gradient);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  flex-shrink: 0;
}

.premise-details h6 {
  font-weight: 600;
  color: var(--text-primary);
  margin: 0 0 0.25rem;
}

.premise-details p {
  font-size: 0.8125rem;
  color: var(--text-secondary);
  margin: 0;
}

.tags-container {
  display: flex;
  flex-wrap: wrap;
  gap: 0.375rem;
}

.tag {
  padding: 0.25rem 0.625rem;
  background: var(--surface-color);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  font-size: 0.75rem;
  color: var(--text-secondary);
}

html[dir="rtl"] .section-title,
html[dir="rtl"] .add-item-title,
html[dir="rtl"] .data-table-title,
html[dir="rtl"] .btn-modern {
  flex-direction: row-reverse;
}

html[dir="rtl"] .form-actions {
  flex-direction: row-reverse;
}

html[dir="rtl"] .auto-save-status {
  margin-right: 0;
  margin-left: auto;
}

html[dir="rtl"] .toast-notification {
  right: auto;
  left: 20px;
}

html[dir="rtl"] .toast-notification.success {
  border-left: none;
  border-right: 4px solid var(--success-color);
}

html[dir="rtl"] .toast-notification.error {
  border-left: none;
  border-right: 4px solid var(--danger-color);
}

html[dir="rtl"] .photo-checkbox {
  right: auto;
  left: 0.5rem;
}


/* Photo Delete Button */
.photo-delete-btn {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: rgba(239, 68, 68, 0.9);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.2s ease;
  z-index: 10;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.photo-delete-btn i {
  font-size: 18px;
}

.photo-delete-btn:hover {
  background: var(--danger-color);
  transform: scale(1.1);
}

.photo-card:hover .photo-delete-btn {
  opacity: 1;
}

/* Document Delete Button */
.doc-delete-btn {
  border: 1px solid #FECACA !important;
  background: #FEF2F2 !important;
  color: var(--danger-color) !important;
}

.doc-delete-btn:hover {
  background: var(--danger-color) !important;
  border-color: var(--danger-color) !important;
  color: white !important;
}

/* RTL Support */
html[dir="rtl"] .photo-delete-btn {
  right: auto;
  left: 0.5rem;
}

</style>
{% endblock stylesheets %}

{% block content %}
<div class="premises-page-container">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-xl-10 col-lg-11">

        <!-- Toast Notification -->
        <div class="toast-notification" id="toast-notification">
          <div class="toast-icon" id="toast-icon"><i class="material-icons" id="toast-icon-symbol">check</i></div>
          <span class="toast-message" id="toast-message"></span>
        </div>

        <!-- Progress Section -->
        <div class="progress-section">
          <div class="progress-header">
            <span class="progress-label">{% if session.get('lang', 'en') == 'ar' %}تقدم الملف{% else %}Profile Completion{% endif %}</span>
            <span class="progress-percentage">{{ data_comp[0].completion }}%</span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill {% if data_comp[0].completion == 100 %}success{% elif data_comp[0].completion >= 50 %}info{% else %}danger{% endif %}" style="width: {{ data_comp[0].completion }}%;"></div>
          </div>
        </div>

        <!-- Main Form -->
        <form id="premises-form" method="POST" action="/business_premises/{{ bplan_id }}">

          <!-- PREMISES DETAILS CARD -->
          <div class="profile-card">
            <div class="profile-card-header">
              <h5><i class="material-icons">business</i>{% if session.get('lang', 'en') == 'ar' %}مقر العمل{% else %}Business Premises{% endif %}</h5>
            </div>
            <div class="profile-card-body">

              <!-- Add Premise Form -->
              <div class="add-item-card">
                <div class="add-item-header">
                  <span class="add-item-title"><i class="material-icons">add_location</i>{% if session.get('lang', 'en') == 'ar' %}إضافة مقر جديد{% else %}Add New Premise{% endif %}</span>
                </div>

                <!-- Row 1: Address, Plot Number, Plot Area -->
                <div class="grid-3">
                  <div class="form-group-modern">
                    <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}العنوان{% else %}Address{% endif %}</label>
                    <input class="form-control-modern" type="text" name="premise_address" placeholder="{% if session.get('lang', 'en') == 'ar' %}أدخل العنوان{% else %}Enter address{% endif %}" autocomplete="off"/>
                  </div>
                  <div class="form-group-modern">
                    <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}رقم القطعة{% else %}Plot Number{% endif %}</label>
                    <input class="form-control-modern" type="text" name="plot_number" placeholder="{% if session.get('lang', 'en') == 'ar' %}رقم القطعة{% else %}Plot #{% endif %}" autocomplete="off"/>
                  </div>
                  <div class="form-group-modern">
                    <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}مساحة القطعة (م²){% else %}Plot Area (SQM){% endif %}</label>
                    <input class="form-control-modern" type="number" name="plot_area" value="0" min="0"/>
                  </div>
                </div>

                <!-- Row 2: Premise Nature (Multi-select) -->
                <div class="form-group-modern">
                  <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}طبيعة المقر{% else %}Premise Nature{% endif %}</label>
                  <div class="multi-select-wrapper" id="premise-nature-wrapper">
                    {% set natures = [
                      ('Land', 'أرض', 'terrain'),
                      ('Hangar', 'هنغار', 'warehouse'),
                      ('Chamber', 'غرفة', 'meeting_room'),
                      ('Warehouse', 'مستودع', 'inventory'),
                      ('Office Space', 'مساحة مكتبية', 'business'),
                      ('Retail Space', 'مساحة بيع بالتجزئة', 'storefront'),
                      ('Basement', 'قبو', 'layers'),
                      ('Mezzanine', 'ميزانين', 'stairs'),
                      ('Apartment', 'شقة', 'apartment'),
                      ('Building', 'مبنى', 'domain'),
                      ('Atelier', 'مرسم', 'palette'),
                      ('From Home', 'من المنزل', 'home')
                    ] %}
                    {% for value, ar_label, icon in natures %}
                    <label class="multi-select-pill">
                      <input type="checkbox" name="choice_premise_nature" value="{{ value }}">
                      <i class="material-icons" style="font-size:16px;">{{ icon }}</i>
                      {% if session.get('lang', 'en') == 'ar' %}{{ ar_label }}{% else %}{{ value }}{% endif %}
                    </label>
                    {% endfor %}
                  </div>
                </div>

                <!-- Row 3: Surroundings (Multi-select) -->
                <div class="form-group-modern">
                  <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}المحيط{% else %}Surroundings{% endif %}</label>
                  <div class="multi-select-wrapper" id="surroundings-wrapper">
                    {% set surroundings = [
                      ('Banks', 'بنوك', 'account_balance'),
                      ('Restaurants', 'مطاعم', 'restaurant'),
                      ('Universities', 'جامعات', 'school'),
                      ('Cafes', 'مقاهي', 'local_cafe'),
                      ('Malls', 'مراكز تجارية', 'local_mall'),
                      ('Shops', 'محلات', 'store'),
                      ('Factories', 'مصانع', 'factory'),
                      ('Offices', 'مكاتب', 'business_center'),
                      ('Residential Buildings', 'مباني سكنية', 'apartment'),
                      ('Hospitals', 'مستشفيات', 'local_hospital'),
                      ('Farms', 'مزارع', 'agriculture'),
                      ('Forests', 'غابات', 'park')
                    ] %}
                    {% for value, ar_label, icon in surroundings %}
                    <label class="multi-select-pill">
                      <input type="checkbox" name="choice_surroundings" value="{{ value }}">
                      <i class="material-icons" style="font-size:16px;">{{ icon }}</i>
                      {% if session.get('lang', 'en') == 'ar' %}{{ ar_label }}{% else %}{{ value }}{% endif %}
                    </label>
                    {% endfor %}
                  </div>
                </div>

                <!-- Row 4: Ownership -->
                <div class="grid-3">
                  <div class="form-group-modern">
                    <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}ملكية المقر{% else %}Premises Ownership{% endif %}</label>
                    <select class="form-control-modern" name="choice_premises_ownershipe" id="choice_premises_ownership" onchange="handleOwnershipChange()">
                      <option value="Fully Owned">{% if session.get('lang', 'en') == 'ar' %}مملوك بالكامل{% else %}Fully Owned{% endif %}</option>
                      <option value="Partially Owned">{% if session.get('lang', 'en') == 'ar' %}مملوك جزئياً{% else %}Partially Owned{% endif %}</option>
                      <option value="Rented">{% if session.get('lang', 'en') == 'ar' %}مؤجر{% else %}Rented{% endif %}</option>
                      <option value="Indulgence">{% if session.get('lang', 'en') == 'ar' %}تنازل{% else %}Indulgence{% endif %}</option>
                      <option value="Other">{% if session.get('lang', 'en') == 'ar' %}أخرى{% else %}Other{% endif %}</option>
                    </select>
                  </div>
                </div>

                <!-- Conditional: Partially Owned Fields -->
                <div class="conditional-fields" id="partial-ownership-fields">
                  <div class="grid-3">
                    <div class="form-group-modern">
                      <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}اسم الشريك{% else %}Partner Name{% endif %}</label>
                      <input class="form-control-modern" type="text" name="partner_name" placeholder="{% if session.get('lang', 'en') == 'ar' %}اسم الشريك{% else %}Partner name{% endif %}" autocomplete="off"/>
                    </div>
                    <div class="form-group-modern">
                      <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}صلة القرابة{% else %}Partner Relation{% endif %}</label>
                      <select class="form-control-modern" name="choice_partner_relation">
                        <option value="No Relation">{% if session.get('lang', 'en') == 'ar' %}لا توجد صلة{% else %}No Relation{% endif %}</option>
                        <option value="Brother">{% if session.get('lang', 'en') == 'ar' %}أخ{% else %}Brother{% endif %}</option>
                        <option value="Sister">{% if session.get('lang', 'en') == 'ar' %}أخت{% else %}Sister{% endif %}</option>
                        <option value="Father">{% if session.get('lang', 'en') == 'ar' %}أب{% else %}Father{% endif %}</option>
                        <option value="Mother">{% if session.get('lang', 'en') == 'ar' %}أم{% else %}Mother{% endif %}</option>
                        <option value="Son">{% if session.get('lang', 'en') == 'ar' %}ابن{% else %}Son{% endif %}</option>
                        <option value="Cousin">{% if session.get('lang', 'en') == 'ar' %}ابن عم{% else %}Cousin{% endif %}</option>
                        <option value="Husband">{% if session.get('lang', 'en') == 'ar' %}زوج{% else %}Husband{% endif %}</option>
                        <option value="Wife">{% if session.get('lang', 'en') == 'ar' %}زوجة{% else %}Wife{% endif %}</option>
                      </select>
                    </div>
                    <div class="form-group-modern">
                      <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}نسبة الملكية (%){% else %}Ownership (%){% endif %}</label>
                      <input class="form-control-modern" type="number" name="percentge_of_ownership" min="0" max="100" placeholder="50"/>
                    </div>
                  </div>
                </div>

                <!-- Conditional: Rented Fields -->
                <div class="conditional-fields" id="rented-fields">
                  <div class="grid-3">
                    <div class="form-group-modern">
                      <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}رسوم الإيجار{% else %}Rent Fees{% endif %}</label>
                      <input class="form-control-modern" type="number" name="rent_fees" min="0" placeholder="{% if session.get('lang', 'en') == 'ar' %}المبلغ{% else %}Amount{% endif %}"/>
                    </div>
                    <div class="form-group-modern">
                      <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}تاريخ انتهاء العقد{% else %}Lease Expiration Date{% endif %}</label>
                      <input class="form-control-modern" type="date" name="rent_expiration_date" id="rent_expiration_date"/>
                    </div>
                    <div class="form-group-modern">
                      <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}وحدة الدفع{% else %}Payment Unit{% endif %}</label>
                      <select class="form-control-modern" name="choice_rent_unit">
                        <option value="Month">{% if session.get('lang', 'en') == 'ar' %}شهري{% else %}Monthly{% endif %}</option>
                        <option value="Year">{% if session.get('lang', 'en') == 'ar' %}سنوي{% else %}Yearly{% endif %}</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
                  <button type="submit" class="btn-add-item" name="premise_add" value="{{ bplan_id }}">
                    <i class="material-icons">add</i>{% if session.get('lang', 'en') == 'ar' %}إضافة{% else %}Add{% endif %}
                  </button>
                </div>

              </div>

              <!-- Premises List Table -->
              <div class="data-table-container" id="premises-table-container">
                <div class="data-table-header">
                  <span class="data-table-title"><i class="material-icons">list</i>{% if session.get('lang', 'en') == 'ar' %}قائمة المقرات{% else %}Premises List{% endif %}</span>
                  <span class="data-table-count">{{ data_bp|length }}</span>
                </div>
                {% if data_bp and data_bp|length > 0 %}
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>{% if session.get('lang', 'en') == 'ar' %}المقر{% else %}Premise{% endif %}</th>
                      <th>{% if session.get('lang', 'en') == 'ar' %}التفاصيل{% else %}Details{% endif %}</th>
                      <th>{% if session.get('lang', 'en') == 'ar' %}الملكية{% else %}Ownership{% endif %}</th>
                      <th>{% if session.get('lang', 'en') == 'ar' %}المحيط{% else %}Surroundings{% endif %}</th>
                      <th style="width:80px;text-align:center;">{% if session.get('lang', 'en') == 'ar' %}حذف{% else %}Delete{% endif %}</th>
                    </tr>
                  </thead>
                  <tbody id="premises-tbody">
                    {% for row in data_bp %}
                    <tr>
                      <td>
                        <div class="premise-info">
                          <div class="premise-icon"><i class="material-icons">location_on</i></div>
                          <div class="premise-details">
                            <h6>{{ row.premise_address or 'N/A' }}</h6>
                            <p><i class="material-icons" style="font-size:12px;">tag</i> {% if session.get('lang', 'en') == 'ar' %}قطعة{% else %}Plot{% endif %} #{{ row.plot_number or 'N/A' }}</p>
                          </div>
                        </div>
                      </td>
                      <td>
                        <div>
                          <span class="badge-modern badge-primary" style="margin-bottom:0.25rem;">
                            {{ row.premise_nature or 'N/A' }}
                          </span>
                          <p style="margin:0;font-size:0.8125rem;color:var(--text-secondary);">
                            <i class="material-icons" style="font-size:12px;">square_foot</i>
                            {{ row.plot_area or 0 }} {% if session.get('lang', 'en') == 'ar' %}م²{% else %}sqm{% endif %}
                          </p>
                        </div>
                      </td>
                      <td>
                        <span class="badge-modern {% if row.premise_ownership == 'Fully Owned' %}badge-success{% elif row.premise_ownership == 'Rented' %}badge-warning{% elif row.premise_ownership == 'Partially Owned' %}badge-info{% else %}badge-secondary{% endif %}">
                          {% if session.get('lang', 'en') == 'ar' %}
                            {% if row.premise_ownership == 'Fully Owned' %}مملوك بالكامل
                            {% elif row.premise_ownership == 'Rented' %}مؤجر
                            {% elif row.premise_ownership == 'Partially Owned' %}مملوك جزئياً
                            {% elif row.premise_ownership == 'Indulgence' %}تنازل
                            {% else %}{{ row.premise_ownership }}{% endif %}
                          {% else %}
                            {{ row.premise_ownership }}
                          {% endif %}
                        </span>
                        {% if row.premise_ownership == 'Rented' and row.rent_fees %}
                        <p style="margin:0.25rem 0 0;font-size:0.75rem;color:var(--text-secondary);">
                          ${{ row.rent_fees }}/{% if row.rent_unit == 'Month' %}{% if session.get('lang', 'en') == 'ar' %}شهر{% else %}mo{% endif %}{% else %}{% if session.get('lang', 'en') == 'ar' %}سنة{% else %}yr{% endif %}{% endif %}
                        </p>
                        {% endif %}
                        {% if row.premise_ownership == 'Partially Owned' and row.percentage_of_ownership %}
                        <p style="margin:0.25rem 0 0;font-size:0.75rem;color:var(--text-secondary);">
                          {{ row.partner_name }} ({{ row.percentage_of_ownership }}%)
                        </p>
                        {% endif %}
                      </td>
                      <td>
                        <div class="tags-container">
                          {% if row.premise_surrounding %}
                            {% set surroundings_list = row.premise_surrounding.split(', ')[:3] %}
                            {% for surrounding in surroundings_list %}
                            <span class="tag">{{ surrounding }}</span>
                            {% endfor %}
                            {% if row.premise_surrounding.split(', ')|length > 3 %}
                            <span class="tag">+{{ row.premise_surrounding.split(', ')|length - 3 }}</span>
                            {% endif %}
                          {% else %}
                            <span class="tag">N/A</span>
                          {% endif %}
                        </div>
                      </td>
                      <td style="text-align:center;">
                        <button type="button" class="btn-delete-row delete-premise-btn" data-premise-id="{{ row.premise_id }}">
                          <i class="material-icons">delete</i>
                        </button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
                {% else %}
                <div class="empty-table-state">
                  <i class="material-icons empty-table-icon">business</i>
                  <p class="empty-table-text">{% if session.get('lang', 'en') == 'ar' %}لا توجد مقرات مضافة{% else %}No premises added yet{% endif %}</p>
                  <p class="empty-table-hint">{% if session.get('lang', 'en') == 'ar' %}أضف مقرك الأول باستخدام النموذج أعلاه{% else %}Add your first premise using the form above{% endif %}</p>
                </div>
                {% endif %}
              </div>

            </div>
          </div>

          <!-- PHOTOS CARD -->
          <div class="profile-card">
            <div class="profile-card-body">
              <h6 class="section-title"><i class="material-icons">photo_library</i>{% if session.get('lang', 'en') == 'ar' %}صور المقر{% else %}Premise Photos{% endif %}</h6>

              <!-- Upload Zone - FIXED -->
              <div class="upload-zone-container" id="photo-upload-zone">
                <i class="material-icons upload-zone-icon">cloud_upload</i>
                <h6 class="upload-zone-title">{% if session.get('lang', 'en') == 'ar' %}اسحب وأفلت الصور هنا{% else %}Drag & drop photos here{% endif %}</h6>
                <p class="upload-zone-hint">{% if session.get('lang', 'en') == 'ar' %}أو انقر للاستعراض (حد أقصى 5 ميجابايت){% else %}or click to browse (max 5MB){% endif %}</p>
                <div class="upload-formats">
                  <span class="format-badge">JPG</span>
                  <span class="format-badge">PNG</span>
                  <span class="format-badge">WEBP</span>
                </div>
              </div>
              <!-- Hidden file input for photos -->
              <input type="file" id="photo-file-input" accept="image/*" multiple style="display:none;">

              <!-- Photo Gallery -->
                {% if data_bp_photo and data_bp_photo|length > 0 %}
                <div style="margin-top:1.5rem;">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <h6 style="margin:0;font-weight:600;color:var(--text-primary);">
                      <i class="material-icons" style="font-size:18px;vertical-align:middle;">collections</i>
                      {% if session.get('lang', 'en') == 'ar' %}الصور المرفوعة{% else %}Uploaded Photos{% endif %}
                      <span class="badge-modern badge-primary" style="margin-left:0.5rem;">{{ data_bp_photo|length }}</span>
                    </h6>
                  </div>
                  <div class="photo-gallery" id="photo-gallery">
                    {% for row in data_bp_photo %}
                    <div class="photo-card" id="photo-card-{{ row.photo_id }}">
                      <img src="/static/uploads/{{ row.bplan_id }}/{{ row.premises_photo_filename }}" alt="Photo {{ loop.index }}">
                      <button type="button" class="photo-delete-btn" data-photo-id="{{ row.photo_id }}" title="{% if session.get('lang', 'en') == 'ar' %}حذف{% else %}Delete{% endif %}">
                        <i class="material-icons">delete</i>
                      </button>
                      <div class="photo-card-overlay">
                        <span style="color:white;font-size:0.75rem;">{% if session.get('lang', 'en') == 'ar' %}صورة{% else %}Photo{% endif %} {{ loop.index }}</span>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}

            </div>
          </div>

          <!-- DOCUMENTS CARD -->
          <div class="profile-card">
            <div class="profile-card-body">
              <h6 class="section-title"><i class="material-icons">folder</i>{% if session.get('lang', 'en') == 'ar' %}مستندات المقر{% else %}Premise Documents{% endif %}</h6>

              <div class="grid-2" style="gap:1.5rem;">
                <!-- Upload Zone - FIXED -->
                <div>
                  <div class="upload-zone-container" id="doc-upload-zone">
                    <i class="material-icons upload-zone-icon" id="doc-upload-icon">description</i>
                    <h6 class="upload-zone-title" id="doc-upload-title">{% if session.get('lang', 'en') == 'ar' %}اسحب وأفلت المستندات{% else %}Drag & drop documents{% endif %}</h6>
                    <p class="upload-zone-hint">{% if session.get('lang', 'en') == 'ar' %}حد أقصى 20 ميجابايت{% else %}Max 20MB{% endif %}</p>
                    <div class="upload-formats">
                      <span class="format-badge">PDF</span>
                      <span class="format-badge">DOCX</span>
                      <span class="format-badge">XLSX</span>
                      <span class="format-badge">JPG</span>
                    </div>
                  </div>
                  <!-- Hidden file input for documents -->
                  <input type="file" id="doc-file-input" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.webp" style="display:none;">
                </div>

                <!-- Description & Add -->
                <div>
                  <div class="form-group-modern">
                    <label class="form-label-modern">{% if session.get('lang', 'en') == 'ar' %}وصف المستند{% else %}Document Description{% endif %} <span style="color:var(--danger-color);">*</span></label>
                    <textarea class="form-control-modern" name="doc_description" id="doc-description" rows="4" maxlength="200" placeholder="{% if session.get('lang', 'en') == 'ar' %}أدخل وصفاً للمستند...{% else %}Enter document description...{% endif %}" style="resize:none;"></textarea>
                    <div style="display:flex;justify-content:space-between;margin-top:0.5rem;">
                      <small style="color:var(--text-secondary);">{% if session.get('lang', 'en') == 'ar' %}اكتب وصفاً واضحاً{% else %}Write a clear description{% endif %}</small>
                      <small style="color:var(--text-secondary);" id="char-count">0/200</small>
                    </div>
                  </div>
                  <button type="button" id="add-doc-btn" class="btn-add-item" style="width:100%;justify-content:center;margin-top:1rem;" disabled>
                    <i class="material-icons">add_circle</i>
                    {% if session.get('lang', 'en') == 'ar' %}إضافة المستند{% else %}Add Document{% endif %}
                  </button>
                </div>
              </div>
                <!-- Documents List -->
                {% if data_bp_doc and data_bp_doc|length > 0 %}
                <div style="margin-top:1.5rem;">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <h6 style="margin:0;font-weight:600;color:var(--text-primary);">
                      <i class="material-icons" style="font-size:18px;vertical-align:middle;">folder_open</i>
                      {% if session.get('lang', 'en') == 'ar' %}المستندات المرفوعة{% else %}Uploaded Documents{% endif %}
                      <span class="badge-modern badge-primary" style="margin-left:0.5rem;">{{ data_bp_doc|length }}</span>
                    </h6>
                  </div>
                  <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:1rem;" id="documents-gallery">
                    {% for row in data_bp_doc %}
                    <div class="document-card" id="doc-card-{{ row.doc_id }}">
                      <div class="document-icon"><i class="material-icons">description</i></div>
                      <div class="document-info">
                        <div class="document-name">{{ row.premises_doc_filename }}</div>
                        <div class="document-desc">{{ row.description or (session.get('lang', 'en') == 'ar' and 'لا يوجد وصف' or 'No description') }}</div>
                      </div>
                      <div class="document-actions">
                        <a href="{{ url_for('static', filename='uploads/docs/' + bplan_id|string + '/' + row.premises_doc_filename) }}" target="_blank" class="btn-icon" title="{% if session.get('lang', 'en') == 'ar' %}عرض{% else %}View{% endif %}">
                          <i class="material-icons" style="font-size:18px;">visibility</i>
                        </a>
                        <button type="button" class="btn-icon danger doc-delete-btn" data-doc-id="{{ row.doc_id }}" title="{% if session.get('lang', 'en') == 'ar' %}حذف{% else %}Delete{% endif %}">
                          <i class="material-icons" style="font-size:18px;">delete</i>
                        </button>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}

            </div>
          </div>

          <!-- FORM ACTIONS -->
          <div class="profile-card">
            <div class="form-actions">
              <div class="auto-save-status" id="auto-save-status">
                <i class="material-icons">cloud_done</i>
                <span>{% if session.get('lang', 'en') == 'ar' %}تم الحفظ{% else %}Saved{% endif %}</span>
              </div>
              <button type="submit" class="btn-modern btn-primary-modern" name="action" value="save">
                <i class="material-icons">check</i>
                {% if session.get('lang', 'en') == 'ar' %}حفظ ومتابعة{% else %}Save & Continue{% endif %}
              </button>
            </div>
          </div>

        </form>

      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block javascripts %}
<script>
const CONFIG = {
  bplanId: '{{ bplan_id }}',
  lang: '{{ session.get("lang", "en") }}',
  isArabic: '{{ session.get("lang", "en") }}' === 'ar'
};

let currentUploadedDoc = null;

// ============================================================================
// TOAST NOTIFICATION
// ============================================================================
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast-notification');
  const icon = document.getElementById('toast-icon');
  const iconSymbol = document.getElementById('toast-icon-symbol');
  const messageEl = document.getElementById('toast-message');

  if (!toast) return;

  toast.classList.remove('success', 'error');
  icon.classList.remove('success', 'error');
  toast.classList.add(type);
  icon.classList.add(type);
  iconSymbol.textContent = type === 'success' ? 'check' : 'error';
  messageEl.textContent = message;
  toast.classList.add('show');

  setTimeout(() => { toast.classList.remove('show'); }, 3000);
}

// ============================================================================
// OWNERSHIP CHANGE HANDLER
// ============================================================================
function handleOwnershipChange() {
  const ownership = document.getElementById('choice_premises_ownership').value;
  const partialFields = document.getElementById('partial-ownership-fields');
  const rentedFields = document.getElementById('rented-fields');

  // Hide all conditional fields first
  partialFields.classList.remove('show');
  rentedFields.classList.remove('show');

  // Show relevant fields
  if (ownership === 'Partially Owned') {
    partialFields.classList.add('show');
  } else if (ownership === 'Rented') {
    rentedFields.classList.add('show');
  }
}

// ============================================================================
// MULTI-SELECT PILLS
// ============================================================================
function initMultiSelectPills() {
  document.querySelectorAll('.multi-select-pill').forEach(pill => {
    pill.addEventListener('click', function(e) {
      e.preventDefault();
      const checkbox = this.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      this.classList.toggle('active', checkbox.checked);
    });
  });
}

// ============================================================================
// DELETE PREMISE
// ============================================================================
function attachDeleteListeners() {
  document.querySelectorAll('.delete-premise-btn').forEach(btn => {
    btn.onclick = function(e) {
      e.preventDefault();
      const premiseId = this.dataset.premiseId;
      const confirmMsg = CONFIG.isArabic ? 'هل أنت متأكد من الحذف؟' : 'Are you sure you want to delete?';

      if (!confirm(confirmMsg)) return;

      const formData = new FormData();
      formData.append('premise_delete', premiseId);

      fetch(window.location.href, {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          showToast(CONFIG.isArabic ? 'تم الحذف' : 'Deleted successfully');
          this.closest('tr').remove();
          const countEl = document.querySelector('.data-table-count');
          if (countEl) {
            const current = parseInt(countEl.textContent);
            countEl.textContent = current - 1;
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
        window.location.reload();
      });
    };
  });
}

// ============================================================================
// CHARACTER COUNTER
// ============================================================================
function initCharCounter() {
  const textarea = document.getElementById('doc-description');
  if (textarea) {
    textarea.addEventListener('input', function() {
      document.getElementById('char-count').textContent = this.value.length + '/200';
    });
  }
}

// ============================================================================
// PHOTO UPLOAD - Using native file input
// ============================================================================
function initPhotoUpload() {
  const uploadZone = document.getElementById('photo-upload-zone');
  const fileInput = document.getElementById('photo-file-input');

  if (!uploadZone || !fileInput) return;

  // Click to upload
  uploadZone.addEventListener('click', function() {
    fileInput.click();
  });

  // Drag and drop
  uploadZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.style.borderColor = 'var(--primary-color)';
    this.style.background = 'rgba(79, 125, 243, 0.1)';
  });

  uploadZone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.style.borderColor = '';
    this.style.background = '';
  });

  uploadZone.addEventListener('drop', function(e) {
    e.preventDefault();
    this.style.borderColor = '';
    this.style.background = '';

    const files = e.dataTransfer.files;
    if (files.length > 0) {
      uploadPhotos(files);
    }
  });

  // File input change
  fileInput.addEventListener('change', function() {
    if (this.files.length > 0) {
      uploadPhotos(this.files);
    }
  });
}

function uploadPhotos(files) {
  for (let i = 0; i < files.length; i++) {
    const file = files[i];

    if (!file.type.startsWith('image/')) {
      showToast(CONFIG.isArabic ? 'يرجى اختيار صور فقط' : 'Please select images only', 'error');
      continue;
    }

    if (file.size > 5 * 1024 * 1024) {
      showToast(CONFIG.isArabic ? 'حجم الملف كبير جداً (الحد 5MB)' : 'File too large (max 5MB)', 'error');
      continue;
    }

    const formData = new FormData();
    formData.append('file', file);

    fetch('/upload/' + CONFIG.bplanId, {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        showToast(CONFIG.isArabic ? 'تم رفع الصورة' : 'Photo uploaded');
        setTimeout(() => window.location.reload(), 500);
      } else {
        showToast(CONFIG.isArabic ? 'فشل رفع الصورة' : 'Upload failed', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast(CONFIG.isArabic ? 'خطأ في الرفع' : 'Upload error', 'error');
    });
  }
}

// ============================================================================
// DOCUMENT UPLOAD - Using native file input
// ============================================================================
function initDocUpload() {
  const uploadZone = document.getElementById('doc-upload-zone');
  const fileInput = document.getElementById('doc-file-input');
  const addBtn = document.getElementById('add-doc-btn');

  if (!uploadZone || !fileInput) return;

  // Click to upload
  uploadZone.addEventListener('click', function() {
    fileInput.click();
  });

  // Drag and drop
  uploadZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.style.borderColor = 'var(--primary-color)';
    this.style.background = 'rgba(79, 125, 243, 0.1)';
  });

  uploadZone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.style.borderColor = '';
    this.style.background = '';
  });

  uploadZone.addEventListener('drop', function(e) {
    e.preventDefault();
    this.style.borderColor = '';
    this.style.background = '';

    const files = e.dataTransfer.files;
    if (files.length > 0) {
      uploadDocument(files[0]);
    }
  });

  // File input change
  fileInput.addEventListener('change', function() {
    if (this.files.length > 0) {
      uploadDocument(this.files[0]);
    }
  });

  // Add document button
  if (addBtn) {
    addBtn.addEventListener('click', function() {
      if (!currentUploadedDoc) {
        showToast(CONFIG.isArabic ? 'يرجى تحميل ملف أولاً' : 'Please upload a file first', 'error');
        return;
      }

      const description = document.getElementById('doc-description').value.trim();
      if (!description) {
        showToast(CONFIG.isArabic ? 'يرجى إدخال وصف' : 'Please enter a description', 'error');
        return;
      }

      this.disabled = true;
      this.innerHTML = '<i class="material-icons">sync</i> ' + (CONFIG.isArabic ? 'جاري الإضافة...' : 'Adding...');

      const formData = new FormData();
      formData.append('filename', currentUploadedDoc.filename);
      formData.append('description', description);

      fetch('/save_doc/' + CONFIG.bplanId, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showToast(data.error, 'error');
          this.disabled = false;
          this.innerHTML = '<i class="material-icons">add_circle</i> ' + (CONFIG.isArabic ? 'إضافة المستند' : 'Add Document');
        } else {
          showToast(CONFIG.isArabic ? 'تم إضافة المستند' : 'Document added');
          setTimeout(() => window.location.reload(), 500);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast(CONFIG.isArabic ? 'خطأ' : 'Error', 'error');
        this.disabled = false;
        this.innerHTML = '<i class="material-icons">add_circle</i> ' + (CONFIG.isArabic ? 'إضافة المستند' : 'Add Document');
      });
    });
  }
}

function uploadDocument(file) {
  const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                        'image/jpeg', 'image/png', 'image/webp'];

  if (file.size > 20 * 1024 * 1024) {
    showToast(CONFIG.isArabic ? 'حجم الملف كبير جداً (الحد 20MB)' : 'File too large (max 20MB)', 'error');
    return;
  }

  const formData = new FormData();
  formData.append('file', file);

  fetch('/upload_doc_temp/' + CONFIG.bplanId, {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      showToast(data.error, 'error');
    } else {
      currentUploadedDoc = { filename: data.filename };
      document.getElementById('add-doc-btn').disabled = false;

      // Update upload zone visual
      const zone = document.getElementById('doc-upload-zone');
      zone.classList.add('success');
      document.getElementById('doc-upload-icon').textContent = 'check_circle';
      document.getElementById('doc-upload-icon').style.color = 'var(--success-color)';
      document.getElementById('doc-upload-title').textContent = data.filename;

      showToast(CONFIG.isArabic ? 'تم تحميل الملف' : 'File uploaded');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast(CONFIG.isArabic ? 'خطأ في التحميل' : 'Upload error', 'error');
  });
}

// ============================================================================
// INITIALIZATION
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
  // Initialize ownership handler
  handleOwnershipChange();

  // Initialize multi-select pills
  initMultiSelectPills();

  // Attach delete listeners
  attachDeleteListeners();

  // Initialize character counter
  initCharCounter();

  // Initialize photo upload
  initPhotoUpload();

  // Initialize document upload
  initDocUpload();

  // Initialize individual delete buttons
  initPhotoDelete();
  initDocDelete();

  // RTL Support
  if (CONFIG.isArabic) {
    document.documentElement.setAttribute('dir', 'rtl');
    document.documentElement.setAttribute('lang', 'ar');
  }

  console.log('✅ Business Premises page initialized');
});






// ============================================================================
// INDIVIDUAL PHOTO DELETE
// ============================================================================
function initPhotoDelete() {
  document.querySelectorAll('.photo-delete-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();

      const photoId = this.dataset.photoId;
      const confirmMsg = CONFIG.isArabic ? 'هل أنت متأكد من حذف هذه الصورة؟' : 'Are you sure you want to delete this photo?';

      if (!confirm(confirmMsg)) return;

      // Show loading state
      this.innerHTML = '<i class="material-icons" style="animation: spin 1s linear infinite;">sync</i>';
      this.disabled = true;

      const formData = new FormData();
      formData.append('photo_to_delete', photoId);
      formData.append('delete_photo', 'true');

      fetch(window.location.href, {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          // Animate and remove the photo card
          const photoCard = document.getElementById('photo-card-' + photoId);
          if (photoCard) {
            photoCard.style.transition = 'all 0.3s ease';
            photoCard.style.transform = 'scale(0.8)';
            photoCard.style.opacity = '0';

            setTimeout(() => {
              photoCard.remove();

              // Update count badge
              const badge = document.querySelector('.photo-gallery')?.previousElementSibling?.querySelector('.badge-modern');
              if (badge) {
                const currentCount = parseInt(badge.textContent) - 1;
                badge.textContent = currentCount;

                // If no more photos, remove the entire section
                if (currentCount <= 0) {
                  document.querySelector('.photo-gallery')?.closest('div[style*="margin-top"]')?.remove();
                }
              }

              showToast(CONFIG.isArabic ? 'تم حذف الصورة' : 'Photo deleted');
            }, 300);
          }
        } else {
          throw new Error('Delete failed');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast(CONFIG.isArabic ? 'فشل الحذف' : 'Delete failed', 'error');
        this.innerHTML = '<i class="material-icons">delete</i>';
        this.disabled = false;
      });
    });
  });
}

// ============================================================================
// INDIVIDUAL DOCUMENT DELETE
// ============================================================================
function initDocDelete() {
  document.querySelectorAll('.doc-delete-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();

      const docId = this.dataset.docId;
      const confirmMsg = CONFIG.isArabic ? 'هل أنت متأكد من حذف هذا المستند؟' : 'Are you sure you want to delete this document?';

      if (!confirm(confirmMsg)) return;

      // Show loading state
      this.innerHTML = '<i class="material-icons" style="animation: spin 1s linear infinite;font-size:18px;">sync</i>';
      this.disabled = true;

      const formData = new FormData();
      formData.append('doc_to_delete', docId);
      formData.append('delete_doc', 'true');

      fetch(window.location.href, {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          // Animate and remove the document card
          const docCard = document.getElementById('doc-card-' + docId);
          if (docCard) {
            docCard.style.transition = 'all 0.3s ease';
            docCard.style.transform = 'scale(0.95)';
            docCard.style.opacity = '0';

            setTimeout(() => {
              docCard.remove();

              // Update count badge
              const docsGallery = document.getElementById('documents-gallery');
              const badge = docsGallery?.previousElementSibling?.querySelector('.badge-modern');
              if (badge) {
                const currentCount = parseInt(badge.textContent) - 1;
                badge.textContent = currentCount;

                // If no more documents, remove the entire section
                if (currentCount <= 0) {
                  docsGallery?.closest('div[style*="margin-top"]')?.remove();
                }
              }

              showToast(CONFIG.isArabic ? 'تم حذف المستند' : 'Document deleted');
            }, 300);
          }
        } else {
          throw new Error('Delete failed');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast(CONFIG.isArabic ? 'فشل الحذف' : 'Delete failed', 'error');
        this.innerHTML = '<i class="material-icons" style="font-size:18px;">delete</i>';
        this.disabled = false;
      });
    });
  });
}
</script>
{% endblock javascripts %}