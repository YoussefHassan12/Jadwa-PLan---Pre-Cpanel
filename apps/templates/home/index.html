{% if session.get('lang', 'en') == 'ar' %}
     {% extends "layouts/base-m-rtl.html" %}
   {% else %}
     {% extends "layouts/base-m.html" %}
   {% endif %}

{% block title %}
  {% if session.get('lang', 'en') == 'ar' %}
    خطط الأعمال
  {% else %}
    Business Plans
  {% endif %}
{% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}
<!-- Flash Messages -->
<div class="container-fluid">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show mt-3" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<section>
  <div class="container px-5 py-0">
    <form role="form" method="post" action="/new_plan" class="text-start">
        <div class="row justify-space-between text-right py-2">
            <button type="submit" class="btn bg-gradient-primary w-auto me-2">
              <i class="material-icons me-2" aria-hidden="true">add_circle</i>
              {% if session.get('lang', 'en') == 'ar' %}
                إضافة خطة عمل جديدة
              {% else %}
                Add New Business Plan
              {% endif %}
            </button>
        </div>
    </form>
  </div>
</section>
<br>
<section>
  <div class="container-fluid px-4 py-1">
    <div class="row">
      <div class="col-12">
        <div class="card my-4 shadow-sm border-0">
          <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
            <div class="bg-gradient-info shadow-info border-radius-lg pt-4 pb-3">
              <h5 class="text-white text-capitalize ps-3 mx-3">
                <i class="material-icons me-2" aria-hidden="true">business_center</i>
                {% if session.get('lang', 'en') == 'ar' %}
                  خطط الأعمال الخاصة بي
                {% else %}
                  My Business Plans
                {% endif %}
              </h5>
            </div>
          </div>
          <div class="card-body pt-4">
            <div class="table-responsive p-0">
              <table class="table align-items-center mb-0" id="datatable-search">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-4">
                      {% if session.get('lang', 'en') == 'ar' %}
                        خطة العمل
                      {% else %}
                        Business Plan
                      {% endif %}
                    </th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-3">
                      {% if session.get('lang', 'en') == 'ar' %}
                        الصناعة
                      {% else %}
                        Industry
                      {% endif %}
                    </th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-3">
                      {% if session.get('lang', 'en') == 'ar' %}
                        العملة
                      {% else %}
                        Currency
                      {% endif %}
                    </th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-3">
                      {% if session.get('lang', 'en') == 'ar' %}
                        تاريخ الإنشاء
                      {% else %}
                        Created
                      {% endif %}
                    </th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-3">
                      {% if session.get('lang', 'en') == 'ar' %}
                        الحالة
                      {% else %}
                        Status
                      {% endif %}
                    </th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder ps-3">
                      {% if session.get('lang', 'en') == 'ar' %}
                        التقدم
                      {% else %}
                        Progress
                      {% endif %}
                    </th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder text-center">
                      {% if session.get('lang', 'en') == 'ar' %}
                        الإجراءات
                      {% else %}
                        Actions
                      {% endif %}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in data %}
                  <tr class="border-bottom">
                    <td>
                      <div class="d-flex px-3 py-2">
                        <div>
                          <img src="{{ url_for('static', filename='uploads/' ~ row.client_avatar) if row.client_avatar else url_for('static', filename='assets/img/team.png') }}"
                              class="avatar avatar-sm me-3 rounded-circle shadow"
                              style="width: 45px; height: 45px; object-fit: cover; border: 2px solid #e9ecef;"
                              alt="{{ row.name }}">
                        </div>
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0 text-sm text-dark font-weight-bold">{{ row.name }}</h6>
                          <p class="text-xs text-muted mb-0">{{ row.email }}</p>
                        </div>
                      </div>
                    </td>
                    <td class="align-middle">
                      <span class="text-xs font-weight-bold">
                        {% if row.industry == "1" %}
                          {% if session.get('lang', 'en') == 'ar' %}
                            <span class="badge badge-sm bg-success">الزراعة</span>
                          {% else %}
                            <span class="badge badge-sm bg-success">Agriculture</span>
                          {% endif %}
                        {% elif row.industry == "2" %}
                          {% if session.get('lang', 'en') == 'ar' %}
                            <span class="badge badge-sm bg-info">التصنيع</span>
                          {% else %}
                            <span class="badge badge-sm bg-info">Manufacturing</span>
                          {% endif %}
                        {% elif row.industry == "3" %}
                          {% if session.get('lang', 'en') == 'ar' %}
                            <span class="badge badge-sm bg-warning">التكنولوجيا</span>
                          {% else %}
                            <span class="badge badge-sm bg-warning">Technology</span>
                          {% endif %}
                        {% elif row.industry == "4" %}
                          {% if session.get('lang', 'en') == 'ar' %}
                            <span class="badge badge-sm bg-secondary">الحرف اليدوية</span>
                          {% else %}
                            <span class="badge badge-sm bg-secondary">Craft</span>
                          {% endif %}
                        {% elif row.industry == "5" %}
                          {% if session.get('lang', 'en') == 'ar' %}
                            <span class="badge badge-sm bg-primary">الضيافة</span>
                          {% else %}
                            <span class="badge badge-sm bg-primary">Hospitality</span>
                          {% endif %}
                        {% elif row.industry == "6" %}
                          {% if session.get('lang', 'en') == 'ar' %}
                            <span class="badge badge-sm bg-dark">الخدمات</span>
                          {% else %}
                            <span class="badge badge-sm bg-dark">Services</span>
                          {% endif %}
                        {% elif row.industry == "7" %}
                          {% if session.get('lang', 'en') == 'ar' %}
                            <span class="badge badge-sm bg-gradient-info">التجارة</span>
                          {% else %}
                            <span class="badge badge-sm bg-gradient-info">Trade</span>
                          {% endif %}
                        {% endif %}
                      </span>
                    </td>
                    <td class="align-middle">
                      <span class="text-xs font-weight-bold text-dark">{{ row.buz_currency }}</span>
                    </td>
                    <td class="align-middle">
                      <span class="text-xs font-weight-bold text-dark">{{ row.creation_date.strftime('%Y-%m-%d') }}</span>
                      <span class="text-xs text-muted d-block">{{ row.creation_date.strftime('%H:%M') }}</span>
                    </td>
                    <td class="align-middle">
                      {% if row.status == "1" %}
                        {% if session.get('lang', 'en') == 'ar' %}
                          <span class="badge badge-sm bg-gradient-success">جديد</span>
                        {% else %}
                          <span class="badge badge-sm bg-gradient-success">New</span>
                        {% endif %}
                      {% elif row.status == "2" %}
                        {% if session.get('lang', 'en') == 'ar' %}
                          <span class="badge badge-sm bg-gradient-info">قائم</span>
                        {% else %}
                          <span class="badge badge-sm bg-gradient-info">Existing</span>
                        {% endif %}
                      {% else %}
                        {% if session.get('lang', 'en') == 'ar' %}
                          <span class="badge badge-sm bg-gradient-secondary">مسودة</span>
                        {% else %}
                          <span class="badge badge-sm bg-gradient-secondary">Draft</span>
                        {% endif %}
                      {% endif %}
                    </td>
                    <td class="align-middle">
                      <div class="d-flex align-items-center">
                        <span class="me-2 text-xs font-weight-bold">{{ row.completion }}%</span>
                        <div class="progress-wrapper">
                          <div class="progress" style="width: 100px; height: 6px;">
                            {% if row.completion == 100 %}
                            <div class="progress-bar bg-gradient-success" role="progressbar"
                                 style="width: {{ row.completion }}%;"></div>
                            {% elif row.completion >= 50 %}
                            <div class="progress-bar bg-gradient-info" role="progressbar"
                                 style="width: {{ row.completion }}%;"></div>
                            {% else %}
                            <div class="progress-bar bg-gradient-danger" role="progressbar"
                                 style="width: {{ row.completion }}%;"></div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    </td>
                    <td class="align-middle text-center">
                      <div class="btn-group" role="group">
                        <!-- Dashboard Button -->
                        <a href="/dashboard/{{ row.bplan_id }}"
                           class="btn btn-sm btn-outline-primary me-1"
                           data-bs-toggle="tooltip"
                           data-bs-original-title="{% if session.get('lang', 'en') == 'ar' %}لوحة التحكم{% else %}Dashboard{% endif %}">
                          <i class="material-icons text-sm">dashboard</i>
                        </a>
                        <!-- Edit Button -->
                        <a href="/clientprofile/{{ row.bplan_id }}"
                           class="btn btn-sm btn-outline-info me-1"
                           data-bs-toggle="tooltip"
                           data-bs-original-title="{% if session.get('lang', 'en') == 'ar' %}تعديل خطة العمل{% else %}Edit Business Plan{% endif %}">
                          <i class="material-icons text-sm">edit</i>
                        </a>
                        <!-- Delete Button -->
                        <a href="javascript:void(0);"
                           class="btn btn-sm btn-outline-danger delete-bplan"
                           data-bs-toggle="tooltip"
                           data-bs-original-title="{% if session.get('lang', 'en') == 'ar' %}حذف خطة العمل{% else %}Delete Business Plan{% endif %}"
                           data-bplan-id="{{ row.bplan_id }}"
                           data-bplan-name="{{ row.name }}">
                          <i class="material-icons text-sm">delete</i>
                        </a>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<footer class="footer px-3 py-1">
  <div class="container-fluid">
    <div class="row align-items-center justify-content-lg-between">
      <div class="col-lg-6 mb-lg-0 mb-4">
        <div class="copyright text-center text-sm text-muted text-lg-start">
          © <script>document.write(new Date().getFullYear())</script> -
          {% if session.get('lang', 'en') == 'ar' %}
            صنع بـ <i class="fa fa-heart text-danger"></i> من جدوى بلس
          {% else %}
            made with <i class="fa fa-heart text-danger"></i> by JadwaPlan
          {% endif %}
        </div>
      </div>
      <div class="col-lg-6">
        <ul class="nav nav-footer justify-content-center justify-content-lg-end">
          <li class="nav-item">
            <a href="/" class="nav-link text-muted">
              {% if session.get('lang', 'en') == 'ar' %}
                جدوى بلس
              {% else %}
                JadwaPlan
              {% endif %}
            </a>
          </li>
          <li class="nav-item">
            <a href="/" class="nav-link text-muted">
              {% if session.get('lang', 'en') == 'ar' %}
                من نحن
              {% else %}
                About Us
              {% endif %}
            </a>
          </li>
          <li class="nav-item">
            <a href="/" class="nav-link pe-0 text-muted">
              {% if session.get('lang', 'en') == 'ar' %}
                الترخيص
              {% else %}
                License
              {% endif %}
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</footer>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script>
// Initialize datatable
const dataTableSearch = new simpleDatatables.DataTable("#datatable-search", {
  searchable: true,
  fixedHeight: false,
  classes: {
    input: "form-control",
    top: "datatable-top",
    bottom: "datatable-bottom",
  }
});

// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl)
});

// AJAX delete functionality
document.addEventListener('DOMContentLoaded', function() {
  // Add click event to all delete buttons
  document.addEventListener('click', function(e) {
    if (e.target.closest('.delete-bplan')) {
      e.preventDefault();
      const button = e.target.closest('.delete-bplan');
      const bplanId = button.getAttribute('data-bplan-id');
      const bplanName = button.getAttribute('data-bplan-name');

      // Bilingual confirmation message
      const confirmMessage = `{% if session.get('lang', 'en') == 'ar' %}هل أنت متأكد أنك تريد حذف "${bplanName}"؟\nلا يمكن التراجع عن هذا الإجراء.{% else %}Are you sure you want to delete "${bplanName}"?\nThis action cannot be undone.{% endif %}`;

      if (confirm(confirmMessage)) {
        deleteBplan(bplanId, button);
      }
    }
  });

  function deleteBplan(bplanId, button) {
    // Show loading state
    const originalHTML = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
    button.disabled = true;
    button.classList.remove('btn-outline-danger');
    button.classList.add('btn-secondary');

    // Make AJAX request
    fetch(`/index?delete=${bplanId}`, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const row = button.closest('tr');

        // Simple fade out only - no transform or height changes
        row.style.transition = 'opacity 0.3s ease';
        row.style.opacity = '0';

        // Remove the row after fade completes
        setTimeout(() => {
          row.remove();
          showFlashMessage(data.message, 'success');
        }, 300);
      } else {
        showFlashMessage(data.message, 'error');
        resetButton(button, originalHTML);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showFlashMessage('{% if session.get("lang", "en") == "ar" %}خطأ في حذف خطة العمل. يرجى المحاولة مرة أخرى.{% else %}Error deleting business plan. Please try again.{% endif %}', 'error');
      resetButton(button, originalHTML);
    });
  }

  function resetButton(button, originalHTML) {
    button.innerHTML = originalHTML;
    button.disabled = false;
    button.classList.remove('btn-secondary');
    button.classList.add('btn-outline-danger');
  }

  function showFlashMessage(message, type) {
    const icon = type === 'success' ? 'check_circle' : 'error';
    const color = type === 'success' ? '#28a745' : '#dc3545';

    // Bilingual titles
    const title = type === 'success' ?
      '{% if session.get("lang", "en") == "ar" %}نجاح{% else %}Success{% endif %}' :
      '{% if session.get("lang", "en") == "ar" %}خطأ{% else %}Error{% endif %}';

    const toastHTML = `
      <div class="toast-notification alert-${type}" style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        border-left: 4px solid ${color};
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        max-width: 400px;
        z-index: 9999;
        animation: slideInRight 0.3s ease, fadeOut 0.3s ease 4.7s forwards;
      ">
        <i class="material-icons" style="color: ${color}; font-size: 20px;">${icon}</i>
        <div style="flex: 1;">
          <div style="font-weight: 600; font-size: 14px; color: #2d3748; margin-bottom: 2px;">
            ${title}
          </div>
          <div style="font-size: 13px; color: #718096;">${message}</div>
        </div>
        <button type="button" class="btn-close" style="margin-left: 8px;" onclick="this.parentElement.remove()"></button>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', toastHTML);

    // Auto remove after 5 seconds
    setTimeout(() => {
      const toast = document.querySelector('.toast-notification');
      if (toast) {
        toast.remove();
      }
    }, 5000);
  }

  // Add these CSS animations
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }
  `;
  document.head.appendChild(style);
});
</script>

<style>
/* Your existing CSS remains the same */
.table > :not(caption) > * > * {
  padding: 1rem 0.75rem;
  background-color: transparent;
}

.bg-gray-100 {
  background-color: #f8f9fa !important;
}

.avatar {
  transition: all 0.3s ease;
}

.avatar:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.btn-group .btn {
  border-radius: 0.375rem !important;
  margin: 0 1px;
}

.btn-group .btn:first-child {
  border-top-right-radius: 0 !important;
  border-bottom-right-radius: 0 !important;
}

.btn-group .btn:last-child {
  border-top-left-radius: 0 !important;
  border-bottom-left-radius: 0 !important;
}

/* Middle buttons in btn-group */
.btn-group .btn:not(:first-child):not(:last-child) {
  border-radius: 0 !important;
}

.progress {
  border-radius: 10px;
  overflow: hidden;
}

.badge {
  font-size: 0.65em;
  font-weight: 600;
}

.card {
  border: none;
  border-radius: 1rem;
}

.card-header {
  border-radius: 1rem 1rem 0 0 !important;
}

.table > tbody > tr {
  transition: all 0.3s ease;
  cursor: pointer;
}

.table > tbody > tr:hover {
  background-color: #f0f8ff !important;
  transform: translateY(-2px);
  box-shadow:
    0 4px 12px rgba(0,0,0,0.1),
    0 0 0 1px rgba(32, 107, 196, 0.1) !important;
  border-left: 3px solid #206bc4 !important;
}

.table > tbody > tr * {
  transition: color 0.2s ease;
}

.table > tbody > tr:hover .text-dark {
  color: #206bc4 !important;
}

.table > tbody > tr:hover .text-muted {
  color: #6c757d !important;
}

/* Dashboard button specific styling */
.btn-outline-primary {
  border-color: #4F7DF3;
  color: #4F7DF3;
}

.btn-outline-primary:hover {
  background-color: #4F7DF3;
  border-color: #4F7DF3;
  color: white;
}
</style>
{% endblock javascripts %}