{% if session.get('lang', 'en') == 'ar' %}
     {% extends "layouts/base-m-rtl.html" %}
   {% else %}
     {% extends "layouts/base-m.html" %}
   {% endif %}

{% block title %}
  {% if session.get('lang', 'en') == 'ar' %}
    لوحة التحكم - {{ business_name }}
  {% else %}
    Dashboard - {{ business_name }}
  {% endif %}
{% endblock %}

{% block stylesheets %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- CountUp.js for animated numbers -->
<script src="https://cdn.jsdelivr.net/npm/countup.js@2.8.0/dist/countUp.umd.min.js"></script>
<style>
/* ==================== JADWAPLAN ENHANCED DASHBOARD ==================== */
:root {
  --jadwa-blue: #4F7DF3;
  --jadwa-blue-light: #7B9DF5;
  --jadwa-blue-dark: #3D63C9;
  --jadwa-charcoal: #1A1A24;
  --jadwa-gray: #6B6B7A;
  --jadwa-gray-light: #9A9AAA;
  --jadwa-gray-pale: #E5E5EA;
  --jadwa-off-white: #F8F9FC;
  --jadwa-success: #10B981;
  --jadwa-warning: #F59E0B;
  --jadwa-danger: #EF4444;
  --jadwa-purple: #8B5CF6;
  --jadwa-pink: #EC4899;
  --jadwa-cyan: #06B6D4;
  --jadwa-orange: #F97316;
  --jadwa-indigo: #6366F1;
  --jadwa-teal: #14B8A6;
}

* { box-sizing: border-box; }

.dashboard-container {
  background: var(--jadwa-off-white);
  min-height: 100vh;
  padding: 20px;
}

/* Header */
.dashboard-header {
  background: linear-gradient(135deg, var(--jadwa-charcoal) 0%, #2D2D3A 100%);
  border-radius: 16px;
  padding: 24px 32px;
  margin-bottom: 24px;
  color: white;
  position: relative;
  overflow: hidden;
}

.dashboard-header::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -10%;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(79, 125, 243, 0.3) 0%, transparent 70%);
  border-radius: 50%;
}

.dashboard-header::after {
  content: '';
  position: absolute;
  bottom: -30%;
  left: 20%;
  width: 200px;
  height: 200px;
  background: radial-gradient(circle, rgba(139, 92, 246, 0.2) 0%, transparent 70%);
  border-radius: 50%;
}

.dashboard-header h1 {
  font-size: 28px;
  font-weight: 700;
  margin: 0;
  position: relative;
  z-index: 1;
}

.dashboard-header .subtitle {
  color: var(--jadwa-gray-light);
  font-size: 14px;
  margin-top: 4px;
}

.back-button {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  color: white;
  text-decoration: none;
  font-size: 14px;
  opacity: 0.8;
  transition: opacity 0.2s;
  margin-bottom: 12px;
}

.back-button:hover {
  opacity: 1;
  color: white;
}

.header-actions {
  display: flex;
  gap: 12px;
  position: relative;
  z-index: 1;
}

.header-actions .btn {
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  margin-left: 12px;
}

.status-badge.new { background: rgba(16, 185, 129, 0.2); color: #10B981; }
.status-badge.existing { background: rgba(79, 125, 243, 0.2); color: #4F7DF3; }
.status-badge.draft { background: rgba(107, 107, 122, 0.2); color: #9A9AAA; }

/* ==================== HERO KPI CARDS ==================== */
.hero-kpis {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 24px;
}

.hero-kpi {
  background: white;
  border-radius: 16px;
  padding: 24px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0,0,0,0.06);
  border: 1px solid transparent;
  transition: all 0.3s ease;
}

.hero-kpi:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(79, 125, 243, 0.15);
}

.hero-kpi.primary {
  background: linear-gradient(135deg, var(--jadwa-blue) 0%, var(--jadwa-indigo) 100%);
  color: white;
}

.hero-kpi.primary .kpi-label { color: rgba(255,255,255,0.8); }
.hero-kpi.primary .kpi-value { color: white; }
.hero-kpi.primary .sparkline-container { opacity: 0.3; }

.hero-kpi .kpi-icon {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
}

.hero-kpi:not(.primary) .kpi-icon {
  background: var(--jadwa-off-white);
  color: var(--jadwa-blue);
}

.hero-kpi.primary .kpi-icon {
  background: rgba(255,255,255,0.2);
  color: white;
}

.hero-kpi .kpi-label {
  font-size: 12px;
  color: var(--jadwa-gray);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
  margin-bottom: 8px;
}

.hero-kpi .kpi-value {
  font-size: 32px;
  font-weight: 800;
  color: var(--jadwa-charcoal);
  line-height: 1;
}

.hero-kpi .kpi-change {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  font-weight: 600;
  margin-top: 8px;
  padding: 4px 8px;
  border-radius: 6px;
}

.hero-kpi .kpi-change.positive { background: rgba(16, 185, 129, 0.1); color: var(--jadwa-success); }
.hero-kpi .kpi-change.negative { background: rgba(239, 68, 68, 0.1); color: var(--jadwa-danger); }
.hero-kpi .kpi-change.neutral { background: rgba(107, 107, 122, 0.1); color: var(--jadwa-gray); }

.hero-kpi.primary .kpi-change.positive { background: rgba(255,255,255,0.2); color: white; }

.sparkline-container {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 50px;
  opacity: 0.15;
}

/* ==================== SECONDARY KPI GRID ==================== */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

.kpi-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  border: 1px solid var(--jadwa-gray-pale);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.kpi-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(79, 125, 243, 0.12);
  border-color: var(--jadwa-blue-light);
}

.kpi-card .icon-wrapper {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 12px;
  font-size: 20px;
}

.kpi-card .icon-wrapper.blue { background: rgba(79, 125, 243, 0.1); color: var(--jadwa-blue); }
.kpi-card .icon-wrapper.green { background: rgba(16, 185, 129, 0.1); color: var(--jadwa-success); }
.kpi-card .icon-wrapper.orange { background: rgba(245, 158, 11, 0.1); color: var(--jadwa-warning); }
.kpi-card .icon-wrapper.purple { background: rgba(139, 92, 246, 0.1); color: var(--jadwa-purple); }
.kpi-card .icon-wrapper.pink { background: rgba(236, 72, 153, 0.1); color: var(--jadwa-pink); }
.kpi-card .icon-wrapper.cyan { background: rgba(6, 182, 212, 0.1); color: var(--jadwa-cyan); }
.kpi-card .icon-wrapper.teal { background: rgba(20, 184, 166, 0.1); color: var(--jadwa-teal); }
.kpi-card .icon-wrapper.indigo { background: rgba(99, 102, 241, 0.1); color: var(--jadwa-indigo); }

.kpi-card .kpi-label {
  font-size: 11px;
  color: var(--jadwa-gray);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
  margin-bottom: 4px;
}

.kpi-card .kpi-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--jadwa-charcoal);
}

.kpi-card .kpi-subtext {
  font-size: 11px;
  color: var(--jadwa-gray-light);
  margin-top: 4px;
}

/* Progress Ring in KPI */
.progress-ring {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 44px;
  height: 44px;
}

.progress-ring circle {
  fill: none;
  stroke-width: 4;
  stroke-linecap: round;
}

.progress-ring .bg { stroke: var(--jadwa-gray-pale); }
.progress-ring .progress {
  stroke: var(--jadwa-blue);
  transform: rotate(-90deg);
  transform-origin: center;
  transition: stroke-dashoffset 1s ease;
}

/* ==================== SECTION CARDS ==================== */
.section-card {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.04);
  border: 1px solid var(--jadwa-gray-pale);
  margin-bottom: 24px;
  overflow: hidden;
}

.section-card .section-header {
  background: linear-gradient(135deg, var(--jadwa-off-white) 0%, white 100%);
  border-bottom: 1px solid var(--jadwa-gray-pale);
  padding: 18px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.section-card .section-header h3 {
  font-size: 16px;
  font-weight: 700;
  color: var(--jadwa-charcoal);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.section-card .section-header h3 .material-icons {
  color: var(--jadwa-blue);
  font-size: 22px;
}

.section-card .section-header .section-badge {
  background: var(--jadwa-blue);
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

.section-card .section-body {
  padding: 24px;
}

/* Chart Containers */
.chart-container {
  position: relative;
  height: 300px;
  width: 100%;
}

.chart-container.small { height: 220px; }
.chart-container.medium { height: 320px; }
.chart-container.large { height: 400px; }
.chart-container.xlarge { height: 450px; }

/* Grid Layouts */
.chart-grid-2 {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 24px;
}

.chart-grid-3 {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 24px;
}

.chart-grid-2-1 {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 24px;
}

.chart-grid-1-2 {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 24px;
}

/* ==================== SPECIAL CHART STYLES ==================== */

/* Gauge Chart */
.gauge-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
}

.gauge-chart-container {
  position: relative;
  width: 200px;
  height: 120px;
}

.gauge-value-display {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  text-align: center;
}

.gauge-value-display .value {
  font-size: 36px;
  font-weight: 800;
  color: var(--jadwa-charcoal);
}

.gauge-value-display .unit {
  font-size: 14px;
  color: var(--jadwa-gray);
}

.gauge-label {
  margin-top: 12px;
  font-size: 13px;
  color: var(--jadwa-gray);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Radial Progress */
.radial-progress-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
}

.radial-chart {
  position: relative;
  width: 180px;
  height: 180px;
}

.radial-chart canvas {
  position: absolute;
  top: 0;
  left: 0;
}

.radial-center {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

.radial-center .value {
  font-size: 42px;
  font-weight: 800;
  color: var(--jadwa-charcoal);
  line-height: 1;
}

.radial-center .label {
  font-size: 12px;
  color: var(--jadwa-gray);
  margin-top: 4px;
}

/* Mini Stats */
.mini-stats {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid var(--jadwa-gray-pale);
}

.mini-stat {
  flex: 1;
  min-width: 100px;
  text-align: center;
  padding: 12px;
  background: var(--jadwa-off-white);
  border-radius: 10px;
}

.mini-stat .value {
  font-size: 20px;
  font-weight: 700;
  color: var(--jadwa-charcoal);
}

.mini-stat .label {
  font-size: 11px;
  color: var(--jadwa-gray);
  text-transform: uppercase;
  margin-top: 2px;
}

/* Stat Boxes */
.stat-boxes {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

.stat-box {
  background: var(--jadwa-off-white);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  border: 1px solid var(--jadwa-gray-pale);
}

.stat-box .icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 10px;
  font-size: 18px;
}

.stat-box .value {
  font-size: 22px;
  font-weight: 700;
  color: var(--jadwa-charcoal);
}

.stat-box .label {
  font-size: 11px;
  color: var(--jadwa-gray);
  text-transform: uppercase;
}

/* Health Indicators */
.health-indicators {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
}

.health-indicator {
  background: white;
  border-radius: 12px;
  padding: 20px;
  border: 1px solid var(--jadwa-gray-pale);
  text-align: center;
}

.health-indicator .indicator-ring {
  width: 80px;
  height: 80px;
  margin: 0 auto 12px;
  position: relative;
}

.health-indicator .indicator-value {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 20px;
  font-weight: 700;
}

.health-indicator .indicator-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--jadwa-charcoal);
}

.health-indicator .indicator-status {
  font-size: 11px;
  margin-top: 4px;
  padding: 2px 8px;
  border-radius: 4px;
  display: inline-block;
}

.health-indicator .indicator-status.good { background: rgba(16, 185, 129, 0.1); color: var(--jadwa-success); }
.health-indicator .indicator-status.warning { background: rgba(245, 158, 11, 0.1); color: var(--jadwa-warning); }
.health-indicator .indicator-status.danger { background: rgba(239, 68, 68, 0.1); color: var(--jadwa-danger); }

/* Progress Bar List */
.progress-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.progress-item {
  display: flex;
  align-items: center;
  gap: 16px;
}

.progress-item .label {
  width: 120px;
  font-size: 13px;
  font-weight: 600;
  color: var(--jadwa-charcoal);
}

.progress-item .bar-wrapper {
  flex: 1;
  height: 10px;
  background: var(--jadwa-gray-pale);
  border-radius: 5px;
  overflow: hidden;
}

.progress-item .bar {
  height: 100%;
  border-radius: 5px;
  transition: width 1s ease;
}

.progress-item .value {
  width: 50px;
  text-align: right;
  font-size: 13px;
  font-weight: 700;
  color: var(--jadwa-charcoal);
}

/* Legend Grid */
.legend-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-top: 16px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--jadwa-gray);
}

.legend-item .dot {
  width: 10px;
  height: 10px;
  border-radius: 3px;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--jadwa-gray);
}

.empty-state .icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.empty-state .message {
  font-size: 14px;
}

/* Section Divider */
.section-divider {
  height: 4px;
  background: linear-gradient(90deg, var(--jadwa-blue) 0%, var(--jadwa-purple) 50%, var(--jadwa-pink) 100%);
  border-radius: 2px;
  margin: 32px 0;
}

/* ==================== RESPONSIVE ==================== */
@media (max-width: 1400px) {
  .hero-kpis { grid-template-columns: repeat(2, 1fr); }
  .kpi-grid { grid-template-columns: repeat(3, 1fr); }
}

@media (max-width: 992px) {
  .hero-kpis { grid-template-columns: 1fr; }
  .kpi-grid { grid-template-columns: repeat(2, 1fr); }
  .chart-grid-2, .chart-grid-3, .chart-grid-2-1, .chart-grid-1-2 {
    grid-template-columns: 1fr;
  }
  .stat-boxes { grid-template-columns: repeat(2, 1fr); }
  .health-indicators { grid-template-columns: 1fr; }
}

@media (max-width: 576px) {
  .kpi-grid { grid-template-columns: 1fr; }
  .stat-boxes { grid-template-columns: 1fr; }
  .dashboard-container { padding: 12px; }
  .dashboard-header { padding: 16px; }
  .dashboard-header h1 { font-size: 22px; }
  .hero-kpi .kpi-value { font-size: 26px; }
}

/* ==================== RTL SUPPORT ==================== */
[dir="rtl"] .back-button { flex-direction: row-reverse; }
[dir="rtl"] .status-badge { margin-left: 0; margin-right: 12px; }
[dir="rtl"] .hero-kpi .kpi-icon { right: auto; left: 20px; }
[dir="rtl"] .progress-ring { right: auto; left: 16px; }
[dir="rtl"] .progress-item .label { text-align: right; }
[dir="rtl"] .progress-item .value { text-align: left; }

/* Animation */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-in {
  animation: fadeInUp 0.5s ease forwards;
}

.delay-1 { animation-delay: 0.1s; }
.delay-2 { animation-delay: 0.2s; }
.delay-3 { animation-delay: 0.3s; }
.delay-4 { animation-delay: 0.4s; }
</style>
{% endblock stylesheets %}

{% block content %}
{% set lang = session.get('lang', 'en') %}
{% set is_rtl = lang == 'ar' %}

<div class="dashboard-container" dir="{{ 'rtl' if is_rtl else 'ltr' }}">

  <!-- ==================== HEADER ==================== -->
  <div class="dashboard-header">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <a href="/index" class="back-button">
          <span class="material-icons">{{ 'arrow_forward' if is_rtl else 'arrow_back' }}</span>
          {{ 'العودة للقائمة' if is_rtl else 'Back to List' }}
        </a>
        <h1>
          {{ business_name }}
          <span class="status-badge {{ status|lower }}">
            <span class="material-icons" style="font-size: 14px;">
              {% if status|lower == 'new' %}fiber_new{% elif status|lower == 'existing' %}verified{% else %}edit_note{% endif %}
            </span>
            {{ status }}
          </span>
        </h1>
        <div class="subtitle">
          <span class="material-icons" style="font-size: 14px; vertical-align: middle;">business</span>
          {{ industry }} • {{ currency }} • {{ 'تاريخ الإنشاء' if is_rtl else 'Created' }}: {{ created_date }}
        </div>
      </div>
      <div class="header-actions">
        <a href="/clientprofile/{{ bplan_id }}" class="btn btn-outline-light">
          <span class="material-icons">edit</span>
          {{ 'تعديل' if is_rtl else 'Edit' }}
        </a>
        <a href="/export_plan/{{ bplan_id }}" class="btn btn-primary" style="background: var(--jadwa-blue); border-color: var(--jadwa-blue);">
          <span class="material-icons">picture_as_pdf</span>
          {{ 'تصدير PDF' if is_rtl else 'Export PDF' }}
        </a>
      </div>
    </div>
  </div>

  <!-- ==================== HERO KPIs ==================== -->
  <div class="hero-kpis">
    <!-- Completion Progress -->
    <div class="hero-kpi primary animate-in">
      <div class="kpi-icon">
        <span class="material-icons">pie_chart</span>
      </div>
      <div class="kpi-label">{{ 'نسبة الإكمال' if is_rtl else 'Completion' }}</div>
      <div class="kpi-value"><span class="counter" data-target="{{ completion }}">0</span>%</div>
      <div class="kpi-change {% if completion >= 70 %}positive{% elif completion >= 40 %}neutral{% else %}negative{% endif %}">
        <span class="material-icons" style="font-size: 14px;">
          {% if completion >= 70 %}check_circle{% elif completion >= 40 %}info{% else %}warning{% endif %}
        </span>
        {% if completion >= 70 %}{{ 'شبه مكتمل' if is_rtl else 'Almost Complete' }}{% elif completion >= 40 %}{{ 'قيد التقدم' if is_rtl else 'In Progress' }}{% else %}{{ 'يحتاج عمل' if is_rtl else 'Needs Work' }}{% endif %}
      </div>
      <div class="sparkline-container">
        <canvas id="completionSparkline"></canvas>
      </div>
    </div>

    <!-- Fund Requested -->
    <div class="hero-kpi animate-in delay-1">
      <div class="kpi-icon">
        <span class="material-icons">account_balance</span>
      </div>
      <div class="kpi-label">{{ 'التمويل المطلوب' if is_rtl else 'Fund Requested' }}</div>
      <div class="kpi-value">{{ currency }} <span class="counter" data-target="{{ kpis.total_fund|int }}">0</span></div>
      <div class="kpi-change neutral">
        <span class="material-icons" style="font-size: 14px;">inventory</span>
        {{ 'إجمالي الاستثمار' if is_rtl else 'Total Investment' }}
      </div>
    </div>

    <!-- Year 5 Revenue -->
    <div class="hero-kpi animate-in delay-2">
      <div class="kpi-icon">
        <span class="material-icons">trending_up</span>
      </div>
      <div class="kpi-label">{{ 'إيرادات السنة 5' if is_rtl else 'Year 5 Revenue' }}</div>
      <div class="kpi-value">{{ currency }} <span class="counter" data-target="{{ kpis.year5_revenue|int }}">0</span></div>
      <div class="kpi-change {% if kpis.revenue_growth > 0 %}positive{% else %}negative{% endif %}">
        <span class="material-icons" style="font-size: 14px;">{{ 'arrow_upward' if kpis.revenue_growth > 0 else 'arrow_downward' }}</span>
        {{ kpis.revenue_growth }}% {{ 'نمو' if is_rtl else 'Growth' }}
      </div>
    </div>

    <!-- Year 5 Profit -->
    <div class="hero-kpi animate-in delay-3">
      <div class="kpi-icon">
        <span class="material-icons">savings</span>
      </div>
      <div class="kpi-label">{{ 'أرباح السنة 5' if is_rtl else 'Year 5 Profit' }}</div>
      <div class="kpi-value">{{ currency }} <span class="counter" data-target="{{ kpis.year5_profit|int }}">0</span></div>
      <div class="kpi-change {% if kpis.year5_margin > 15 %}positive{% elif kpis.year5_margin > 5 %}neutral{% else %}negative{% endif %}">
        <span class="material-icons" style="font-size: 14px;">percent</span>
        {{ kpis.year5_margin }}% {{ 'هامش' if is_rtl else 'Margin' }}
      </div>
    </div>
  </div>

  <!-- ==================== SECONDARY KPIs ==================== -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="icon-wrapper blue"><span class="material-icons">groups</span></div>
      <div class="kpi-label">{{ 'الموظفين' if is_rtl else 'Staff' }}</div>
      <div class="kpi-value">{{ kpis.staff_count }}</div>
      <div class="kpi-subtext">{{ kpis.fulltime_count }} {{ 'دوام كامل' if is_rtl else 'FT' }} / {{ kpis.parttime_count }} {{ 'جزئي' if is_rtl else 'PT' }}</div>
    </div>

    <div class="kpi-card">
      <div class="icon-wrapper green"><span class="material-icons">workspace_premium</span></div>
      <div class="kpi-label">{{ 'سنوات الخبرة' if is_rtl else 'Experience' }}</div>
      <div class="kpi-value">{{ kpis.total_experience }} {{ 'سنة' if is_rtl else 'yrs' }}</div>
      <div class="kpi-subtext">{{ kpis.experience_fields }} {{ 'مجالات' if is_rtl else 'fields' }}</div>
    </div>

    <div class="kpi-card">
      <div class="icon-wrapper purple"><span class="material-icons">handshake</span></div>
      <div class="kpi-label">{{ 'الموردين' if is_rtl else 'Suppliers' }}</div>
      <div class="kpi-value">{{ kpis.suppliers_count }}</div>
      <div class="kpi-subtext">{{ kpis.total_products }} {{ 'منتجات' if is_rtl else 'products' }}</div>
    </div>

    <div class="kpi-card">
      <div class="icon-wrapper cyan"><span class="material-icons">local_shipping</span></div>
      <div class="kpi-label">{{ 'قنوات التوزيع' if is_rtl else 'Distribution' }}</div>
      <div class="kpi-value">{{ kpis.distribution_count }}</div>
      <div class="kpi-subtext">{{ 'قنوات' if is_rtl else 'channels' }}</div>
    </div>

    <div class="kpi-card">
      <div class="icon-wrapper orange"><span class="material-icons">donut_large</span></div>
      <div class="kpi-label">{{ 'شرائح السوق' if is_rtl else 'Segments' }}</div>
      <div class="kpi-value">{{ kpis.segments_count }}</div>
      <div class="kpi-subtext">{{ 'شريحة عملاء' if is_rtl else 'market segments' }}</div>
    </div>

    <div class="kpi-card">
      <svg class="progress-ring" viewBox="0 0 44 44">
        <circle class="bg" cx="22" cy="22" r="18"></circle>
        <circle class="progress" cx="22" cy="22" r="18"
                stroke-dasharray="113"
                stroke-dashoffset="{{ 113 - (113 * kpis.capacity_utilization / 100) }}"></circle>
      </svg>
      <div class="icon-wrapper teal"><span class="material-icons">speed</span></div>
      <div class="kpi-label">{{ 'الطاقة الإنتاجية' if is_rtl else 'Capacity' }}</div>
      <div class="kpi-value">{{ kpis.capacity_utilization|round(0)|int }}%</div>
      <div class="kpi-subtext">{{ 'استخدام' if is_rtl else 'utilization' }}</div>
    </div>
  </div>

  <!-- ==================== FINANCIAL PROJECTIONS ==================== -->
  <div class="section-card">
    <div class="section-header">
      <h3>
        <span class="material-icons">insights</span>
        {{ 'التوقعات المالية' if is_rtl else 'Financial Projections' }}
      </h3>
      <span class="section-badge">{{ 'خمس سنوات' if is_rtl else '5 Years' }}</span>
    </div>
    <div class="section-body">
      <div class="chart-grid-2-1">
        <!-- Main Projections Chart -->
        <div>
          <div class="chart-container large">
            <canvas id="projectionsChart"></canvas>
          </div>
        </div>

        <!-- Profit Margin & Growth -->
        <div>
          <div class="chart-container" style="height: 200px;">
            <canvas id="marginChart"></canvas>
          </div>
          <div class="mini-stats" style="border-top: none; margin-top: 24px;">
            <div class="mini-stat">
              <div class="value" style="color: var(--jadwa-success);">{{ currency }} {{ '{:,.0f}'.format(kpis.year1_revenue) }}</div>
              <div class="label">{{ 'إيراد السنة 1' if is_rtl else 'Y1 Revenue' }}</div>
            </div>
            <div class="mini-stat">
              <div class="value" style="color: var(--jadwa-blue);">{{ currency }} {{ '{:,.0f}'.format(kpis.year5_revenue) }}</div>
              <div class="label">{{ 'إيراد السنة 5' if is_rtl else 'Y5 Revenue' }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== BUSINESS HEALTH INDICATORS ==================== -->
  <div class="section-card">
    <div class="section-header">
      <h3>
        <span class="material-icons">health_and_safety</span>
        {{ 'مؤشرات صحة الأعمال' if is_rtl else 'Business Health Indicators' }}
      </h3>
    </div>
    <div class="section-body">
      <div class="health-indicators">
        <!-- Profitability -->
        <div class="health-indicator">
          <div class="indicator-ring">
            <canvas id="profitabilityGauge" width="80" height="80"></canvas>
            <div class="indicator-value" style="color: {% if kpis.year5_margin > 15 %}var(--jadwa-success){% elif kpis.year5_margin > 5 %}var(--jadwa-warning){% else %}var(--jadwa-danger){% endif %};">
              {{ kpis.year5_margin|round(0)|int }}%
            </div>
          </div>
          <div class="indicator-label">{{ 'الربحية' if is_rtl else 'Profitability' }}</div>
          <div class="indicator-status {% if kpis.year5_margin > 15 %}good{% elif kpis.year5_margin > 5 %}warning{% else %}danger{% endif %}">
            {% if kpis.year5_margin > 15 %}{{ 'ممتاز' if is_rtl else 'Excellent' }}{% elif kpis.year5_margin > 5 %}{{ 'جيد' if is_rtl else 'Good' }}{% else %}{{ 'يحتاج تحسين' if is_rtl else 'Needs Improvement' }}{% endif %}
          </div>
        </div>

        <!-- Growth Rate -->
        <div class="health-indicator">
          <div class="indicator-ring">
            <canvas id="growthGauge" width="80" height="80"></canvas>
            <div class="indicator-value" style="color: {% if kpis.revenue_growth > 50 %}var(--jadwa-success){% elif kpis.revenue_growth > 20 %}var(--jadwa-warning){% else %}var(--jadwa-danger){% endif %};">
              {{ kpis.revenue_growth|round(0)|int }}%
            </div>
          </div>
          <div class="indicator-label">{{ 'معدل النمو' if is_rtl else 'Growth Rate' }}</div>
          <div class="indicator-status {% if kpis.revenue_growth > 50 %}good{% elif kpis.revenue_growth > 20 %}warning{% else %}danger{% endif %}">
            {% if kpis.revenue_growth > 50 %}{{ 'عالي' if is_rtl else 'High' }}{% elif kpis.revenue_growth > 20 %}{{ 'متوسط' if is_rtl else 'Moderate' }}{% else %}{{ 'منخفض' if is_rtl else 'Low' }}{% endif %}
          </div>
        </div>

        <!-- Plan Completion -->
        <div class="health-indicator">
          <div class="indicator-ring">
            <canvas id="completionGauge" width="80" height="80"></canvas>
            <div class="indicator-value" style="color: {% if completion >= 80 %}var(--jadwa-success){% elif completion >= 50 %}var(--jadwa-warning){% else %}var(--jadwa-danger){% endif %};">
              {{ completion }}%
            </div>
          </div>
          <div class="indicator-label">{{ 'اكتمال الخطة' if is_rtl else 'Plan Completion' }}</div>
          <div class="indicator-status {% if completion >= 80 %}good{% elif completion >= 50 %}warning{% else %}danger{% endif %}">
            {% if completion >= 80 %}{{ 'مكتمل' if is_rtl else 'Complete' }}{% elif completion >= 50 %}{{ 'قيد التقدم' if is_rtl else 'In Progress' }}{% else %}{{ 'مبكر' if is_rtl else 'Early Stage' }}{% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="section-divider"></div>

  <!-- ==================== CLIENT & OWNERSHIP ==================== -->
  <div class="chart-grid-2">
    <!-- Experience Chart -->
    <div class="section-card">
      <div class="section-header">
        <h3>
          <span class="material-icons">school</span>
          {{ 'الخبرات المهنية' if is_rtl else 'Professional Experience' }}
        </h3>
        <span class="section-badge">{{ kpis.total_experience }} {{ 'سنة' if is_rtl else 'Years' }}</span>
      </div>
      <div class="section-body">
        {% if charts.experiences %}
        <div class="chart-container medium">
          <canvas id="experienceChart"></canvas>
        </div>
        {% else %}
        <div class="empty-state">
          <span class="material-icons icon">work_history</span>
          <p class="message">{{ 'لا توجد خبرات مسجلة' if is_rtl else 'No experience records found' }}</p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Ownership Chart -->
    <div class="section-card">
      <div class="section-header">
        <h3>
          <span class="material-icons">pie_chart</span>
          {{ 'هيكل الملكية' if is_rtl else 'Ownership Structure' }}
        </h3>
      </div>
      <div class="section-body">
        {% if charts.ownership %}
        <div class="chart-container medium">
          <canvas id="ownershipChart"></canvas>
        </div>
        <div class="legend-grid">
          {% for owner in charts.ownership %}
          <div class="legend-item">
            <span class="dot" style="background: {% if loop.index == 1 %}var(--jadwa-blue){% elif loop.index == 2 %}var(--jadwa-purple){% elif loop.index == 3 %}var(--jadwa-cyan){% else %}var(--jadwa-pink){% endif %};"></span>
            {{ owner.name }}: {{ owner.shares }}%
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
          <span class="material-icons icon">group</span>
          <p class="message">{{ 'لم يتم تحديد الملكية' if is_rtl else 'Ownership not defined' }}</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ==================== EXPENSES & STAFF ==================== -->
  <div class="chart-grid-2">
    <!-- Living Expenses -->
    <div class="section-card">
      <div class="section-header">
        <h3>
          <span class="material-icons">receipt_long</span>
          {{ 'المصاريف الشخصية' if is_rtl else 'Living Expenses' }}
        </h3>
        <span class="section-badge">{{ currency }} {{ '{:,.0f}'.format(kpis.monthly_expenses) }}/{{ 'شهر' if is_rtl else 'mo' }}</span>
      </div>
      <div class="section-body">
        {% if charts.expenses %}
        <div class="chart-container medium">
          <canvas id="expensesChart"></canvas>
        </div>
        {% else %}
        <div class="empty-state">
          <span class="material-icons icon">money_off</span>
          <p class="message">{{ 'لا توجد مصاريف مسجلة' if is_rtl else 'No expenses recorded' }}</p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Staff Salary Distribution -->
    <div class="section-card">
      <div class="section-header">
        <h3>
          <span class="material-icons">badge</span>
          {{ 'توزيع الرواتب' if is_rtl else 'Salary Distribution' }}
        </h3>
        <span class="section-badge">{{ kpis.staff_count }} {{ 'موظف' if is_rtl else 'Staff' }}</span>
      </div>
      <div class="section-body">
        {% if charts.staff %}
        <div class="chart-container medium">
          <canvas id="staffChart"></canvas>
        </div>
        {% else %}
        <div class="empty-state">
          <span class="material-icons icon">person_off</span>
          <p class="message">{{ 'لا يوجد موظفين' if is_rtl else 'No staff recorded' }}</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="section-divider"></div>

  <!-- ==================== MARKET ANALYSIS ==================== -->
  <div class="section-card">
    <div class="section-header">
      <h3>
        <span class="material-icons">analytics</span>
        {{ 'تحليل السوق' if is_rtl else 'Market Analysis' }}
      </h3>
    </div>
    <div class="section-body">
      <div class="chart-grid-2">
        <!-- Market Segments -->
        <div>
          <h5 style="margin-bottom: 16px; color: var(--jadwa-charcoal); font-weight: 600;">
            <span class="material-icons" style="font-size: 18px; vertical-align: middle; color: var(--jadwa-purple);">donut_small</span>
            {{ 'شرائح السوق' if is_rtl else 'Market Segments' }}
          </h5>
          {% if charts.segments %}
          <div class="chart-container small">
            <canvas id="segmentsChart"></canvas>
          </div>
          {% else %}
          <div class="empty-state">
            <span class="material-icons icon">pie_chart_outline</span>
            <p class="message">{{ 'لم يتم تحديد شرائح السوق' if is_rtl else 'No market segments defined' }}</p>
          </div>
          {% endif %}
        </div>

        <!-- Competitive Analysis -->
        <div>
          <h5 style="margin-bottom: 16px; color: var(--jadwa-charcoal); font-weight: 600;">
            <span class="material-icons" style="font-size: 18px; vertical-align: middle; color: var(--jadwa-orange);">compare</span>
            {{ 'التحليل التنافسي' if is_rtl else 'Competitive Analysis' }}
          </h5>
          {% if charts.competitive.labels %}
          <div class="chart-container medium">
            <canvas id="competitiveChart"></canvas>
          </div>
          {% else %}
          <div class="empty-state">
            <span class="material-icons icon">leaderboard</span>
            <p class="message">{{ 'لم يتم تحديد المنافسين' if is_rtl else 'No competitive data available' }}</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== OPERATIONS ==================== -->
  <div class="section-card">
    <div class="section-header">
      <h3>
        <span class="material-icons">precision_manufacturing</span>
        {{ 'العمليات' if is_rtl else 'Operations' }}
      </h3>
    </div>
    <div class="section-body">
      <div class="chart-grid-3">
        <!-- Supplier Radar -->
        <div>
          <h5 style="margin-bottom: 16px; color: var(--jadwa-charcoal); font-weight: 600;">
            <span class="material-icons" style="font-size: 18px; vertical-align: middle; color: var(--jadwa-teal);">radar</span>
            {{ 'تقييم الموردين' if is_rtl else 'Supplier Evaluation' }}
          </h5>
          {% if charts.suppliers %}
          <div class="chart-container small">
            <canvas id="supplierRadar"></canvas>
          </div>
          {% else %}
          <div class="empty-state">
            <span class="material-icons icon">inventory_2</span>
            <p class="message">{{ 'لا يوجد موردين' if is_rtl else 'No suppliers recorded' }}</p>
          </div>
          {% endif %}
        </div>

        <!-- Capacity Gauge -->
        <div>
          <h5 style="margin-bottom: 16px; color: var(--jadwa-charcoal); font-weight: 600;">
            <span class="material-icons" style="font-size: 18px; vertical-align: middle; color: var(--jadwa-blue);">speed</span>
            {{ 'الطاقة الإنتاجية' if is_rtl else 'Production Capacity' }}
          </h5>
          <div class="gauge-wrapper">
            <div class="gauge-chart-container">
              <canvas id="capacityGauge"></canvas>
              <div class="gauge-value-display">
                <div class="value">{{ kpis.capacity_utilization|round(0)|int }}%</div>
              </div>
            </div>
            <div class="gauge-label">{{ 'نسبة الاستخدام' if is_rtl else 'Utilization Rate' }}</div>
          </div>
          <div class="mini-stats" style="border: none; padding: 0; margin-top: 0;">
            <div class="mini-stat">
              <div class="value">{{ kpis.current_capacity|round(0)|int }}</div>
              <div class="label">{{ 'الحالية' if is_rtl else 'Current' }}</div>
            </div>
            <div class="mini-stat">
              <div class="value">{{ kpis.max_capacity|round(0)|int }}</div>
              <div class="label">{{ 'القصوى' if is_rtl else 'Maximum' }}</div>
            </div>
          </div>
        </div>

        <!-- Resources Breakdown -->
        <div>
          <h5 style="margin-bottom: 16px; color: var(--jadwa-charcoal); font-weight: 600;">
            <span class="material-icons" style="font-size: 18px; vertical-align: middle; color: var(--jadwa-pink);">category</span>
            {{ 'الموارد' if is_rtl else 'Resources' }}
          </h5>
          {% if charts.resources %}
          <div class="chart-container small">
            <canvas id="resourcesChart"></canvas>
          </div>
          {% else %}
          <div class="empty-state">
            <span class="material-icons icon">token</span>
            <p class="message">{{ 'لا توجد موارد' if is_rtl else 'No resources recorded' }}</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== FUND ALLOCATION ==================== -->
  <div class="section-card">
    <div class="section-header">
      <h3>
        <span class="material-icons">account_balance_wallet</span>
        {{ 'توزيع التمويل' if is_rtl else 'Fund Allocation' }}
      </h3>
      <span class="section-badge">{{ currency }} {{ '{:,.0f}'.format(kpis.total_fund) }}</span>
    </div>
    <div class="section-body">
      <div class="chart-grid-2">
        <!-- Fund Distribution Donut -->
        <div>
          {% if charts.fund %}
          <div class="chart-container medium">
            <canvas id="fundChart"></canvas>
          </div>
          {% else %}
          <div class="empty-state">
            <span class="material-icons icon">account_balance</span>
            <p class="message">{{ 'لم يتم تحديد التمويل' if is_rtl else 'No fund allocation defined' }}</p>
          </div>
          {% endif %}
        </div>

        <!-- Fund Breakdown Progress Bars -->
        <div>
          <div class="progress-list">
            {% set fund_colors = ['#4F7DF3', '#8B5CF6', '#EC4899', '#F59E0B', '#10B981'] %}
            {% set total = kpis.total_fund if kpis.total_fund > 0 else 1 %}
            {% for item in charts.fund %}
            <div class="progress-item">
              <div class="label">{{ item.category }}</div>
              <div class="bar-wrapper">
                <div class="bar" style="width: {{ (item.value / total * 100)|round(1) }}%; background: {{ fund_colors[loop.index0 % 5] }};"></div>
              </div>
              <div class="value">{{ '{:,.0f}'.format(item.value) }}</div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== FINANCIAL HISTORY ==================== -->
  {% if charts.financial_history %}
  <div class="section-card">
    <div class="section-header">
      <h3>
        <span class="material-icons">history</span>
        {{ 'التاريخ المالي' if is_rtl else 'Financial History' }}
      </h3>
    </div>
    <div class="section-body">
      <div class="chart-container medium">
        <canvas id="historyChart"></canvas>
      </div>
    </div>
  </div>
  {% endif %}

</div>

{% endblock content %}

{% block javascripts %}
<script>
// ==================== CHART.JS CONFIGURATION ====================
const currency = '{{ currency }}';
const isRTL = {{ 'true' if session.get('lang', 'en') == 'ar' else 'false' }};

// Color Palette
const colors = {
  blue: '#4F7DF3',
  blueLight: 'rgba(79, 125, 243, 0.2)',
  purple: '#8B5CF6',
  purpleLight: 'rgba(139, 92, 246, 0.2)',
  pink: '#EC4899',
  pinkLight: 'rgba(236, 72, 153, 0.2)',
  cyan: '#06B6D4',
  cyanLight: 'rgba(6, 182, 212, 0.2)',
  teal: '#14B8A6',
  tealLight: 'rgba(20, 184, 166, 0.2)',
  orange: '#F59E0B',
  orangeLight: 'rgba(245, 158, 11, 0.2)',
  green: '#10B981',
  greenLight: 'rgba(16, 185, 129, 0.2)',
  red: '#EF4444',
  redLight: 'rgba(239, 68, 68, 0.2)',
  gray: '#6B6B7A',
  grayPale: '#E5E5EA',
  charcoal: '#1A1A24'
};

// Chart.js Defaults
Chart.defaults.font.family = "'Helvetica Neue', 'Arial', sans-serif";
Chart.defaults.color = colors.gray;
Chart.defaults.plugins.legend.position = 'bottom';
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.padding = 20;

// Format currency
function formatCurrency(value) {
  if (value >= 1000000) return currency + ' ' + (value / 1000000).toFixed(1) + 'M';
  if (value >= 1000) return currency + ' ' + (value / 1000).toFixed(1) + 'K';
  return currency + ' ' + value.toLocaleString();
}

// ==================== ANIMATED COUNTERS ====================
document.addEventListener('DOMContentLoaded', function() {
  const counters = document.querySelectorAll('.counter');
  counters.forEach(counter => {
    const target = parseFloat(counter.dataset.target) || 0;
    const duration = 2000;
    const start = 0;
    const startTime = performance.now();

    function updateCounter(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const easeOut = 1 - Math.pow(1 - progress, 3);
      const current = Math.floor(easeOut * target);

      if (target >= 1000) {
        counter.textContent = current.toLocaleString();
      } else {
        counter.textContent = current;
      }

      if (progress < 1) {
        requestAnimationFrame(updateCounter);
      }
    }

    requestAnimationFrame(updateCounter);
  });
});

// ==================== PROJECTIONS CHART ====================
const projectionsData = {{ charts.projections | tojson }};

if (projectionsData.years && projectionsData.years.length > 0) {
  new Chart(document.getElementById('projectionsChart'), {
    type: 'line',
    data: {
      labels: projectionsData.years,
      datasets: [
        {
          label: isRTL ? 'الإيرادات' : 'Revenue',
          data: projectionsData.revenue,
          borderColor: colors.green,
          backgroundColor: colors.greenLight,
          fill: true,
          tension: 0.4,
          borderWidth: 3,
          pointRadius: 5,
          pointHoverRadius: 8
        },
        {
          label: isRTL ? 'التكاليف' : 'Costs',
          data: projectionsData.costs,
          borderColor: colors.orange,
          backgroundColor: colors.orangeLight,
          fill: true,
          tension: 0.4,
          borderWidth: 3,
          pointRadius: 5,
          pointHoverRadius: 8
        },
        {
          label: isRTL ? 'الأرباح' : 'Profit',
          data: projectionsData.profit,
          borderColor: colors.blue,
          backgroundColor: colors.blueLight,
          fill: true,
          tension: 0.4,
          borderWidth: 3,
          pointRadius: 5,
          pointHoverRadius: 8
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      plugins: {
        legend: {
          position: 'top'
        },
        tooltip: {
          backgroundColor: 'white',
          titleColor: colors.charcoal,
          bodyColor: colors.gray,
          borderColor: colors.grayPale,
          borderWidth: 1,
          padding: 12,
          displayColors: true,
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + formatCurrency(context.raw);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: colors.grayPale },
          ticks: {
            callback: function(value) {
              return formatCurrency(value);
            }
          }
        },
        x: {
          grid: { display: false }
        }
      }
    }
  });
}

// ==================== MARGIN CHART (Area) ====================
if (projectionsData.margin && projectionsData.margin.length > 0) {
  new Chart(document.getElementById('marginChart'), {
    type: 'line',
    data: {
      labels: projectionsData.years,
      datasets: [{
        label: isRTL ? 'هامش الربح %' : 'Profit Margin %',
        data: projectionsData.margin,
        borderColor: colors.purple,
        backgroundColor: 'rgba(139, 92, 246, 0.3)',
        fill: true,
        tension: 0.4,
        borderWidth: 3,
        pointRadius: 4,
        pointBackgroundColor: colors.purple
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'white',
          titleColor: colors.charcoal,
          bodyColor: colors.gray,
          borderColor: colors.grayPale,
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              return context.raw.toFixed(1) + '%';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: colors.grayPale },
          ticks: {
            callback: function(value) { return value + '%'; }
          }
        },
        x: { grid: { display: false } }
      }
    }
  });
}

// ==================== HEALTH INDICATOR GAUGES ====================
function drawMiniGauge(canvasId, value, maxValue, color) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  const radius = Math.min(centerX, centerY) - 5;

  // Background arc
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
  ctx.strokeStyle = colors.grayPale;
  ctx.lineWidth = 8;
  ctx.stroke();

  // Value arc
  const percentage = Math.min(value / maxValue, 1);
  const endAngle = -0.5 * Math.PI + (percentage * 2 * Math.PI);

  ctx.beginPath();
  ctx.arc(centerX, centerY, radius, -0.5 * Math.PI, endAngle);
  ctx.strokeStyle = color;
  ctx.lineWidth = 8;
  ctx.lineCap = 'round';
  ctx.stroke();
}

// Draw health gauges
drawMiniGauge('profitabilityGauge', {{ kpis.year5_margin }}, 30, '{% if kpis.year5_margin > 15 %}#10B981{% elif kpis.year5_margin > 5 %}#F59E0B{% else %}#EF4444{% endif %}');
drawMiniGauge('growthGauge', {{ kpis.revenue_growth }}, 100, '{% if kpis.revenue_growth > 50 %}#10B981{% elif kpis.revenue_growth > 20 %}#F59E0B{% else %}#EF4444{% endif %}');
drawMiniGauge('completionGauge', {{ completion }}, 100, '{% if completion >= 80 %}#10B981{% elif completion >= 50 %}#F59E0B{% else %}#EF4444{% endif %}');

// ==================== EXPERIENCE CHART (Horizontal Bar) ====================
const experienceData = {{ charts.experiences | tojson }};

if (experienceData && experienceData.length > 0) {
  new Chart(document.getElementById('experienceChart'), {
    type: 'bar',
    data: {
      labels: experienceData.map(e => e.field),
      datasets: [{
        label: isRTL ? 'سنوات' : 'Years',
        data: experienceData.map(e => e.years),
        backgroundColor: [colors.blue, colors.purple, colors.cyan, colors.teal, colors.pink],
        borderRadius: 8,
        borderSkipped: false
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'white',
          titleColor: colors.charcoal,
          bodyColor: colors.gray,
          borderColor: colors.grayPale,
          borderWidth: 1,
          callbacks: {
            afterLabel: function(context) {
              return experienceData[context.dataIndex].workplace;
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          grid: { color: colors.grayPale },
          ticks: {
            callback: function(value) { return value + (isRTL ? ' سنة' : ' yrs'); }
          }
        },
        y: { grid: { display: false } }
      }
    }
  });
}

// ==================== OWNERSHIP CHART (Doughnut) ====================
const ownershipData = {{ charts.ownership | tojson }};

if (ownershipData && ownershipData.length > 0) {
  new Chart(document.getElementById('ownershipChart'), {
    type: 'doughnut',
    data: {
      labels: ownershipData.map(o => o.name),
      datasets: [{
        data: ownershipData.map(o => o.shares),
        backgroundColor: [colors.blue, colors.purple, colors.cyan, colors.pink, colors.teal],
        borderWidth: 0,
        hoverOffset: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'white',
          titleColor: colors.charcoal,
          bodyColor: colors.gray,
          borderColor: colors.grayPale,
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              return context.label + ': ' + context.raw + '%';
            }
          }
        }
      }
    }
  });
}

// ==================== EXPENSES CHART (Polar Area) ====================
const expensesData = {{ charts.expenses | tojson }};

if (expensesData && expensesData.length > 0) {
  new Chart(document.getElementById('expensesChart'), {
    type: 'polarArea',
    data: {
      labels: expensesData.map(e => e.type),
      datasets: [{
        data: expensesData.map(e => e.value),
        backgroundColor: [
          'rgba(79, 125, 243, 0.7)',
          'rgba(139, 92, 246, 0.7)',
          'rgba(236, 72, 153, 0.7)',
          'rgba(6, 182, 212, 0.7)',
          'rgba(245, 158, 11, 0.7)',
          'rgba(16, 185, 129, 0.7)'
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right' },
        tooltip: {
          backgroundColor: 'white',
          titleColor: colors.charcoal,
          bodyColor: colors.gray,
          borderColor: colors.grayPale,
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              return context.label + ': ' + formatCurrency(context.raw);
            }
          }
        }
      }
    }
  });
}

// ==================== STAFF CHART (Doughnut) ====================
const staffData = {{ charts.staff | tojson }};

if (staffData && staffData.length > 0) {
  new Chart(document.getElementById('staffChart'), {
    type: 'doughnut',
    data: {
      labels: staffData.map(s => s.position),
      datasets: [{
        data: staffData.map(s => s.salary),
        backgroundColor: [colors.blue, colors.purple, colors.pink, colors.cyan, colors.teal, colors.orange],
        borderWidth: 3,
        borderColor: 'white',
        hoverOffset: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '55%',
      plugins: {
        legend: { position: 'right' },
        tooltip: {
          backgroundColor: 'white',
          titleColor: colors.charcoal,
          bodyColor: colors.gray,
          borderColor: colors.grayPale,
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              return context.label + ': ' + formatCurrency(context.raw);
            }
          }
        }
      }
    }
  });
}

// ==================== SEGMENTS CHART (Pie) ====================
const segmentsData = {{ charts.segments | tojson }};

if (segmentsData && segmentsData.length > 0) {
  new Chart(document.getElementById('segmentsChart'), {
    type: 'pie',
    data: {
      labels: segmentsData.map(s => s.name),
      datasets: [{
        data: segmentsData.map(s => s.percentage),
        backgroundColor: [colors.purple, colors.blue, colors.pink, colors.cyan, colors.teal],
        borderWidth: 3,
        borderColor: 'white',
        hoverOffset: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right' },
        tooltip: {
          backgroundColor: 'white',
          titleColor: colors.charcoal,
          bodyColor: colors.gray,
          borderColor: colors.grayPale,
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              return context.label + ': ' + context.raw + '%';
            }
          }
        }
      }
    }
  });
}

// ==================== COMPETITIVE CHART (Radar) ====================
const competitiveData = {{ charts.competitive | tojson }};

if (competitiveData.labels && competitiveData.labels.length > 0) {
  new Chart(document.getElementById('competitiveChart'), {
    type: 'radar',
    data: {
      labels: competitiveData.labels,
      datasets: [
        {
          label: competitiveData.names.business,
          data: competitiveData.business,
          borderColor: colors.blue,
          backgroundColor: 'rgba(79, 125, 243, 0.2)',
          borderWidth: 3,
          pointRadius: 4
        },
        {
          label: competitiveData.names.comp1,
          data: competitiveData.comp1,
          borderColor: colors.orange,
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          borderWidth: 2,
          pointRadius: 3
        },
        {
          label: competitiveData.names.comp2,
          data: competitiveData.comp2,
          borderColor: colors.purple,
          backgroundColor: 'rgba(139, 92, 246, 0.1)',
          borderWidth: 2,
          pointRadius: 3
        },
        {
          label: competitiveData.names.comp3,
          data: competitiveData.comp3,
          borderColor: colors.pink,
          backgroundColor: 'rgba(236, 72, 153, 0.1)',
          borderWidth: 2,
          pointRadius: 3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' }
      },
      scales: {
        r: {
          beginAtZero: true,
          max: 5,
          ticks: { stepSize: 1 },
          grid: { color: colors.grayPale },
          pointLabels: { font: { size: 11 } }
        }
      }
    }
  });
}

// ==================== SUPPLIER RADAR ====================
const supplierData = {{ charts.suppliers | tojson }};

if (supplierData && supplierData.length > 0) {
  const supplierColors = [colors.blue, colors.purple, colors.cyan, colors.pink];

  new Chart(document.getElementById('supplierRadar'), {
    type: 'radar',
    data: {
      labels: [isRTL ? 'الجودة' : 'Quality', isRTL ? 'سنوات التعاون' : 'Years', isRTL ? 'السعر' : 'Price', isRTL ? 'الاتساق' : 'Consistency'],
      datasets: supplierData.map((s, i) => ({
        label: s.name,
        data: [s.quality, s.years, s.price, s.consistency],
        borderColor: supplierColors[i % 4],
        backgroundColor: supplierColors[i % 4].replace(')', ', 0.1)').replace('rgb', 'rgba'),
        borderWidth: 2,
        pointRadius: 4
      }))
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' }
      },
      scales: {
        r: {
          beginAtZero: true,
          max: 5,
          ticks: { stepSize: 1 },
          grid: { color: colors.grayPale }
        }
      }
    }
  });
}

// ==================== CAPACITY GAUGE ====================
new Chart(document.getElementById('capacityGauge'), {
  type: 'doughnut',
  data: {
    datasets: [{
      data: [{{ kpis.capacity_utilization }}, {{ 100 - kpis.capacity_utilization }}],
      backgroundColor: [
        '{% if kpis.capacity_utilization > 80 %}' + colors.green + '{% elif kpis.capacity_utilization > 50 %}' + colors.blue + '{% else %}' + colors.orange + '{% endif %}',
        colors.grayPale
      ],
      borderWidth: 0,
      circumference: 180,
      rotation: 270
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    cutout: '75%',
    plugins: {
      legend: { display: false },
      tooltip: { enabled: false }
    }
  }
});

// ==================== RESOURCES CHART (Horizontal Bar) ====================
const resourcesData = {{ charts.resources | tojson }};

if (resourcesData && resourcesData.length > 0) {
  new Chart(document.getElementById('resourcesChart'), {
    type: 'bar',
    data: {
      labels: resourcesData.map(r => r.type),
      datasets: [{
        data: resourcesData.map(r => r.value),
        backgroundColor: [colors.pink, colors.purple, colors.blue, colors.cyan, colors.teal],
        borderRadius: 6
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'white',
          titleColor: colors.charcoal,
          bodyColor: colors.gray,
          borderColor: colors.grayPale,
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              return formatCurrency(context.raw);
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          grid: { color: colors.grayPale },
          ticks: {
            callback: function(value) {
              return formatCurrency(value);
            }
          }
        },
        y: { grid: { display: false } }
      }
    }
  });
}

// ==================== FUND CHART (Doughnut) ====================
const fundData = {{ charts.fund | tojson }};

if (fundData && fundData.length > 0) {
  new Chart(document.getElementById('fundChart'), {
    type: 'doughnut',
    data: {
      labels: fundData.map(f => f.category),
      datasets: [{
        data: fundData.map(f => f.value),
        backgroundColor: [colors.blue, colors.purple, colors.pink, colors.orange, colors.green],
        borderWidth: 3,
        borderColor: 'white',
        hoverOffset: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '60%',
      plugins: {
        legend: { position: 'right' },
        tooltip: {
          backgroundColor: 'white',
          titleColor: colors.charcoal,
          bodyColor: colors.gray,
          borderColor: colors.grayPale,
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((context.raw / total) * 100).toFixed(1);
              return context.label + ': ' + formatCurrency(context.raw) + ' (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
}

// ==================== FINANCIAL HISTORY CHART ====================
const historyData = {{ charts.financial_history | tojson }};

if (historyData && historyData.length > 0) {
  new Chart(document.getElementById('historyChart'), {
    type: 'bar',
    data: {
      labels: historyData.map(h => h.year),
      datasets: [
        {
          label: isRTL ? 'المبيعات' : 'Sales',
          data: historyData.map(h => h.sales),
          backgroundColor: colors.blue,
          borderRadius: 6
        },
        {
          label: isRTL ? 'الأرباح' : 'Profit',
          data: historyData.map(h => h.profit),
          backgroundColor: colors.green,
          borderRadius: 6
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          backgroundColor: 'white',
          titleColor: colors.charcoal,
          bodyColor: colors.gray,
          borderColor: colors.grayPale,
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + formatCurrency(context.raw);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: colors.grayPale },
          ticks: {
            callback: function(value) {
              return formatCurrency(value);
            }
          }
        },
        x: { grid: { display: false } }
      }
    }
  });
}
</script>
{% endblock javascripts %}