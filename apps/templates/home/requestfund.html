{% extends "layouts/base.html" %}

{% block title %}
  {% if session.get('lang', 'en') == 'ar' %}
    التمويل المطلوب
  {% else %}
    Requested Fund
  {% endif %}
{% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}


<div class="container-fluid pl-5 pt-3">
  <div class="row">
    <div class="col-10">

      <form role="form" method="POST" action="/requested_fund/{{ bplan_id }}">

        <div class="row px-8 pt-0 pb-3">
          <span class="me-2 text-xxs font-weight-bold">{{ data_comp[0].completion }}%
            {% if session.get('lang', 'en') == 'ar' %}
              مكتمل
            {% else %}
              Completed
            {% endif %}
          </span>
          <div class="progress">
            {% if data_comp[0].completion == 100: %}
            <div class="progress-bar bg-gradient-success" role="progressbar" aria-valuenow="{{ data_comp[0].completion }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ data_comp[0].completion }}%;"></div>
            {% elif data_comp[0].completion >= 50: %}
              <div class="progress-bar bg-gradient-info" role="progressbar" aria-valuenow="{{ data_comp[0].completion }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ data_comp[0].completion }}%;"></div>
            {% else %}
              <div class="progress-bar bg-gradient-danger" role="progressbar" aria-valuenow="{{ data_comp[0].completion }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ data_comp[0].completion }}%;"></div>
            {% endif %}
          </div>
        </div>

        <!-- Title + Fund Details card -->
        <div class="card my-3">
          <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
            <div class="bg-gradient-info shadow-info border-radius-lg pt-4 pb-3">
              <h5 class="text-white text-capitalize ps-3 mx-3">
                {% if session.get('lang', 'en') == 'ar' %}
                  التمويل المطلوب
                {% else %}
                  Requested Fund
                {% endif %}
              </h5>
            </div>
          </div>

          <div class="card-body px-6 pt-2">
            <h5 class="font-weight-bolder text-info mt-4">
              {% if session.get('lang', 'en') == 'ar' %}
                تفاصيل التمويل
              {% else %}
                Fund Details
              {% endif %}
            </h5>

            <!-- Objectives -->
            <div class="row">
              <div class="col-2 mb-1 pt-2">
                <div class="input-group input-group-static mb-4">
                  <label class="form-label text-dark">
                    {% if session.get('lang', 'en') == 'ar' %}
                      الأهداف:
                    {% else %}
                      Objectives:
                    {% endif %}
                  </label>
                </div>
              </div>
              <div class="col mb-1 pt-2">
                <div class="input-group input-group-static mb-0">
                  <select class="multisteps-form__input form-control" name="choice_objectives" id="choice_objectives" multiple autocomplete="off">
                    <option value="1" {% if "1" in data_fd[0].project_objectives %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}تلبية الطلب المتزايد في السوق{% else %}Answering Increasing Market Need{% endif %}
                    </option>
                    <option value="2" {% if "2" in data_fd[0].project_objectives %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}تطوير منتجات الأعمال{% else %}Developing Business Products{% endif %}
                    </option>
                    <option value="3" {% if "3" in data_fd[0].project_objectives %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}زيادة الطاقة الإنتاجية{% else %}Increasing Production Capacity{% endif %}
                    </option>
                    <option value="4" {% if "4" in data_fd[0].project_objectives %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}إطلاق منتجات جديدة{% else %}Launching new products{% endif %}
                    </option>
                    <option value="5" {% if "5" in data_fd[0].project_objectives %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}توسيع السوق{% else %}Market Expansion{% endif %}
                    </option>
                    <option value="6" {% if "6" in data_fd[0].project_objectives %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}التسويق والترويج{% else %}Marketing & Promotion{% endif %}
                    </option>
                    <option value="7" {% if "7" in data_fd[0].project_objectives %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}فتح فرع جديد{% else %}Opening a New Branch{% endif %}
                    </option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Purposes -->
            <div class="row">
              <div class="col-2 mb-1 pt-2">
                <div class="input-group input-group-static mb-4">
                  <label class="form-label text-dark">
                    {% if session.get('lang', 'en') == 'ar' %}
                      الأغراض
                    {% else %}
                      Purposes
                    {% endif %}
                  </label>
                </div>
              </div>
              <div class="col mb-1 pt-2">
                <div class="input-group input-group-static mb-0">
                  <select class="multisteps-form__input form-control" name="choice_purposes" id="choice_purposes" multiple autocomplete="off">
                    <option value="1" {% if "1" in data_fd[0].project_purposes %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}بناء{% else %}Construction{% endif %}
                    </option>
                    <option value="2" {% if "2" in data_fd[0].project_purposes %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}أعمال كهربائية{% else %}Electrical Work{% endif %}
                    </option>
                    <option value="3" {% if "3" in data_fd[0].project_purposes %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}معدات وآلات{% else %}Equipment & Machinery{% endif %}
                    </option>
                    <option value="4" {% if "4" in data_fd[0].project_purposes %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}تنسيق مواقع{% else %}Landscaping{% endif %}
                    </option>
                    <option value="5" {% if "5" in data_fd[0].project_purposes %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}تسويق{% else %}Marketing{% endif %}
                    </option>
                    <option value="6" {% if "6" in data_fd[0].project_purposes %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}أعمال ميكانيكية{% else %}Machanical Work{% endif %}
                    </option>
                    <option value="7" {% if "7" in data_fd[0].project_purposes %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}تكاليف التشغيل{% else %}Operation Cost{% endif %}
                    </option>
                    <option value="8" {% if "8" in data_fd[0].project_purposes %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}تغليف{% else %}Packing{% endif %}
                    </option>
                    <option value="9" {% if "9" in data_fd[0].project_purposes %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}مواد خام{% else %}Raw Material{% endif %}
                    </option>
                    <option value="10" {% if "10" in data_fd[0].project_purposes %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}توظيف{% else %}Recruitment{% endif %}
                    </option>
                    <option value="11" {% if "11" in data_fd[0].project_purposes %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}ترميم{% else %}Renovation{% endif %}
                    </option>
                    <option value="12" {% if "12" in data_fd[0].project_purposes %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}إيجار{% else %}Rent{% endif %}
                    </option>
                    <option value="13" {% if "13" in data_fd[0].project_purposes %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}رواتب{% else %}Salaries{% endif %}
                    </option>
                    <option value="14" {% if "14" in data_fd[0].project_purposes %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}خدمات المقاولين من الباطن{% else %}Sub-Contracting Services{% endif %}
                    </option>
                  </select>
                </div>
              </div>
            </div>

            <!-- 1st row -->
            <div class="row">

              <div class="col">
                <div class="input-group input-group-static mb-4">
                  <label class="form-label text-dark">
                    {% if session.get('lang', 'en') == 'ar' %}
                      نوع التمويل
                    {% else %}
                      Fund Type
                    {% endif %}
                  </label>
                </div>
                <div class="input-group input-group-static mb-0">
                  <select class="multisteps-form__input form-control" name="choice_fund_type" id="choice_fund_type" onchange="check_fund_type()" autocomplete="off">
                    <option value="loan" {% if "loan" == data_fd[0].fund_type %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}قرض{% else %}Loan{% endif %}
                    </option>
                    <option value="grant" {% if "grant" == data_fd[0].fund_type %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}منحة{% else %}Grant{% endif %}
                    </option>
                    <option value="investment" {% if "investment" == data_fd[0].fund_type %} selected {% endif %}>
                      {% if session.get('lang', 'en') == 'ar' %}استثمار{% else %}Investment{% endif %}
                    </option>
                  </select>
                </div>
              </div>

              <div class="col">
                <div class="input-group input-group-static mb-4">
                  <label class="form-label text-dark">
                    {% if session.get('lang', 'en') == 'ar' %}
                      المبلغ
                    {% else %}
                      Amount
                    {% endif %}
                  </label>
                </div>
                <div class="input-group input-group-static mb-0">
                  <input class="multisteps-form__input form-control" type="number" name="fund_amount" value="{{ data_fd[0].amount }}" autocomplete="off"/>
                </div>
              </div>

              <div class="col">
                <div class="input-group input-group-static mb-4">
                  <label class="form-label text-dark" id="fund_equity_label" style="display: none;">
                    {% if session.get('lang', 'en') == 'ar' %}
                      حقوق الملكية
                    {% else %}
                      Equity
                    {% endif %}
                  </label>
                </div>
                <div class="input-group input-group-static mb-0">
                  <input class="multisteps-form__input form-control" type="number" name="fund_equity" id="fund_equity" style="display: none;" value="{{ data_fd[0].equity }}" autocomplete="off"/>
                </div>
              </div>

            </div>

           <!-- 2nd row -->
           <div class="row">

            <div class="col">
              <div class="input-group input-group-static mb-4">
                <label class="form-label text-dark" id="interest_rate_label" style="display: none;">
                  {% if session.get('lang', 'en') == 'ar' %}
                    سعر الفائدة
                  {% else %}
                    Interest Rate
                  {% endif %}
                </label>
              </div>
              <div class="input-group input-group-static mb-0">
                <input class="multisteps-form__input form-control" type="number" min="0" max="100" step="0.01" name="interest_rate" id="interest_rate" style="display: none;" value="{{ data_fd[0].interest_rate }}" autocomplete="off"/>
              </div>
            </div>

            <div class="col">
              <div class="input-group input-group-static mb-4">
                <label class="form-label text-dark" id="fund_period_label" style="display: none;">
                  {% if session.get('lang', 'en') == 'ar' %}
                    المدة (سنوات)
                  {% else %}
                    Period (years)
                  {% endif %}
                </label>
              </div>
              <div class="input-group input-group-static mb-0">
                <input class="multisteps-form__input form-control" type="number" name="fund_period" id="fund_period" style="display: none;" value="{{ data_fd[0].period }}" autocomplete="off"/>
              </div>
            </div>

            <div class="col">
              <div class="input-group input-group-static mb-4">
                <label class="form-label text-dark" id="fund_grade_period_label" style="display: none;">
                  {% if session.get('lang', 'en') == 'ar' %}
                    فترة السماح (سنوات)
                  {% else %}
                    Grace Period (years)
                  {% endif %}
                </label>
              </div>
              <div class="input-group input-group-static mb-0">
                <input class="multisteps-form__input form-control" type="number" name="fund_grace_period" id="fund_grade_period" style="display: none;" value="{{ data_fd[0].grace_period }}" autocomplete="off"/>
              </div>
            </div>


          </div>

        </div>


        </div>

        <!-- Items details card -->
        <div class="card my-3">

          <div class="card-body px-6 pt-2">
            <h5 class="font-weight-bolder text-info mt-3">
              {% if session.get('lang', 'en') == 'ar' %}
                قائمة تفاصيل المواد
              {% else %}
                List of Items Details
              {% endif %}
            </h5>

            <!-- ADD card body -->
            <div class="row">
              <div class="col">
                <div class="card card-body bg-gray-100 px-4 py-2">

                  <!-- 1st row -->
                  <div class="row">
                    <div class="col">
                      <div class="input-group input-group-static mb-4">
                        <label class="form-label">
                          {% if session.get('lang', 'en') == 'ar' %}
                            النوع
                          {% else %}
                            Type
                          {% endif %}
                        </label>
                      </div>
                      <div class="input-group input-group-static mb-0">
                        <select class="multisteps-form__input form-control form-control-sm" name="choice_item_type" id="choice_item_type" onchange="check_item_type()" autocomplete="off">
                          <option value="1" selected>
                            {% if session.get('lang', 'en') == 'ar' %}تركيب{% else %}Installation{% endif %}
                          </option>
                          <option value="2">
                            {% if session.get('lang', 'en') == 'ar' %}آلات ومعدات{% else %}Machinery & Equipment{% endif %}
                          </option>
                          <option value="3">
                            {% if session.get('lang', 'en') == 'ar' %}مواد خام{% else %}Raw Material{% endif %}
                          </option>
                          <option value="4">
                            {% if session.get('lang', 'en') == 'ar' %}رواتب{% else %}Salaries{% endif %}
                          </option>
                          <option value="5">
                            {% if session.get('lang', 'en') == 'ar' %}تكاليف أخرى{% else %}Other Costs{% endif %}
                          </option>
                        </select>
                      </div>
                    </div>

                    <div class="col">
                      <div class="input-group input-group-static mb-4">
                        <label class="form-label">
                          {% if session.get('lang', 'en') == 'ar' %}
                            التكلفة (دولار)
                          {% else %}
                            Cost (USD)
                          {% endif %}
                        </label>
                      </div>
                      <div class="input-group input-group-static mb-0">
                        <input class="form-control" type="number" name="item_cost" placeholder="" autocomplete="off"/>
                      </div>
                    </div>

                    <div class="col">
                      <div class="input-group input-group-static mb-4">
                        <label class="form-label" id="item_unit_label" style="display: none;">
                          {% if session.get('lang', 'en') == 'ar' %}
                            الوحدة
                          {% else %}
                            Unit
                          {% endif %}
                        </label>
                      </div>
                      <!-- In the item unit select dropdown -->
                      <div class="input-group input-group-static mb-0" id="item_unit" style="display: none;">
                        <select class="multisteps-form__input form-control form-control-sm" name="choice_item_unit" id="choice_item_unit" autocomplete="off">
                          <!-- Default options (shown for non-Salary types) -->
                          <option value="Bag">
                            {% if session.get('lang', 'en') == 'ar' %}كيس{% else %}Bag{% endif %}
                          </option>
                          <option value="Head">
                            {% if session.get('lang', 'en') == 'ar' %}رأس{% else %}Head{% endif %}
                          </option>
                          <option value="Bottle">
                            {% if session.get('lang', 'en') == 'ar' %}زجاجة{% else %}Bottle{% endif %}
                          </option>
                          <option value="Liter">
                            {% if session.get('lang', 'en') == 'ar' %}لتر{% else %}Liter{% endif %}
                          </option>
                          <option value="M">
                            {% if session.get('lang', 'en') == 'ar' %}متر{% else %}M{% endif %}
                          </option>
                          <option value="M2">
                            {% if session.get('lang', 'en') == 'ar' %}متر مربع{% else %}M2{% endif %}
                          </option>
                          <option value="M3">
                            {% if session.get('lang', 'en') == 'ar' %}متر مكعب{% else %}M3{% endif %}
                          </option>
                          <option value="Hectar">
                            {% if session.get('lang', 'en') == 'ar' %}هكتار{% else %}Hectar{% endif %}
                          </option>
                          <option value="Box">
                            {% if session.get('lang', 'en') == 'ar' %}صندوق{% else %}Box{% endif %}
                          </option>
                          <option value="Piece">
                            {% if session.get('lang', 'en') == 'ar' %}قطعة{% else %}Piece{% endif %}
                          </option>
                          <option value="Service">
                            {% if session.get('lang', 'en') == 'ar' %}خدمة{% else %}Service{% endif %}
                          </option>
                          <option value="Solution">
                            {% if session.get('lang', 'en') == 'ar' %}محلول{% else %}Solution{% endif %}
                          </option>
                          <option value="License">
                            {% if session.get('lang', 'en') == 'ar' %}رخصة{% else %}License{% endif %}
                          </option>
                          <option value="Gram">
                            {% if session.get('lang', 'en') == 'ar' %}جرام{% else %}Gram{% endif %}
                          </option>
                          <option value="Kg">
                            {% if session.get('lang', 'en') == 'ar' %}كيلوجرام{% else %}Kg{% endif %}
                          </option>
                          <option value="Ton">
                            {% if session.get('lang', 'en') == 'ar' %}طن{% else %}Ton{% endif %}
                          </option>
                          <option value="Hour">
                            {% if session.get('lang', 'en') == 'ar' %}ساعة{% else %}Hour{% endif %}
                          </option>
                          <!-- Time units (will be shown only for Salaries) -->
                          <option value="Day" class="time-unit">
                            {% if session.get('lang', 'en') == 'ar' %}يوم{% else %}Day{% endif %}
                          </option>
                          <option value="Week" class="time-unit">
                            {% if session.get('lang', 'en') == 'ar' %}أسبوع{% else %}Week{% endif %}
                          </option>
                          <option value="Month" class="time-unit">
                            {% if session.get('lang', 'en') == 'ar' %}شهر{% else %}Month{% endif %}
                          </option>
                          <option value="Quarter" class="time-unit">
                            {% if session.get('lang', 'en') == 'ar' %}ربع سنة{% else %}Quarter{% endif %}
                          </option>
                          <option value="Year" class="time-unit">
                            {% if session.get('lang', 'en') == 'ar' %}سنة{% else %}Year{% endif %}
                          </option>
                        </select>
                      </div>
                    </div>


                  </div>

                  <!-- 2nd row -->
                  <div class="row">

                    <div class="col">
                      <div class="input-group input-group-static mb-4">
                        <label class="form-label" id="item_name_label" style="display: none;">
                          {% if session.get('lang', 'en') == 'ar' %}
                            الصنف
                          {% else %}
                            Item
                          {% endif %}
                        </label>
                      </div>
                      <div class="input-group input-group-static mb-0">
                        <input class="form-control" type="text" name="item_name" id="item_name" style="display: none;" placeholder="" autocomplete="off"/>
                      </div>
                    </div>

                    <div class="col">
                      <div class="input-group input-group-static mb-4">
                        <label class="form-label" id="item_quantity_label" style="display: none;">
                          {% if session.get('lang', 'en') == 'ar' %}
                            الكمية
                          {% else %}
                            Quantity
                          {% endif %}
                        </label>
                      </div>
                      <div class="input-group input-group-static mb-0">
                        <input class="form-control" type="number" name="item_quantity" id="item_quantity" style="display: none;" placeholder="" autocomplete="off"/>
                      </div>
                    </div>

                    <div class="col">

                    </div>

                  </div>
                </div>

              </div>

              <div class="col-1 align-self-end">
                <button class="btn bg-gradient-info btn-sm" data-bs-toggle="tooltip" data-bs-original-title="{% if session.get('lang', 'en') == 'ar' %}إضافة{% else %}Add{% endif %}" type="submit" name="buz_item_add" value="{{ bplan_id }}">
                  {% if session.get('lang', 'en') == 'ar' %}
                    إضافة
                  {% else %}
                    add
                  {% endif %}
                </button>
              </div>
            </div>

            <br>
            <!-- Fund Items Table -->
            <div class="ajax-table-container" id="fund-items-table-container">
                <div class="ajax-table-body">
                    <div class="table-responsive">
                        <table class="table ajax-table align-items-center">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="text-uppercase text-dark text-xs font-weight-bolder ps-4">
                                        {% if session.get('lang', 'en') == 'ar' %}النوع{% else %}Type{% endif %}
                                    </th>
                                    <th class="text-uppercase text-dark text-xs font-weight-bolder ps-3">
                                        {% if session.get('lang', 'en') == 'ar' %}الصنف{% else %}Item{% endif %}
                                    </th>
                                    <th class="text-uppercase text-dark text-xs font-weight-bolder ps-3">
                                        {% if session.get('lang', 'en') == 'ar' %}الوحدة{% else %}Unit{% endif %}
                                    </th>
                                    <th class="text-uppercase text-dark text-xs font-weight-bolder ps-3">
                                        {% if session.get('lang', 'en') == 'ar' %}الكمية{% else %}Quantity{% endif %}
                                    </th>
                                    <th class="text-uppercase text-dark text-xs font-weight-bolder ps-3">
                                        {% if session.get('lang', 'en') == 'ar' %}التكلفة{% else %}Cost{% endif %}
                                    </th>
                                    <th class="text-uppercase text-dark text-xs font-weight-bolder ps-3">
                                        {% if session.get('lang', 'en') == 'ar' %}الإجمالي{% else %}Total{% endif %}
                                    </th>
                                    <th class="text-uppercase text-dark text-xs font-weight-bolder text-center">
                                        {% if session.get('lang', 'en') == 'ar' %}الإجراء{% else %}Action{% endif %}
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set total_items = 0 %}

                                <!-- Installation Items -->
                                {% for row in data_installation %}
                                {% set total_items = total_items + 1 %}
                                <tr>
                                    <td class="ps-4 py-3">
                                        <span class="badge bg-primary text-white">
                                            {% if session.get('lang', 'en') == 'ar' %}تركيب{% else %}Installation{% endif %}
                                        </span>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm text-dark mb-0">{{ row.item if row.item else '-' }}</p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm text-dark mb-0">
                                            {% if session.get('lang', 'en') == 'ar' %}
                                                {% if row.unit == 'Bag' %}كيس
                                                {% elif row.unit == 'Head' %}رأس
                                                {% elif row.unit == 'Bottle' %}زجاجة
                                                {% elif row.unit == 'Liter' %}لتر
                                                {% elif row.unit == 'M' %}متر
                                                {% elif row.unit == 'M2' %}متر مربع
                                                {% elif row.unit == 'M3' %}متر مكعب
                                                {% elif row.unit == 'Hectar' %}هكتار
                                                {% elif row.unit == 'Box' %}صندوق
                                                {% elif row.unit == 'Piece' %}قطعة
                                                {% elif row.unit == 'Service' %}خدمة
                                                {% elif row.unit == 'Solution' %}محلول
                                                {% elif row.unit == 'License' %}رخصة
                                                {% elif row.unit == 'Gram' %}جرام
                                                {% elif row.unit == 'Kg' %}كيلوجرام
                                                {% elif row.unit == 'Ton' %}طن
                                                {% elif row.unit == 'Hour' %}ساعة
                                                {% elif row.unit == 'Day' %}يوم
                                                {% elif row.unit == 'Week' %}أسبوع
                                                {% elif row.unit == 'Month' %}شهر
                                                {% elif row.unit == 'Quarter' %}ربع سنة
                                                {% elif row.unit == 'Year' %}سنة
                                                {% else %}{{ row.unit if row.unit else '-' }}{% endif %}
                                            {% else %}
                                                {{ row.unit if row.unit else '-' }}
                                            {% endif %}
                                        </p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm text-dark mb-0">{{ row.quantity if row.quantity else '-' }}</p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm font-weight-bold text-info mb-0">{{ "${:,}".format(row.cost) }}</p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm font-weight-bold text-success mb-0">{{ "${:,}".format(row.total_cost) }}</p>
                                    </td>
                                    <td class="text-center py-3">
                                        <button type="button" class="btn btn-sm btn-outline-danger delete-fund-item-btn"
                                                data-bs-toggle="tooltip"
                                                data-bs-original-title="{% if session.get('lang', 'en') == 'ar' %}حذف البند{% else %}Delete Item{% endif %}"
                                                data-item-id="{{ row.item_id }}">
                                            <i class="material-icons text-xs">delete</i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}

                                <!-- Machinery & Equipment Items -->
                                {% for row in data_machines %}
                                {% set total_items = total_items + 1 %}
                                <tr>
                                    <td class="ps-4 py-3">
                                        <span class="badge bg-info text-white">
                                            {% if session.get('lang', 'en') == 'ar' %}آلات ومعدات{% else %}Machinery & Equipment{% endif %}
                                        </span>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm text-dark mb-0">{{ row.item if row.item else '-' }}</p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm text-dark mb-0">
                                            {% if session.get('lang', 'en') == 'ar' %}
                                                {% if row.unit == 'Bag' %}كيس
                                                {% elif row.unit == 'Head' %}رأس
                                                {% elif row.unit == 'Bottle' %}زجاجة
                                                {% elif row.unit == 'Liter' %}لتر
                                                {% elif row.unit == 'M' %}متر
                                                {% elif row.unit == 'M2' %}متر مربع
                                                {% elif row.unit == 'M3' %}متر مكعب
                                                {% elif row.unit == 'Hectar' %}هكتار
                                                {% elif row.unit == 'Box' %}صندوق
                                                {% elif row.unit == 'Piece' %}قطعة
                                                {% elif row.unit == 'Service' %}خدمة
                                                {% elif row.unit == 'Solution' %}محلول
                                                {% elif row.unit == 'License' %}رخصة
                                                {% elif row.unit == 'Gram' %}جرام
                                                {% elif row.unit == 'Kg' %}كيلوجرام
                                                {% elif row.unit == 'Ton' %}طن
                                                {% elif row.unit == 'Hour' %}ساعة
                                                {% elif row.unit == 'Day' %}يوم
                                                {% elif row.unit == 'Week' %}أسبوع
                                                {% elif row.unit == 'Month' %}شهر
                                                {% elif row.unit == 'Quarter' %}ربع سنة
                                                {% elif row.unit == 'Year' %}سنة
                                                {% else %}{{ row.unit if row.unit else '-' }}{% endif %}
                                            {% else %}
                                                {{ row.unit if row.unit else '-' }}
                                            {% endif %}
                                        </p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm text-dark mb-0">{{ row.quantity if row.quantity else '-' }}</p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm font-weight-bold text-info mb-0">{{ "${:,}".format(row.cost) }}</p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm font-weight-bold text-success mb-0">{{ "${:,}".format(row.total_cost) }}</p>
                                    </td>
                                    <td class="text-center py-3">
                                        <button type="button" class="btn btn-sm btn-outline-danger delete-fund-item-btn"
                                                data-bs-toggle="tooltip"
                                                data-bs-original-title="{% if session.get('lang', 'en') == 'ar' %}حذف البند{% else %}Delete Item{% endif %}"
                                                data-item-id="{{ row.item_id }}">
                                            <i class="material-icons text-xs">delete</i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}

                                <!-- Raw Materials Items -->
                                {% for row in data_materials %}
                                {% set total_items = total_items + 1 %}
                                <tr>
                                    <td class="ps-4 py-3">
                                        <span class="badge bg-warning text-white">
                                            {% if session.get('lang', 'en') == 'ar' %}مواد خام{% else %}Raw Materials{% endif %}
                                        </span>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm text-dark mb-0">{{ row.item if row.item else '-' }}</p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm text-dark mb-0">
                                            {% if session.get('lang', 'en') == 'ar' %}
                                                {% if row.unit == 'Bag' %}كيس
                                                {% elif row.unit == 'Head' %}رأس
                                                {% elif row.unit == 'Bottle' %}زجاجة
                                                {% elif row.unit == 'Liter' %}لتر
                                                {% elif row.unit == 'M' %}متر
                                                {% elif row.unit == 'M2' %}متر مربع
                                                {% elif row.unit == 'M3' %}متر مكعب
                                                {% elif row.unit == 'Hectar' %}هكتار
                                                {% elif row.unit == 'Box' %}صندوق
                                                {% elif row.unit == 'Piece' %}قطعة
                                                {% elif row.unit == 'Service' %}خدمة
                                                {% elif row.unit == 'Solution' %}محلول
                                                {% elif row.unit == 'License' %}رخصة
                                                {% elif row.unit == 'Gram' %}جرام
                                                {% elif row.unit == 'Kg' %}كيلوجرام
                                                {% elif row.unit == 'Ton' %}طن
                                                {% elif row.unit == 'Hour' %}ساعة
                                                {% elif row.unit == 'Day' %}يوم
                                                {% elif row.unit == 'Week' %}أسبوع
                                                {% elif row.unit == 'Month' %}شهر
                                                {% elif row.unit == 'Quarter' %}ربع سنة
                                                {% elif row.unit == 'Year' %}سنة
                                                {% else %}{{ row.unit if row.unit else '-' }}{% endif %}
                                            {% else %}
                                                {{ row.unit if row.unit else '-' }}
                                            {% endif %}
                                        </p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm text-dark mb-0">{{ row.quantity if row.quantity else '-' }}</p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm font-weight-bold text-info mb-0">{{ "${:,}".format(row.cost) }}</p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm font-weight-bold text-success mb-0">{{ "${:,}".format(row.total_cost) }}</p>
                                    </td>
                                    <td class="text-center py-3">
                                        <button type="button" class="btn btn-sm btn-outline-danger delete-fund-item-btn"
                                                data-bs-toggle="tooltip"
                                                data-bs-original-title="{% if session.get('lang', 'en') == 'ar' %}حذف البند{% else %}Delete Item{% endif %}"
                                                data-item-id="{{ row.item_id }}">
                                            <i class="material-icons text-xs">delete</i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}

                                <!-- Salaries Items -->
                                {% for row in data_salaries %}
                                {% set total_items = total_items + 1 %}
                                <tr>
                                    <td class="ps-4 py-3">
                                        <span class="badge bg-success text-white">
                                            {% if session.get('lang', 'en') == 'ar' %}رواتب{% else %}Salaries{% endif %}
                                        </span>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm text-dark mb-0">{{ row.item if row.item else '-' }}</p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm text-dark mb-0">
                                            {% if session.get('lang', 'en') == 'ar' %}
                                                {% if row.unit == 'Bag' %}كيس
                                                {% elif row.unit == 'Head' %}رأس
                                                {% elif row.unit == 'Bottle' %}زجاجة
                                                {% elif row.unit == 'Liter' %}لتر
                                                {% elif row.unit == 'M' %}متر
                                                {% elif row.unit == 'M2' %}متر مربع
                                                {% elif row.unit == 'M3' %}متر مكعب
                                                {% elif row.unit == 'Hectar' %}هكتار
                                                {% elif row.unit == 'Box' %}صندوق
                                                {% elif row.unit == 'Piece' %}قطعة
                                                {% elif row.unit == 'Service' %}خدمة
                                                {% elif row.unit == 'Solution' %}محلول
                                                {% elif row.unit == 'License' %}رخصة
                                                {% elif row.unit == 'Gram' %}جرام
                                                {% elif row.unit == 'Kg' %}كيلوجرام
                                                {% elif row.unit == 'Ton' %}طن
                                                {% elif row.unit == 'Hour' %}ساعة
                                                {% elif row.unit == 'Day' %}يوم
                                                {% elif row.unit == 'Week' %}أسبوع
                                                {% elif row.unit == 'Month' %}شهر
                                                {% elif row.unit == 'Quarter' %}ربع سنة
                                                {% elif row.unit == 'Year' %}سنة
                                                {% else %}{{ row.unit if row.unit else '-' }}{% endif %}
                                            {% else %}
                                                {{ row.unit if row.unit else '-' }}
                                            {% endif %}
                                        </p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm text-dark mb-0">{{ row.quantity if row.quantity else '-' }}</p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm font-weight-bold text-info mb-0">{{ "${:,}".format(row.cost) }}</p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm font-weight-bold text-success mb-0">{{ "${:,}".format(row.total_cost) }}</p>
                                    </td>
                                    <td class="text-center py-3">
                                        <button type="button" class="btn btn-sm btn-outline-danger delete-fund-item-btn"
                                                data-bs-toggle="tooltip"
                                                data-bs-original-title="{% if session.get('lang', 'en') == 'ar' %}حذف البند{% else %}Delete Item{% endif %}"
                                                data-item-id="{{ row.item_id }}">
                                            <i class="material-icons text-xs">delete</i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}

                                <!-- Other Costs Items -->
                                {% for row in data_ocosts %}
                                {% set total_items = total_items + 1 %}
                                <tr>
                                    <td class="ps-4 py-3">
                                        <span class="badge bg-secondary text-white">
                                            {% if session.get('lang', 'en') == 'ar' %}تكاليف أخرى{% else %}Other Costs{% endif %}
                                        </span>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm text-dark mb-0">{{ row.item if row.item else '-' }}</p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm text-dark mb-0">
                                            {% if session.get('lang', 'en') == 'ar' %}
                                                {% if row.unit == 'Bag' %}كيس
                                                {% elif row.unit == 'Head' %}رأس
                                                {% elif row.unit == 'Bottle' %}زجاجة
                                                {% elif row.unit == 'Liter' %}لتر
                                                {% elif row.unit == 'M' %}متر
                                                {% elif row.unit == 'M2' %}متر مربع
                                                {% elif row.unit == 'M3' %}متر مكعب
                                                {% elif row.unit == 'Hectar' %}هكتار
                                                {% elif row.unit == 'Box' %}صندوق
                                                {% elif row.unit == 'Piece' %}قطعة
                                                {% elif row.unit == 'Service' %}خدمة
                                                {% elif row.unit == 'Solution' %}محلول
                                                {% elif row.unit == 'License' %}رخصة
                                                {% elif row.unit == 'Gram' %}جرام
                                                {% elif row.unit == 'Kg' %}كيلوجرام
                                                {% elif row.unit == 'Ton' %}طن
                                                {% elif row.unit == 'Hour' %}ساعة
                                                {% elif row.unit == 'Day' %}يوم
                                                {% elif row.unit == 'Week' %}أسبوع
                                                {% elif row.unit == 'Month' %}شهر
                                                {% elif row.unit == 'Quarter' %}ربع سنة
                                                {% elif row.unit == 'Year' %}سنة
                                                {% else %}{{ row.unit if row.unit else '-' }}{% endif %}
                                            {% else %}
                                                {{ row.unit if row.unit else '-' }}
                                            {% endif %}
                                        </p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm text-dark mb-0">{{ row.quantity if row.quantity else '-' }}</p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm font-weight-bold text-info mb-0">{{ "${:,}".format(row.cost) }}</p>
                                    </td>
                                    <td class="ps-3 py-3">
                                        <p class="text-sm font-weight-bold text-success mb-0">{{ "${:,}".format(row.total_cost) }}</p>
                                    </td>
                                    <td class="text-center py-3">
                                        <button type="button" class="btn btn-sm btn-outline-danger delete-fund-item-btn"
                                                data-bs-toggle="tooltip"
                                                data-bs-original-title="{% if session.get('lang', 'en') == 'ar' %}حذف البند{% else %}Delete Item{% endif %}"
                                                data-item-id="{{ row.item_id }}">
                                            <i class="material-icons text-xs">delete</i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="button-row d-flex mt-4">
              <!-- <button class="btn bg-gradient-light mb-0 js-btn-prev" data-bs-toggle="tooltip" data-bs-placement="top" title="Previous" type="submit" name="action" value="prev">Prev</button> -->
              <button class="btn bg-gradient-primary ms-auto mb-0" data-bs-toggle="tooltip" data-bs-placement="top" title="{% if session.get('lang', 'en') == 'ar' %}حفظ ومتابعة{% else %}Save & Continue{% endif %}" type="submit" name="action" value="save">
                {% if session.get('lang', 'en') == 'ar' %}
                  حفظ
                {% else %}
                  Save
                {% endif %}
              </button>
            </div>
          </div>


        </div>


      </form>

    </div>
  </div>
</div>


{% endblock content %}

<!-- Specific Page JS goes HERE  -->

{% block javascripts %}

<script>
// Set the language attribute for JavaScript detection
document.documentElement.lang = "{{ session.get('lang', 'en') }}";

if (document.getElementById('choice_fund_type')) {
    var element = document.getElementById('choice_fund_type');
    const example = new Choices(element, {
      searchEnabled: false
    });
  };

if (document.getElementById('choice_item_type')) {
  var element = document.getElementById('choice_item_type');
  const example = new Choices(element, {
    searchEnabled: false
  });
};

// if (document.getElementById('choice_item_unit')) {
//   var element = document.getElementById('choice_item_unit');
//   const example = new Choices(element, {
//     searchEnabled: false
//   });
// };

if (document.getElementById('choice_objectives')) {
    var tags = document.getElementById('choice_objectives');
    const examples = new Choices(tags, {
        searchEnabled: false,
        removeItemButton: true
    });
  };

if (document.getElementById('choice_purposes')) {
    var tags = document.getElementById('choice_purposes');
    const examples = new Choices(tags, {
        searchEnabled: false,
        removeItemButton: true
    });
  };



// Store Choices instance globally
window.choicesInstances = {};

if (document.getElementById('choice_item_unit')) {
  window.choicesInstances = window.choicesInstances || {};
  window.choicesInstances.choice_item_unit = new Choices(
    document.getElementById('choice_item_unit'),
    {
      searchEnabled: false,
      choices: [
        {value: 'Bag', label: 'Bag'},
        {value: 'Head', label: 'Head'},
        {value: 'Bottle', label: 'Bottle'},
        {value: 'Liter', label: 'Liter'},
        {value: 'M', label: 'M'},
        {value: 'M2', label: 'M2'},
        {value: 'M3', label: 'M3'},
        {value: 'Hectar', label: 'Hectar'},
        {value: 'Box', label: 'Box'},
        {value: 'Piece', label: 'Piece'},
        {value: 'Service', label: 'Service'},
        {value: 'Solution', label: 'Solution'},
        {value: 'License', label: 'License'},
        {value: 'Gram', label: 'Gram'},
        {value: 'Kg', label: 'Kg'},
        {value: 'Ton', label: 'Ton'},
        {value: 'Hour', label: 'Hour'}
      ]
    }
  );
};

function check_item_type() {
  const itemType = document.getElementById('choice_item_type').value;
  const itemUnitSelect = document.getElementById('choice_item_unit');
  const choicesInstance = window.choicesInstances.choice_item_unit;

  // Get current language from session or default to 'en'
  const currentLang = document.documentElement.lang || 'en';

  if (itemType === "1") { // Installation
    document.getElementById('item_name_label').style.display = 'none';
    document.getElementById('item_name').style.display = 'none';
    document.getElementById('item_unit_label').style.display = 'none';
    document.getElementById('item_unit').style.display = 'none';
    document.getElementById('item_quantity_label').style.display = 'none';
    document.getElementById('item_quantity').style.display = 'none';
  }
  else {
    if (itemType === "4") { // Salaries
      // Set bilingual labels for salaries
      document.getElementById('item_unit_label').textContent = currentLang === 'ar' ? 'لكل' : 'Per';
      document.getElementById('item_quantity_label').textContent = currentLang === 'ar' ? 'الفترة' : 'Period';
      document.getElementById('item_name_label').style.display = 'none';
      document.getElementById('item_name').style.display = 'none';
      document.getElementById('item_quantity_label').style.display = 'block';
      document.getElementById('item_quantity').style.display = 'block';
      document.getElementById('item_unit_label').style.display = 'block';
      document.getElementById('item_unit').style.display = 'block';

      // Show only time units for Salaries with bilingual support
      const timeUnits = currentLang === 'ar' ? [
        {value: 'Month', label: 'شهر'},
        {value: 'Year', label: 'سنة'}
      ] : [
        {value: 'Month', label: 'Month'},
        {value: 'Year', label: 'Year'}
      ];

      choicesInstance.clearChoices();
      choicesInstance.setChoices(timeUnits.map(unit => ({
        value: unit.value,
        label: unit.label,
        selected: itemUnitSelect.value === unit.value
      })));
      choicesInstance.setChoiceByValue('Month'); // Set default selection

    }
    else { // Other item types
      // Set bilingual labels for other types
      document.getElementById('item_unit_label').textContent = currentLang === 'ar' ? 'الوحدة' : 'Unit';
      document.getElementById('item_name_label').style.display = 'block';
      document.getElementById('item_name').style.display = 'block';
      document.getElementById('item_unit_label').style.display = 'block';
      document.getElementById('item_unit').style.display = 'block';
      document.getElementById('item_quantity_label').style.display = 'block';
      document.getElementById('item_quantity').style.display = 'block';

      // Show regular units with bilingual support
      const regularUnits = currentLang === 'ar' ? [
        {value: 'Bag', label: 'كيس'},
        {value: 'Head', label: 'رأس'},
        {value: 'Bottle', label: 'زجاجة'},
        {value: 'Liter', label: 'لتر'},
        {value: 'M', label: 'متر'},
        {value: 'M2', label: 'متر مربع'},
        {value: 'M3', label: 'متر مكعب'},
        {value: 'Hectar', label: 'هكتار'},
        {value: 'Box', label: 'صندوق'},
        {value: 'Piece', label: 'قطعة'},
        {value: 'Service', label: 'خدمة'},
        {value: 'Solution', label: 'محلول'},
        {value: 'License', label: 'رخصة'},
        {value: 'Gram', label: 'جرام'},
        {value: 'Kg', label: 'كيلوجرام'},
        {value: 'Ton', label: 'طن'},
        {value: 'Hour', label: 'ساعة'}
      ] : [
        {value: 'Bag', label: 'Bag'},
        {value: 'Head', label: 'Head'},
        {value: 'Bottle', label: 'Bottle'},
        {value: 'Liter', label: 'Liter'},
        {value: 'M', label: 'M'},
        {value: 'M2', label: 'M2'},
        {value: 'M3', label: 'M3'},
        {value: 'Hectar', label: 'Hectar'},
        {value: 'Box', label: 'Box'},
        {value: 'Piece', label: 'Piece'},
        {value: 'Service', label: 'Service'},
        {value: 'Solution', label: 'Solution'},
        {value: 'License', label: 'License'},
        {value: 'Gram', label: 'Gram'},
        {value: 'Kg', label: 'Kg'},
        {value: 'Ton', label: 'Ton'},
        {value: 'Hour', label: 'Hour'}
      ];

      choicesInstance.clearChoices();
      choicesInstance.setChoices(regularUnits.map(unit => ({
        value: unit.value,
        label: unit.label,
        selected: itemUnitSelect.value === unit.value
      })));
    }
  }
};



  function check_fund_type(){
  if(document.getElementById('choice_fund_type').value=="loan") {
    document.getElementById('fund_period_label').style.display = 'block';
    document.getElementById('fund_period').style.display = 'block';
    document.getElementById('fund_grade_period_label').style.display = 'block';
    document.getElementById('fund_grade_period').style.display = 'block';
    document.getElementById('fund_equity_label').style.display = 'none';
    document.getElementById('fund_equity').style.display = 'none';
    document.getElementById('interest_rate_label').style.display = 'block';
    document.getElementById('interest_rate').style.display = 'block';
 }
  else {


if(document.getElementById('choice_fund_type').value=="investment") {
    document.getElementById('fund_period_label').style.display = 'none';
    document.getElementById('fund_period').style.display = 'none';
    document.getElementById('fund_grade_period_label').style.display = 'none';
    document.getElementById('fund_grade_period').style.display = 'none';
    document.getElementById('fund_equity_label').style.display = 'block';
    document.getElementById('fund_equity').style.display = 'block';
    document.getElementById('interest_rate_label').style.display = 'none';
    document.getElementById('interest_rate').style.display = 'none';
    }

    else {
      document.getElementById('fund_period_label').style.display = 'none';
      document.getElementById('fund_period').style.display = 'none';
      document.getElementById('fund_grade_period_label').style.display = 'none';
      document.getElementById('fund_grade_period').style.display = 'none';
      document.getElementById('fund_equity_label').style.display = 'none';
      document.getElementById('fund_equity').style.display = 'none';
      document.getElementById('interest_rate_label').style.display = 'none';
      document.getElementById('interest_rate').style.display = 'none';
    }
  }
}
    // ✅ Call it on page load if there’s already a saved fund_type
window.addEventListener('DOMContentLoaded', () => {
  const savedFundType = "{{ data_fd[0].fund_type }}";  // Jinja inserts the saved value
  const selectElement = document.getElementById('choice_fund_type');

  if (savedFundType) {
    // Preselect it
    selectElement.value = savedFundType;
    // Show the right fields
    check_fund_type();
  }

  // Also handle changes (for user interactions)
  selectElement.addEventListener('change', check_fund_type);
});

</script>


<!--Table-->
<script>
// AJAX TABLE MANAGEMENT FOR REQUESTED FUND ITEMS
class RequestedFundTableManager {
    constructor() {
        this.tables = {};
        this.init();
    }

    init() {
        this.registerAllTables();
        this.setupGlobalListeners();
    }

    // Register all tables on the page
    registerAllTables() {
        // Fund Items Table
        this.registerTable('fund_items', {
            container: '#fund-items-table-container',
            addButton: 'button[name="buz_item_add"]',
            deleteButton: '.delete-fund-item-btn',
            formFields: [
                'choice_item_type',
                'item_name',
                'choice_item_unit',
                'item_quantity',
                'item_cost'
            ],
            deleteField: 'buz_item_delete'
        });
    }

    registerTable(name, config) {
        this.tables[name] = config;
        this.setupTable(name);
    }

    setupTable(tableName) {
        const table = this.tables[tableName];

        // Setup add button
        const addButton = document.querySelector(table.addButton);
        if (addButton) {
            addButton.addEventListener('click', (e) => {
                e.preventDefault();
                this.handleAdd(tableName);
            });
        }

        // Setup delete buttons
        this.attachDeleteListeners(tableName);
    }

    // Universal refresh function for any table
    async refreshTable(tableName) {
        const table = this.tables[tableName];

        try {
            const response = await fetch(window.location.href);
            const html = await response.text();

            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const newContainer = doc.querySelector(table.container);
            if (newContainer) {
                const currentContainer = document.querySelector(table.container);
                currentContainer.innerHTML = newContainer.innerHTML;
                this.attachDeleteListeners(tableName);

                // Reinitialize any dynamic functionality
                this.reinitializeItemTypeHandler();
            }
        } catch (error) {
            console.error(`Error refreshing ${tableName} table:`, error);
            window.location.reload();
        }
    }

    // Universal add handler
    async handleAdd(tableName) {
        const table = this.tables[tableName];
        const formData = new FormData();

        // Add the main action
        const addButton = document.querySelector(table.addButton);
        formData.append(table.addButton.replace('button[name="', '').replace('"]', ''), addButton.value);

        // Add all form fields
        table.formFields.forEach(fieldName => {
            const element = document.querySelector(`[name="${fieldName}"]`);
            if (element && element.value) {
                formData.append(fieldName, element.value);
            }
        });

        try {
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                this.clearFormFields(table.formFields);
                await this.refreshTable(tableName);
            } else {
                throw new Error('Network response was not ok');
            }
        } catch (error) {
            console.error(`Error adding to ${tableName}:`, error);
            this.showError(`Error adding ${tableName}. Please try again.`);
        }
    }

    // Universal delete handler
    async handleDelete(tableName, itemId) {
        const table = this.tables[tableName];
        const confirmMessage = this.getDeleteMessage(tableName);

        if (confirm(confirmMessage)) {
            const formData = new FormData();
            formData.append(table.deleteField, itemId);

            try {
                const response = await fetch(window.location.href, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    await this.refreshTable(tableName);
                } else {
                    throw new Error('Network response was not ok');
                }
            } catch (error) {
                console.error(`Error deleting from ${tableName}:`, error);
                this.showError(`Error deleting ${tableName}. Please try again.`);
            }
        }
    }

    // Attach delete listeners to a specific table
    attachDeleteListeners(tableName) {
        const table = this.tables[tableName];
        document.querySelectorAll(table.deleteButton).forEach(button => {
            button.addEventListener('click', () => {
                const itemId = button.getAttribute('data-item-id');
                this.handleDelete(tableName, itemId);
            });
        });
    }

    // Utility functions
clearFormFields(fieldNames) {
    fieldNames.forEach(fieldName => {
        const element = document.querySelector(`[name="${fieldName}"]`);
        if (element) {
            if (element.type === 'select-multiple') {
                element.selectedIndex = -1;
            } else if (element.type === 'number') {
                element.value = '';
            } else {
                element.value = '';
            }
        }
    });

    // Reset item type to Installation and hide the extra fields
    const itemTypeSelect = document.getElementById('choice_item_type');
    if (itemTypeSelect) {
        // Reset the Choices.js dropdown to "Installation" (value "1")
        const choicesInstance = itemTypeSelect._choices;
        if (choicesInstance) {
            choicesInstance.setChoiceByValue('1');
        } else {
            itemTypeSelect.value = '1';
        }

        // Call check_item_type to hide the fields for Installation
        if (typeof check_item_type === 'function') {
            check_item_type();
        }
    }
}

    reinitializeItemTypeHandler() {
        // Reinitialize the item type change handler
        if (typeof check_item_type === 'function') {
            const itemTypeSelect = document.getElementById('choice_item_type');
            if (itemTypeSelect) {
                itemTypeSelect.onchange = function() {
                    check_item_type();
                };
                // Trigger initial setup
                setTimeout(() => {
                    itemTypeSelect.dispatchEvent(new Event('change'));
                }, 100);
            }
        }
    }

    getDeleteMessage(tableName) {
        const messages = {
            fund_items: "{% if session.get('lang', 'en') == 'ar' %}هل أنت متأكد من أنك تريد حذف هذا البند؟{% else %}Are you sure you want to delete this item?{% endif %}"
        };
        return messages[tableName] || "Are you sure you want to delete this item?";
    }

    showError(message) {
        alert(message);
    }

    setupGlobalListeners() {
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
        });
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    window.fundTableManager = new RequestedFundTableManager();
});
</script>

<style>
/* UNIFIED TABLE STYLES - Only affects tables with these classes */
.ajax-table-container {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    margin-bottom: 1.5rem;
    transition: all 0.3s ease; /* Added container hover */
}

.ajax-table-container:hover {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.ajax-table-header {
    background: #f8f9fa;
    border-bottom: 1px solid #e2e8f0;
    padding: 1rem 1.5rem;
    transition: all 0.3s ease; /* Added header transition */
}

.ajax-table-body {
    padding: 0;
}

.ajax-table-footer {
    background: #f8f9fa;
    border-top: 1px solid #e2e8f0;
    padding: 0.75rem 1.5rem;
}

.ajax-table {
    margin-bottom: 0;
}

.ajax-table thead {
    background: #f1f5f9;
}

/* Enhanced row hover effects */
.ajax-table tbody tr {
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
}

.ajax-table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.04) !important;
    border-left: 3px solid #007bff;
    transform: translateX(2px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

/* Delete button hover effects */
.delete-experience-btn,
.delete-partner-btn,
.delete-expense-btn {
    transition: all 0.3s ease !important;
    border: 1px solid transparent;
}

.delete-experience-btn:hover,
.delete-partner-btn:hover,
.delete-expense-btn:hover {
    transform: scale(1.15) !important;
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
    color: white !important;
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
}

/* Badge hover effects */
.ajax-table .badge {
    transition: all 0.3s ease;
}

.ajax-table .badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Header badge hover */
.ajax-table-header .badge {
    transition: all 0.3s ease;
}

.ajax-table-header .badge:hover {
    transform: scale(1.05);
}

/* Empty state styling */
.ajax-table-empty {
    text-align: center;
    padding: 3rem 1rem;
    color: #6c757d;
    transition: all 0.3s ease;
}

/* Table header hover effects */
.ajax-table thead th {
    transition: all 0.3s ease;
    position: relative;
}

.ajax-table thead th:hover {
    background-color: #e9ecef;
    color: #0056b3;
}

.ajax-table thead th:hover::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, #007bff, #0056b3);
}

/* Footer hover effects */
.ajax-table-footer {
    transition: all 0.3s ease;
}

.ajax-table-footer:hover {
    background-color: #e9ecef;
}

/* Number cells hover */
.ajax-table td:has(.text-success):hover {
    background-color: rgba(40, 167, 69, 0.05) !important;
}

/* Smooth transitions for all interactive elements */
.ajax-table-container * {
    transition: all 0.2s ease;
}

/* Badge styles for tables */
.table-badge {
    font-size: 0.7rem;
    font-weight: 500;
    padding: 0.25rem 0.5rem;
    transition: all 0.3s ease;
}

.table-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}
</style>


<style>
 /* Target Arabic language specifically */
html[lang="ar"] .choices[data-type*="select-one"]:after {
    display: none !important;
}

html[lang="ar"] select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
}
</style>


{% endblock javascripts %}